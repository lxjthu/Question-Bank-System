# 闪卡自测系统 — 技术方案

> 基于现有知识图谱，为用户提供间隔重复（SRS）式的自测闪卡功能。

---

## 一、功能概述

```
知识图谱筛选知识点
       ↓
  一键生成闪卡集
       ↓
  单选/判断题作答
  ┌────────────────┐
  │ 答对 → 下一题   │
  │ 答错 → 记录     │
  │       + 稍后复现│
  └────────────────┘
       ↓
  全部答对 → 完成
```

---

## 二、题目来源策略

两种模式，优先级递降：

| 优先级 | 来源 | 条件 |
|--------|------|------|
| 1 | 现有题库中 `单选`/`是非` 题，按 `knowledge_point` 字段匹配 | 题库有对应知识点题目 |
| 2 | 调用 DeepSeek 实时生成 | 题库无匹配时兜底 |

> 生成的题目**不写入题库**，仅存于本次 session，避免污染题库。

---

## 三、SRS 算法（间隔重复）

### 3.1 Session 内复现策略

```
答错次数    下次复现（隔几张卡之后）
  1          5 张后
  2         10 张后
  3+        随机插入队列末尾
```

实现：维护两个队列 `deck`（待答）和 `retry_queue`（待复现），`retry_queue` 中的卡带复现延迟计数。

### 3.2 跨会话 SM-2 算法

```python
# 初始参数
easiness    = 2.5   # 难度因子
interval    = 1     # 下次复现间隔（天）
repetitions = 0     # 连续答对次数

# 答对时（quality >= 3）
if repetitions == 0:   interval = 1
elif repetitions == 1: interval = 6
else:                  interval = round(interval * easiness)
repetitions += 1
easiness = max(1.3, easiness + 0.1 - (4 - quality) * (0.08 + (4 - quality) * 0.02))

# 答错时（quality < 3）
repetitions = 0
interval    = 1    # 明天再来
```

---

## 四、数据模型

新增 2 张表，写入现有 `exam_system.db`：

```sql
-- 闪卡集（每次"生成"创建一个 deck）
CREATE TABLE flashcard_deck (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    name        TEXT,           -- 如 "第三章·农业合作经济"
    source_kps  TEXT,           -- JSON: 所选知识点列表
    created_at  DATETIME,
    total_cards INTEGER
);

-- 每张卡的学习进度（跨会话持久化）
CREATE TABLE flashcard_progress (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    deck_id         INTEGER REFERENCES flashcard_deck(id),
    question_id     INTEGER,    -- 来自题库则引用 questions.id，否则为 NULL
    question_json   TEXT,       -- AI 生成题目的完整内容（JSON）
    knowledge_point TEXT,
    -- SM-2 参数
    easiness        REAL    DEFAULT 2.5,
    interval_days   INTEGER DEFAULT 1,
    repetitions     INTEGER DEFAULT 0,
    next_review     DATE,       -- 下次应复现日期
    last_reviewed   DATETIME,
    -- 统计
    correct_count   INTEGER DEFAULT 0,
    wrong_count     INTEGER DEFAULT 0
);
```

---

## 五、后端 API

新建 `app/flashcard_routes.py`，Blueprint `flashcard_bp`，前缀 `/api/flashcards`：

| Method   | 路径 | 说明 |
|----------|------|------|
| `POST`   | `/decks` | 创建闪卡集（传入知识点列表 + 题量）|
| `GET`    | `/decks` | 列出历史闪卡集（含完成度）|
| `DELETE` | `/decks/<id>` | 删除闪卡集及进度 |
| `POST`   | `/decks/<id>/session` | 开始一次学习 session，返回今日待复现卡列表 |
| `POST`   | `/decks/<id>/answer` | 提交答案，返回是否正确 + 更新 SM-2 参数 |
| `GET`    | `/decks/<id>/stats` | 闪卡集学习统计（掌握率、连续学习天数等）|

### POST `/decks` 请求体

```json
{
  "name": "第三章·农业合作经济",
  "knowledge_points": ["合作社", "规模经济", "科斯定理"],
  "max_cards": 20,
  "generate_if_missing": true
}
```

### POST `/decks/<id>/session` 返回体

```json
{
  "session_id": "uuid",
  "cards": [
    {
      "progress_id": 12,
      "question": "以下关于农业合作社的说法，正确的是？",
      "type": "单选",
      "options": {"A": "...", "B": "...", "C": "...", "D": "..."},
      "knowledge_point": "合作社",
      "is_review": false
    }
  ],
  "total": 15,
  "new": 8,
  "review": 7
}
```

---

## 六、前端 UI 设计

### 6.1 入口

在「知识图谱」Tab 的知识点筛选面板底部新增按钮：

```
[ 筛选面板 ]
 ✓ 合作社
 ✓ 规模经济
 □ 价格理论
 ✓ 科斯定理
──────────────
[📚 生成闪卡自测]
```

### 6.2 闪卡作答界面（全屏 Modal）

```
┌─────────────────────────────────────────────────────┐
│  合作社  ·  第 3 / 15 题    ████████░░░░░  53%       │
├─────────────────────────────────────────────────────┤
│                                                     │
│   以下关于农业合作社的说法，正确的是？               │
│                                                     │
│   ○  A. 合作社以利润最大化为首要目标                │
│   ○  B. 合作社成员共同承担风险、共享收益            │
│   ○  C. 合作社不需要注册登记                        │
│   ○  D. 合作社仅存在于发达国家                      │
│                                                     │
│              [ 提交答案 ]                            │
└─────────────────────────────────────────────────────┘
```

**答对反馈**（绿色，1.5 秒后自动翻页）：
```
✓ 正确！                      [立即下一题]
```

**答错反馈**（红色，手动确认，避免未读解析就跳走）：
```
✗ 错误  正确答案是 B
─────────────────────────────
解析：合作社的核心原则是民主管理、利益共享、风险共担……
─────────────────────────────
[知道了，继续]
```

### 6.3 完成页

```
┌──────────────────────────────────────────┐
│         本轮完成！                        │
│                                          │
│   答对   12 题   答错  3 题              │
│   正确率  80%                            │
│                                          │
│   错题知识点：                           │
│   · 合作社  (2次)                        │
│   · 规模经济 (1次)                       │
│                                          │
│   明日复习卡：3 张                       │
│                                          │
│  [重练错题]   [返回知识图谱]             │
└──────────────────────────────────────────┘
```

---

## 七、实施步骤

### Phase 1 — 核心闪卡（无 SRS，仅本次会话）

1. 新建 `app/flashcard_routes.py`（`POST /decks` + `POST /decks/<id>/session` + `POST /decks/<id>/answer`）
2. 题库查询逻辑（按 `knowledge_point` 筛选 `单选`/`是非` 题）
3. 前端：全屏 Modal + 卡片 UI + 答题交互 + Session 内错题复现

### Phase 2 — SRS 跨会话

4. 新增 DB 表（`flashcard_deck`、`flashcard_progress`）+ SQLAlchemy ORM 模型
5. SM-2 算法实现，`next_review` 调度逻辑
6. 前端：闪卡集管理列表 + 完成页「明日复习卡」提示

### Phase 3 — AI 补题兜底

7. 当题库匹配不足时，调 DeepSeek 生成单选/判断题（仅限"题干不引用知识图谱"的独立题目）
8. 生成题缓存到 `flashcard_progress.question_json`，不写题库

---

## 八、关键约束 & 风险

| 问题 | 处理方式 |
|------|---------|
| 题库知识点字段覆盖率低 | Phase 3 AI 补题兜底；或提示用户"该知识点暂无题目" |
| AI 生成题质量不稳定 | 只用于闪卡场景，不入题库；可加"报告错题"按钮 |
| 跨会话进度丢失 | 进度持久化到 DB，浏览器刷新不影响 |
| 单次生成题量过多导致 API 费用 | 每次最多生成 20 题，按需生成不预生成 |
| `ds_knowledge.db` 与 `exam_system.db` 是独立文件 | 闪卡表建在 `exam_system.db`；KP 数据从 `ds_knowledge.db` 读取 |

---

*文档创建：2026-02-27*
