<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>试题管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --template-color: #9b59b6;
            --replace-color: #e67e22;
            --light-gray: #ecf0f1;
            --dark-gray: #7f8c8d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        .header h1 {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            position: relative;
            z-index: 2;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Navigation Styles */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            background: var(--light-gray);
            color: var(--primary-color);
        }

        .tab-button.active {
            color: var(--secondary-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }

        /* Main Content Styles */
        .main-content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-container {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            min-width: 280px;
            flex: 1;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #219653 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e67e22 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .btn-template {
            background: linear-gradient(135deg, var(--template-color) 0%, #8e44ad 100%);
            color: white;
        }

        .btn-replace {
            background: linear-gradient(135deg, var(--replace-color) 0%, #d35400 100%);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
            transform: translateX(5px);
            transition: all 0.2s ease;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Question Preview Styles */
        .question-preview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid var(--secondary-color);
            padding: 20px;
            margin: 10px 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            transition: all 0.3s ease;
        }

        .question-preview:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: translateX(10px);
        }

        /* Search Results Styles */
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        /* Selected Questions Area */
        .selected-questions {
            border: 2px dashed var(--secondary-color);
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            min-height: 100px;
            margin: 20px 0;
        }

        /* Template Download Area */
        .template-download {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid var(--template-color);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 20px 0;
        }

        /* Auto Exam Generation Area */
        .auto-exam-generation {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid var(--warning-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        /* Exam Preview Area */
        .exam-preview {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid var(--success-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        /* Final Confirmation Area */
        .final-confirmation {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid var(--danger-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .form-group {
                min-width: 100%;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .main-content {
                padding: 15px;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        /* Additional styles for specific functionality */
        .question-type-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .question-type-header {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .exam-total-score {
            background: var(--accent-color);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }

        /* Batch delete bar */
        .batch-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-radius: var(--border-radius);
        }
        .batch-bar.show { display: flex; }

        /* Exam type config row */
        .exam-type-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .exam-type-row select,
        .exam-type-row input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
        }
        .exam-type-row select { min-width: 160px; }
        .exam-type-row input { width: 80px; }

        /* Type management area */
        .type-management-area {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border: 2px solid #5c6bc0;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="site-title"><i class="fas fa-graduation-cap"></i> 试题管理系统</h1>
            <p id="site-subtitle">高效管理试题，智能生成试卷</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-button active" data-tab="question-bank">
                <i class="fas fa-book"></i> 题库管理
            </button>
            <button class="tab-button" data-tab="exam-generation">
                <i class="fas fa-file-alt"></i> 试卷生成
            </button>
            <button class="tab-button" data-tab="template-download">
                <i class="fas fa-download"></i> 模板下载
            </button>
            <button class="tab-button" data-tab="type-management">
                <i class="fas fa-tags"></i> 题型管理
            </button>
            <button class="tab-button" data-tab="usage-management">
                <i class="fas fa-history"></i> 使用管理
            </button>
            <button class="tab-button" data-tab="system-settings">
                <i class="fas fa-cog"></i> 系统设置
            </button>
        </div>

        <div class="main-content">
            <!-- Question Bank Tab -->
            <div id="question-bank" class="tab-content active">
                <div class="form-container">
                    <h2><i class="fas fa-plus-circle"></i> 添加题目</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="question-type">题型</label>
                            <select id="question-type">
                                <!-- populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="question-language">语言</label>
                            <select id="question-language">
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="both">中英对照</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="question-content">题目内容</label>
                        <textarea id="question-content" rows="3"></textarea>
                    </div>

                    <div class="form-row" id="options-container" style="display: none;">
                        <div class="form-group">
                            <label for="option-a">选项A</label>
                            <input type="text" id="option-a">
                        </div>
                        <div class="form-group">
                            <label for="option-b">选项B</label>
                            <input type="text" id="option-b">
                        </div>
                        <div class="form-group">
                            <label for="option-c">选项C</label>
                            <input type="text" id="option-c">
                        </div>
                        <div class="form-group">
                            <label for="option-d">选项D</label>
                            <input type="text" id="option-d">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="question-answer">答案</label>
                            <input type="text" id="question-answer">
                        </div>
                        <div class="form-group">
                            <label for="question-reference">参考答案</label>
                            <textarea id="question-reference" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="question-explanation">解析</label>
                        <textarea id="question-explanation" rows="2"></textarea>
                    </div>

                    <details id="bilingual-details" style="margin-bottom: 20px;">
                        <summary style="cursor:pointer; font-weight:500; color:var(--primary-color); padding:8px 0;">
                            <i class="fas fa-globe"></i> 双语与元数据（可选）
                        </summary>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); margin-top: 10px;">
                            <div class="form-group">
                                <label for="question-content-en">英文题目</label>
                                <textarea id="question-content-en" rows="2" placeholder="English question content"></textarea>
                            </div>
                            <div class="form-row" id="options-en-container" style="display: none;">
                                <div class="form-group">
                                    <label for="option-a-en">英文选项A</label>
                                    <input type="text" id="option-a-en" placeholder="Option A">
                                </div>
                                <div class="form-group">
                                    <label for="option-b-en">英文选项B</label>
                                    <input type="text" id="option-b-en" placeholder="Option B">
                                </div>
                                <div class="form-group">
                                    <label for="option-c-en">英文选项C</label>
                                    <input type="text" id="option-c-en" placeholder="Option C">
                                </div>
                                <div class="form-group">
                                    <label for="option-d-en">英文选项D</label>
                                    <input type="text" id="option-d-en" placeholder="Option D">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="question-knowledge-point">知识点</label>
                                    <input type="text" id="question-knowledge-point" placeholder="如: 经济学基础">
                                </div>
                                <div class="form-group">
                                    <label for="question-tags">标签</label>
                                    <input type="text" id="question-tags" placeholder="逗号分隔，如: 基础,概念">
                                </div>
                                <div class="form-group">
                                    <label for="question-difficulty">难度</label>
                                    <select id="question-difficulty">
                                        <option value="">未设置</option>
                                        <option value="easy">简单 (Easy)</option>
                                        <option value="medium">中等 (Medium)</option>
                                        <option value="hard">困难 (Hard)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>

                    <button id="add-question-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存题目
                    </button>
                </div>

                <div class="card">
                    <h3><i class="fas fa-search"></i> 搜索题目</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="search-keyword" placeholder="输入关键词搜索...">
                        </div>
                        <div class="form-group">
                            <select id="search-type">
                                <option value="">所有题型</option>
                                <!-- populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="search-language">
                                <option value="">所有语言</option>
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="both">中英对照</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button id="search-btn" class="btn btn-outline">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                </div>

                <div class="batch-bar" id="batch-bar">
                    <span style="color: var(--dark-gray); font-weight:500;">已选择 <span id="batch-count2">0</span> 题</span>
                    <select id="batch-type-select" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;">
                    </select>
                    <button id="batch-type-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-exchange-alt"></i> 批量修改题型
                    </button>
                    <button id="batch-delete-btn" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> 批量删除 (<span id="batch-count">0</span>)
                    </button>
                </div>

                <div class="table-container">
                    <table id="questions-table">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="select-all-cb"></th>
                                <th>ID</th>
                                <th>题型</th>
                                <th>内容</th>
                                <th>难度</th>
                                <th>语言</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="questions-tbody">
                            <!-- Questions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Exam Generation Tab -->
            <div id="exam-generation" class="tab-content">
                <div class="auto-exam-generation">
                    <h3><i class="fas fa-bolt"></i> 一键自动组卷</h3>
                    <p>根据以下配置自动生成试卷：</p>

                    <div id="exam-type-configs">
                        <!-- dynamic rows rendered by JS -->
                    </div>

                    <button id="add-exam-type-btn" class="btn btn-outline btn-sm" style="margin-bottom:15px;">
                        <i class="fas fa-plus"></i> 添加题型
                    </button>

                    <div id="exam-total-score" class="exam-total-score">
                        试卷总分: <span id="total-score">0</span> 分
                    </div>

                    <div style="margin-top: 15px;">
                        <button id="generate-exam-btn" class="btn btn-warning">
                            <i class="fas fa-magic"></i> 一键生成试卷
                        </button>
                    </div>
                </div>

                <div class="exam-preview" id="exam-preview-section" style="display: none;">
                    <h3><i class="fas fa-eye"></i> 试卷预览</h3>

                    <div style="margin-bottom: 15px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <span style="font-weight: 500; color: var(--primary-color);">显示语言：</span>
                        <button class="btn btn-sm btn-primary" id="mode-zh-btn" onclick="setExamDisplayMode('zh')">中文</button>
                        <button class="btn btn-sm btn-outline" id="mode-en-btn" onclick="setExamDisplayMode('en')">英文</button>
                        <button class="btn btn-sm btn-outline" id="mode-both-btn" onclick="setExamDisplayMode('both')">中英对照</button>
                    </div>

                    <div id="exam-questions-container">
                        <!-- Exam questions will be displayed here -->
                    </div>

                    <div class="final-confirmation" id="final-confirmation-section" style="display: none;">
                        <h3><i class="fas fa-check-circle"></i> 试卷最终决定</h3>
                        <p>确认后，试卷中的题目将被标记为已使用，避免在其他试卷中重复出现。</p>
                        <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                            <button id="confirm-exam-btn" class="btn btn-success">
                                <i class="fas fa-check"></i> 确认试卷
                            </button>
                            <button id="revert-exam-btn" class="btn btn-warning" style="display: none;">
                                <i class="fas fa-undo"></i> 撤销确认
                            </button>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                            <label for="export-mode-select" style="font-weight:500;">语言：</label>
                            <select id="export-mode-select" style="padding:8px 12px; border:1px solid #ddd; border-radius:var(--border-radius);">
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="both">中英对照</option>
                            </select>
                            <label for="export-answer-select" style="font-weight:500;">内容：</label>
                            <select id="export-answer-select" style="padding:8px 12px; border:1px solid #ddd; border-radius:var(--border-radius);">
                                <option value="0">只导出题目</option>
                                <option value="1">题目 + 答案</option>
                            </select>
                            <button class="btn btn-template btn-sm" onclick="exportCurrentExam()">
                                <i class="fas fa-file-word"></i> 导出Word
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Download Tab -->
            <div id="template-download" class="tab-content">
                <div class="template-download">
                    <h3><i class="fas fa-file-word"></i> 试题库导入模板下载</h3>
                    <p>下载标准格式的Word试题模板，支持批量录入题库</p>
                    <p>模板采用标准格式，确保批量录入后可无障碍一键导入</p>

                    <button id="download-template-btn" class="btn btn-template">
                        <i class="fas fa-download"></i> 下载Word模板
                    </button>

                    <div style="margin-top: 20px;">
                        <h4>模板使用说明：</h4>
                        <ul style="text-align: left; margin-top: 10px;">
                            <li>每道题以 [题型] 开头，题型标识符用方括号包围</li>
                            <li>题型后可跟答案标识符（如 [A]、[ABD] 等）</li>
                            <li>选择题答案紧跟在题型标识后，用方括号包围</li>
                            <li>选择题选项格式：[选项字母] + 选项内容</li>
                            <li>解析可选，用 &lt;解析&gt;...&lt;解析&gt; 包围</li>
                            <li>参考答案用 &lt;参考答案&gt;...&lt;参考答案&gt; 包围</li>
                            <li>中文内容用 （中文） 标注，英文内容用 （英文） 标注</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-file-upload"></i> 导入题库</h3>
                    <div class="form-group">
                        <label for="import-file">选择文件</label>
                        <input type="file" id="import-file" accept=".docx,.txt,.csv">
                    </div>
                    <button id="import-btn" class="btn btn-primary">
                        <i class="fas fa-upload"></i> 导入题库
                    </button>
                </div>

                <div class="card">
                    <h3><i class="fas fa-file-export"></i> 导出题库</h3>
                    <button id="export-json-btn" class="btn btn-outline">
                        <i class="fas fa-file-code"></i> 导出为JSON
                    </button>
                    <button id="export-csv-btn" class="btn btn-outline">
                        <i class="fas fa-file-csv"></i> 导出为CSV
                    </button>
                </div>
            </div>

            <!-- Type Management Tab -->
            <div id="type-management" class="tab-content">
                <div class="type-management-area">
                    <h3><i class="fas fa-tags"></i> 题型管理</h3>
                    <p>管理系统中的题型，内置题型不可删除。</p>

                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group" style="min-width:160px;">
                            <label for="new-type-name">题型标识</label>
                            <input type="text" id="new-type-name" placeholder="如: 简答>案例">
                        </div>
                        <div class="form-group" style="min-width:160px;">
                            <label for="new-type-label">显示名称</label>
                            <input type="text" id="new-type-label" placeholder="如: 案例分析题">
                        </div>
                        <div class="form-group" style="min-width:120px;">
                            <label for="new-type-options">有选项</label>
                            <select id="new-type-options">
                                <option value="false">否</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                        <div class="form-group" style="min-width:100px; display:flex; align-items:flex-end;">
                            <button id="add-type-btn" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container" style="margin-top: 20px;">
                    <table id="types-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标识</th>
                                <th>显示名称</th>
                                <th>有选项</th>
                                <th>类型</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="types-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Usage Management Tab -->
            <div id="usage-management" class="tab-content">
                <h3><i class="fas fa-history"></i> 题目使用管理</h3>
                <p>查看和管理已使用题目，按使用日期筛选后可一键释放，释放后题目可重新参与组卷。</p>

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin:20px 0;">
                    <div class="form-group" style="margin-bottom:0; min-width:160px;">
                        <label for="usage-date-from">使用日期从</label>
                        <input type="date" id="usage-date-from" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius);">
                    </div>
                    <div class="form-group" style="margin-bottom:0; min-width:160px;">
                        <label for="usage-date-to">使用日期到</label>
                        <input type="date" id="usage-date-to" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius);">
                    </div>
                    <div class="form-group" style="margin-bottom:0; min-width:140px;">
                        <label for="usage-type-filter">题型</label>
                        <select id="usage-type-filter" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius);">
                            <option value="">全部题型</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="loadUsedQuestions()">
                        <i class="fas fa-search"></i> 查询
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="clearUsageFilters()">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>

                <div id="usage-summary" style="margin-bottom:15px; padding:12px 18px; background:#f8f9fa; border-radius:var(--border-radius); display:none;">
                </div>

                <div class="batch-bar" id="usage-batch-bar" style="display:none; margin-bottom:10px; padding:10px 15px; background:#fff3e0; border-radius:var(--border-radius); display:none; align-items:center; gap:10px;">
                    <span style="font-weight:500;">已选择 <span id="usage-batch-count">0</span> 题</span>
                    <button class="btn btn-warning btn-sm" id="usage-release-btn">
                        <i class="fas fa-unlock"></i> 释放选中题目
                    </button>
                    <button class="btn btn-warning btn-sm" id="usage-release-all-btn">
                        <i class="fas fa-unlock-alt"></i> 释放全部筛选结果
                    </button>
                </div>

                <div class="table-container">
                    <table id="usage-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="usage-select-all"></th>
                                <th>ID</th>
                                <th>题型</th>
                                <th>内容</th>
                                <th>难度</th>
                                <th>使用日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="usage-tbody">
                        </tbody>
                    </table>
                </div>
                <div id="usage-empty" style="display:none; padding:30px; text-align:center; color:#999;">
                    <i class="fas fa-check-circle" style="font-size:2em; margin-bottom:10px; display:block;"></i>
                    暂无已使用的题目
                </div>
            </div>

            <!-- System Settings Tab -->
            <div id="system-settings" class="tab-content">
                <div class="form-container">
                    <h3><i class="fas fa-cog"></i> 课程与系统设置</h3>
                    <p style="margin-bottom:20px; color:var(--dark-gray);">配置课程信息后，页面标题和导出试卷将自动使用这些信息。</p>

                    <h4 style="margin:16px 0 10px; color:#555; border-bottom:1px solid #eee; padding-bottom:6px;">试卷头部信息</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-institution-name">学校/机构名称</label>
                            <input type="text" id="settings-institution-name" placeholder="如: 中南财经政法大学">
                        </div>
                        <div class="form-group">
                            <label for="settings-semester-info">学期信息</label>
                            <input type="text" id="settings-semester-info" placeholder="如: 2023–2024学年第1学期">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-exam-title">考试标题</label>
                            <input type="text" id="settings-exam-title" placeholder="如: 期末考试试卷">
                        </div>
                        <div class="form-group">
                            <label for="settings-paper-label">试卷标签</label>
                            <input type="text" id="settings-paper-label" placeholder="如: A" maxlength="4" style="max-width:80px;">
                        </div>
                    </div>

                    <h4 style="margin:16px 0 10px; color:#555; border-bottom:1px solid #eee; padding-bottom:6px;">课程信息</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-course-name">课程名称</label>
                            <input type="text" id="settings-course-name" placeholder="如: 林业经济学（双语）">
                        </div>
                        <div class="form-group">
                            <label for="settings-course-code">课程代号</label>
                            <input type="text" id="settings-course-code" placeholder="如: FE301">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-exam-format">考试形式</label>
                            <select id="settings-exam-format">
                                <option value="">未设置</option>
                                <option value="开卷">开卷</option>
                                <option value="闭卷">闭卷</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="settings-exam-method">考试方式</label>
                            <select id="settings-exam-method">
                                <option value="">未设置</option>
                                <option value="笔试">笔试</option>
                                <option value="口试">口试</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="settings-target-audience">使用对象</label>
                        <input type="text" id="settings-target-audience" placeholder="如: 林学专业本科生">
                    </div>

                    <button id="save-settings-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Global question types cache ==========
        let questionTypesCache = [];

        async function loadQuestionTypes() {
            try {
                const response = await fetch('/api/question-types');
                if (response.ok) {
                    questionTypesCache = await response.json();
                    populateTypeDropdowns();
                }
            } catch (error) {
                console.error('Error loading question types:', error);
            }
        }

        function isChoiceType(typeName) {
            const qt = questionTypesCache.find(t => t.name === typeName);
            return qt ? qt.has_options : false;
        }

        function populateTypeDropdowns() {
            // Add question type dropdown
            const addSelect = document.getElementById('question-type');
            const currentVal = addSelect.value;
            addSelect.innerHTML = '';
            questionTypesCache.forEach(qt => {
                const opt = document.createElement('option');
                opt.value = qt.name;
                opt.textContent = qt.label;
                addSelect.appendChild(opt);
            });
            if (currentVal) addSelect.value = currentVal;

            // Toggle options on change
            toggleOptionsContainer();

            // Search type dropdown
            const searchSelect = document.getElementById('search-type');
            const searchVal = searchSelect.value;
            searchSelect.innerHTML = '<option value="">所有题型</option>';
            questionTypesCache.forEach(qt => {
                const opt = document.createElement('option');
                opt.value = qt.name;
                opt.textContent = qt.label;
                searchSelect.appendChild(opt);
            });
            if (searchVal) searchSelect.value = searchVal;

            // Batch type change dropdown
            const batchSelect = document.getElementById('batch-type-select');
            batchSelect.innerHTML = '';
            questionTypesCache.forEach(qt => {
                const opt = document.createElement('option');
                opt.value = qt.name;
                opt.textContent = qt.label;
                batchSelect.appendChild(opt);
            });
        }

        function toggleOptionsContainer() {
            const typeSelect = document.getElementById('question-type');
            const isChoice = isChoiceType(typeSelect.value);
            document.getElementById('options-container').style.display = isChoice ? 'flex' : 'none';
            const enContainer = document.getElementById('options-en-container');
            if (enContainer) enContainer.style.display = isChoice ? 'flex' : 'none';
        }

        // Tab switching functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');

                if (tabId === 'type-management') renderQuestionTypesTable();
                if (tabId === 'usage-management') loadUsedQuestions();
            });
        });

        // Toggle options container based on question type
        document.getElementById('question-type').addEventListener('change', toggleOptionsContainer);

        // Add/Update question functionality
        document.getElementById('add-question-btn').addEventListener('click', async () => {
            const questionType = document.getElementById('question-type').value;
            const language = document.getElementById('question-language').value;
            const content = document.getElementById('question-content').value;

            let options = [];
            if (isChoiceType(questionType)) {
                const optionA = document.getElementById('option-a').value;
                const optionB = document.getElementById('option-b').value;
                const optionC = document.getElementById('option-c').value;
                const optionD = document.getElementById('option-d').value;

                if (optionA) options.push(optionA);
                if (optionB) options.push(optionB);
                if (optionC) options.push(optionC);
                if (optionD) options.push(optionD);
            }

            const answer = document.getElementById('question-answer').value;
            const reference = document.getElementById('question-reference').value;
            const explanation = document.getElementById('question-explanation').value;

            // Collect bilingual/metadata fields
            const contentEn = document.getElementById('question-content-en').value;
            let optionsEn = [];
            if (isChoiceType(questionType)) {
                const oa = document.getElementById('option-a-en').value;
                const ob = document.getElementById('option-b-en').value;
                const oc = document.getElementById('option-c-en').value;
                const od = document.getElementById('option-d-en').value;
                if (oa) optionsEn.push(oa);
                if (ob) optionsEn.push(ob);
                if (oc) optionsEn.push(oc);
                if (od) optionsEn.push(od);
            }
            const knowledgePoint = document.getElementById('question-knowledge-point').value;
            const tags = document.getElementById('question-tags').value;
            const difficulty = document.getElementById('question-difficulty').value;

            const questionData = {
                question_type: questionType,
                content: content,
                options: options,
                answer: answer,
                reference_answer: reference,
                explanation: explanation,
                language: language,
                content_en: contentEn || null,
                options_en: optionsEn.length > 0 ? optionsEn : null,
                knowledge_point: knowledgePoint || null,
                tags: tags || null,
                difficulty: difficulty || null,
            };

            try {
                let response;
                if (editingQuestionId) {
                    response = await fetch(`/api/questions/${editingQuestionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                } else {
                    response = await fetch('/api/questions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                }

                if (response.ok) {
                    alert(editingQuestionId ? '题目更新成功！' : '题目添加成功！');
                    cancelEdit();
                    loadQuestions();
                } else {
                    alert(editingQuestionId ? '更新题目失败！' : '添加题目失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert(editingQuestionId ? '更新题目时发生错误！' : '添加题目时发生错误！');
            }
        });

        // Search functionality
        document.getElementById('search-btn').addEventListener('click', loadQuestions);

        // ========== Batch selection state ==========
        let selectedQuestionIds = new Set();

        function updateBatchBar() {
            const count = selectedQuestionIds.size;
            document.getElementById('batch-count').textContent = count;
            document.getElementById('batch-count2').textContent = count;
            const bar = document.getElementById('batch-bar');
            bar.classList.toggle('show', count > 0);
        }

        document.getElementById('select-all-cb').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.question-cb');
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
                if (this.checked) {
                    selectedQuestionIds.add(cb.dataset.id);
                } else {
                    selectedQuestionIds.delete(cb.dataset.id);
                }
            });
            updateBatchBar();
        });

        document.getElementById('batch-delete-btn').addEventListener('click', async () => {
            if (selectedQuestionIds.size === 0) return;
            if (!confirm(`确定要删除选中的 ${selectedQuestionIds.size} 道题目吗？`)) return;
            try {
                const response = await fetch('/api/questions/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: Array.from(selectedQuestionIds) })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`成功删除 ${result.deleted_count} 道题目！`);
                    selectedQuestionIds.clear();
                    document.getElementById('select-all-cb').checked = false;
                    updateBatchBar();
                    loadQuestions();
                } else {
                    alert('批量删除失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('批量删除时发生错误！');
            }
        });

        document.getElementById('batch-type-btn').addEventListener('click', async () => {
            if (selectedQuestionIds.size === 0) return;
            const newType = document.getElementById('batch-type-select').value;
            const qt = questionTypesCache.find(t => t.name === newType);
            const label = qt ? qt.label : newType;
            if (!confirm(`确定要将选中的 ${selectedQuestionIds.size} 道题目的题型修改为「${label}」吗？`)) return;
            try {
                const response = await fetch('/api/questions/batch-update-type', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: Array.from(selectedQuestionIds), question_type: newType })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`成功修改 ${result.updated_count} 道题目的题型为「${label}」！`);
                    selectedQuestionIds.clear();
                    document.getElementById('select-all-cb').checked = false;
                    updateBatchBar();
                    loadQuestions();
                } else {
                    const err = await response.json().catch(() => null);
                    alert(err?.error || '批量修改题型失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('批量修改题型时发生错误！');
            }
        });

        // Load questions function
        async function loadQuestions() {
            const keyword = document.getElementById('search-keyword').value;
            const type = document.getElementById('search-type').value;
            const language = document.getElementById('search-language').value;

            let url = '/api/questions';
            const params = [];
            if (keyword) params.push(`keyword=${encodeURIComponent(keyword)}`);
            if (type) params.push(`type=${encodeURIComponent(type)}`);
            if (language) params.push(`language=${encodeURIComponent(language)}`);

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            try {
                const response = await fetch(url);
                const questions = await response.json();

                const tbody = document.getElementById('questions-tbody');
                tbody.innerHTML = '';
                selectedQuestionIds.clear();
                document.getElementById('select-all-cb').checked = false;
                updateBatchBar();

                questions.forEach(question => {
                    const row = document.createElement('tr');
                    const status = question.is_used ? '已使用' : '未使用';
                    const statusClass = question.is_used ? 'status-used' : 'status-unused';

                    const bilingualIcon = question.content_en ? ' <i class="fas fa-globe" title="双语" style="color:var(--secondary-color);"></i>' : '';
                    const difficultyMap = { easy: '简单', medium: '中等', hard: '困难' };
                    const difficultyText = question.difficulty ? (difficultyMap[question.difficulty] || question.difficulty) : '-';
                    const metaTitle = [
                        question.knowledge_point ? '知识点: ' + question.knowledge_point : '',
                        question.tags ? '标签: ' + question.tags : ''
                    ].filter(Boolean).join('\n');

                    row.innerHTML = `
                        <td><input type="checkbox" class="question-cb" data-id="${question.question_id}"></td>
                        <td>${question.question_id.substring(0, 8)}...</td>
                        <td>${question.question_type}</td>
                        <td title="${escapeHtml(metaTitle)}">${question.content.substring(0, 50)}${question.content.length > 50 ? '...' : ''}${bilingualIcon}</td>
                        <td>${difficultyText}</td>
                        <td>${question.language}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="editQuestion('${question.question_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${question.question_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;

                    // Bind checkbox
                    const cb = row.querySelector('.question-cb');
                    cb.addEventListener('change', function() {
                        if (this.checked) {
                            selectedQuestionIds.add(this.dataset.id);
                        } else {
                            selectedQuestionIds.delete(this.dataset.id);
                        }
                        updateBatchBar();
                    });

                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        // Currently editing question ID (null means adding new)
        let editingQuestionId = null;

        // Edit question function
        async function editQuestion(questionId) {
            try {
                const response = await fetch(`/api/questions/${questionId}`);
                if (!response.ok) {
                    alert('获取题目信息失败！');
                    return;
                }
                const question = await response.json();

                // Switch to question bank tab
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector('[data-tab="question-bank"]').classList.add('active');
                document.getElementById('question-bank').classList.add('active');

                // Fill form with question data
                document.getElementById('question-type').value = question.question_type;
                document.getElementById('question-language').value = question.language || 'zh';
                document.getElementById('question-content').value = question.content || '';
                document.getElementById('question-answer').value = question.answer || '';
                document.getElementById('question-reference').value = question.reference_answer || '';
                document.getElementById('question-explanation').value = question.explanation || '';

                // Show/hide options and fill them
                const optionsContainer = document.getElementById('options-container');
                if (isChoiceType(question.question_type)) {
                    optionsContainer.style.display = 'flex';
                    const options = question.options || [];
                    document.getElementById('option-a').value = options[0] || '';
                    document.getElementById('option-b').value = options[1] || '';
                    document.getElementById('option-c').value = options[2] || '';
                    document.getElementById('option-d').value = options[3] || '';
                } else {
                    optionsContainer.style.display = 'none';
                    document.getElementById('option-a').value = '';
                    document.getElementById('option-b').value = '';
                    document.getElementById('option-c').value = '';
                    document.getElementById('option-d').value = '';
                }

                // Fill bilingual/metadata fields
                document.getElementById('question-content-en').value = question.content_en || '';
                const optionsEn = question.options_en || [];
                document.getElementById('option-a-en').value = optionsEn[0] || '';
                document.getElementById('option-b-en').value = optionsEn[1] || '';
                document.getElementById('option-c-en').value = optionsEn[2] || '';
                document.getElementById('option-d-en').value = optionsEn[3] || '';
                document.getElementById('question-knowledge-point').value = question.knowledge_point || '';
                document.getElementById('question-tags').value = question.tags || '';
                document.getElementById('question-difficulty').value = question.difficulty || '';
                // Open the details if bilingual data exists
                if (question.content_en || question.knowledge_point || question.tags || question.difficulty) {
                    document.getElementById('bilingual-details').open = true;
                }

                editingQuestionId = questionId;
                const btn = document.getElementById('add-question-btn');
                btn.innerHTML = '<i class="fas fa-save"></i> 更新题目';
                btn.className = 'btn btn-success';

                let cancelBtn = document.getElementById('cancel-edit-btn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-edit-btn';
                    cancelBtn.className = 'btn btn-outline';
                    cancelBtn.style.marginLeft = '10px';
                    cancelBtn.innerHTML = '<i class="fas fa-times"></i> 取消编辑';
                    cancelBtn.addEventListener('click', cancelEdit);
                    btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
                }
                cancelBtn.style.display = 'inline-flex';

                document.querySelector('.form-container h2').innerHTML = '<i class="fas fa-edit"></i> 编辑题目';
                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error:', error);
                alert('获取题目信息时发生错误！');
            }
        }

        function cancelEdit() {
            editingQuestionId = null;
            const btn = document.getElementById('add-question-btn');
            btn.innerHTML = '<i class="fas fa-save"></i> 保存题目';
            btn.className = 'btn btn-primary';

            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) cancelBtn.style.display = 'none';

            document.querySelector('.form-container h2').innerHTML = '<i class="fas fa-plus-circle"></i> 添加题目';

            document.getElementById('question-type').value = questionTypesCache.length ? questionTypesCache[0].name : '';
            document.getElementById('question-language').value = 'zh';
            document.getElementById('question-content').value = '';
            document.getElementById('option-a').value = '';
            document.getElementById('option-b').value = '';
            document.getElementById('option-c').value = '';
            document.getElementById('option-d').value = '';
            document.getElementById('question-answer').value = '';
            document.getElementById('question-reference').value = '';
            document.getElementById('question-explanation').value = '';
            document.getElementById('question-content-en').value = '';
            document.getElementById('option-a-en').value = '';
            document.getElementById('option-b-en').value = '';
            document.getElementById('option-c-en').value = '';
            document.getElementById('option-d-en').value = '';
            document.getElementById('question-knowledge-point').value = '';
            document.getElementById('question-tags').value = '';
            document.getElementById('question-difficulty').value = '';
            document.getElementById('bilingual-details').open = false;
            toggleOptionsContainer();
        }

        // Delete question function
        async function deleteQuestion(questionId) {
            if (confirm('确定要删除这个题目吗？')) {
                try {
                    const response = await fetch(`/api/questions/${questionId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('题目删除成功！');
                        loadQuestions();
                    } else {
                        alert('删除题目失败！');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('删除题目时发生错误！');
                }
            }
        }

        // Template download functionality
        document.getElementById('download-template-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/templates/download');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'question_template.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('下载模板失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('下载模板时发生错误！');
            }
        });

        // Import functionality
        document.getElementById('import-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('请选择一个文件！');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/questions/import', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('题库导入成功！');
                    fileInput.value = '';
                    loadQuestions();
                } else {
                    const errorData = await response.json();
                    alert(`导入失败: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导入题库时发生错误！');
            }
        });

        // Export functionality
        document.getElementById('export-json-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/questions/export?format=json');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `question_bank_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('导出失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导出题库时发生错误！');
            }
        });

        document.getElementById('export-csv-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/questions/export?format=csv');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `question_bank_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('导出失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导出题库时发生错误！');
            }
        });

        // ========== Dynamic exam type config ==========
        let examTypeRowId = 0;

        const defaultExamRows = [
            { name: '单选', count: 5, points: 2 },
            { name: '是非', count: 10, points: 1 },
            { name: '简答>论述', count: 3, points: 10 },
            { name: '简答>计算', count: 2, points: 10 },
            { name: '简答>材料分析', count: 1, points: 30 },
        ];

        function renderDefaultExamConfig() {
            const container = document.getElementById('exam-type-configs');
            container.innerHTML = '';
            examTypeRowId = 0;
            defaultExamRows.forEach(row => addExamTypeRow(row.name, row.count, row.points));
        }

        function addExamTypeRow(typeName, count, points) {
            const container = document.getElementById('exam-type-configs');
            const rowId = examTypeRowId++;
            const div = document.createElement('div');
            div.className = 'exam-type-row';
            div.id = `exam-type-row-${rowId}`;

            let selectHtml = `<select class="exam-type-select" data-row="${rowId}">`;
            questionTypesCache.forEach(qt => {
                const selected = qt.name === typeName ? ' selected' : '';
                selectHtml += `<option value="${qt.name}"${selected}>${qt.label}</option>`;
            });
            selectHtml += `</select>`;

            div.innerHTML = `
                ${selectHtml}
                <input type="number" class="exam-type-count" data-row="${rowId}" value="${count || 0}" min="0" placeholder="数量">
                <small>题</small>
                <input type="number" class="exam-type-points" data-row="${rowId}" value="${points || 0}" min="0" placeholder="分数">
                <small>分/题</small>
                <button class="btn btn-danger btn-sm" onclick="removeExamTypeRow(${rowId})" title="删除">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);

            // Bind real-time score update
            div.querySelector('.exam-type-count').addEventListener('input', updateTotalScore);
            div.querySelector('.exam-type-points').addEventListener('input', updateTotalScore);

            updateTotalScore();
        }

        function removeExamTypeRow(rowId) {
            const row = document.getElementById(`exam-type-row-${rowId}`);
            if (row) row.remove();
            updateTotalScore();
        }

        document.getElementById('add-exam-type-btn').addEventListener('click', () => {
            addExamTypeRow('', 0, 0);
        });

        function getExamConfig() {
            const config = {};
            document.querySelectorAll('.exam-type-row').forEach(row => {
                const select = row.querySelector('.exam-type-select');
                const countInput = row.querySelector('.exam-type-count');
                const pointsInput = row.querySelector('.exam-type-points');
                if (select && select.value) {
                    config[select.value] = {
                        count: parseInt(countInput.value) || 0,
                        points: parseInt(pointsInput.value) || 0,
                    };
                }
            });
            return config;
        }

        function updateTotalScore() {
            const config = getExamConfig();
            let total = 0;
            for (const settings of Object.values(config)) {
                total += settings.count * settings.points;
            }
            document.getElementById('total-score').textContent = total;
        }

        // ========== Current exam state ==========
        let currentExam = null;

        // ========== Auto exam generation ==========
        document.getElementById('generate-exam-btn').addEventListener('click', async () => {
            const config = getExamConfig();
            const examData = {
                name: `自动组卷_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}`,
                config: config
            };

            try {
                const response = await fetch('/api/exams/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });

                if (response.ok) {
                    currentExam = await response.json();
                    displayExam(currentExam);
                } else {
                    const err = await response.json().catch(() => null);
                    alert('生成试卷失败！' + (err && err.error ? '\n' + err.error : ''));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('生成试卷时发生错误！');
            }
        });

        // ========== Exam display mode ==========
        let examDisplayMode = 'zh';

        function setExamDisplayMode(mode) {
            examDisplayMode = mode;
            // Update button styles
            ['zh', 'en', 'both'].forEach(m => {
                const btn = document.getElementById(`mode-${m}-btn`);
                if (btn) {
                    btn.className = m === mode ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';
                }
            });
            if (currentExam) displayExam(currentExam);
        }

        async function exportCurrentExam() {
            if (!currentExam) { alert('请先生成试卷！'); return; }
            const mode = document.getElementById('export-mode-select').value;
            const showAnswer = document.getElementById('export-answer-select').value;
            const suffix = showAnswer === '1' ? '含答案' : '题目';
            try {
                const response = await fetch(`/api/exams/${currentExam.exam_id}/export?mode=${mode}&show_answer=${showAnswer}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentExam.name}_${mode}_${suffix}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('导出失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导出试卷时发生错误！');
            }
        }

        // ========== Display exam ==========
        function displayExam(exam) {
            currentExam = exam;
            document.getElementById('exam-preview-section').style.display = 'block';

            const questionsByType = {};
            const typeOrder = [];
            exam.questions.forEach(question => {
                if (!questionsByType[question.question_type]) {
                    questionsByType[question.question_type] = [];
                    typeOrder.push(question.question_type);
                }
                questionsByType[question.question_type].push(question);
            });

            const container = document.getElementById('exam-questions-container');
            container.innerHTML = '';

            let globalIndex = 0;
            for (const type of typeOrder) {
                const questions = questionsByType[type];
                const config = exam.config[type] || {};
                const perPoint = config.points || 0;
                const subtotal = questions.length * perPoint;

                const typeSection = document.createElement('div');
                typeSection.className = 'question-type-section';

                const header = document.createElement('div');
                header.className = 'question-type-header';
                header.innerHTML = `${type} （共${questions.length}题，每题${perPoint}分，小计${subtotal}分）`;
                typeSection.appendChild(header);

                questions.forEach((question, index) => {
                    globalIndex++;
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-preview';
                    questionDiv.id = `exam-q-${question.question_id}`;

                    const mode = examDisplayMode;
                    const contentEn = question.content_en || '';
                    const optionsEn = question.options_en || [];

                    let html = `<div class="exam-question-content">`;

                    // Content based on display mode
                    if (mode === 'zh') {
                        html += `<strong>${globalIndex}. ${escapeHtml(question.content)}</strong>`;
                    } else if (mode === 'en') {
                        const displayContent = contentEn || question.content;
                        html += `<strong>${globalIndex}. ${escapeHtml(displayContent)}</strong>`;
                    } else {
                        html += `<strong>${globalIndex}. ${escapeHtml(question.content)}</strong>`;
                        if (contentEn) {
                            html += `<div style="margin-top:4px; color:#555; font-style:italic;">${escapeHtml(contentEn)}</div>`;
                        }
                    }

                    // Options based on display mode
                    if (mode === 'zh' && question.options && question.options.length > 0) {
                        html += '<div style="margin: 8px 0 0 20px;">';
                        question.options.forEach((option, optIndex) => {
                            html += `<div>${String.fromCharCode(65 + optIndex)}. ${escapeHtml(option)}</div>`;
                        });
                        html += '</div>';
                    } else if (mode === 'en') {
                        const displayOpts = optionsEn.length > 0 ? optionsEn : (question.options || []);
                        if (displayOpts.length > 0) {
                            html += '<div style="margin: 8px 0 0 20px;">';
                            displayOpts.forEach((option, optIndex) => {
                                html += `<div>${String.fromCharCode(65 + optIndex)}. ${escapeHtml(option)}</div>`;
                            });
                            html += '</div>';
                        }
                    } else if (mode === 'both' && question.options && question.options.length > 0) {
                        html += '<div style="margin: 8px 0 0 20px;">';
                        const maxLen = Math.max(question.options.length, optionsEn.length);
                        for (let oi = 0; oi < maxLen; oi++) {
                            const zhOpt = question.options[oi] || '';
                            const enOpt = optionsEn[oi] || '';
                            if (enOpt) {
                                html += `<div>${String.fromCharCode(65 + oi)}. ${escapeHtml(zhOpt)} / ${escapeHtml(enOpt)}</div>`;
                            } else {
                                html += `<div>${String.fromCharCode(65 + oi)}. ${escapeHtml(zhOpt)}</div>`;
                            }
                        }
                        html += '</div>';
                    }

                    if (question.answer) {
                        html += `<div style="margin-top:6px;"><strong>答案:</strong> ${escapeHtml(question.answer)}</div>`;
                    }
                    if (question.reference_answer) {
                        html += `<div><strong>参考答案:</strong> ${escapeHtml(question.reference_answer)}</div>`;
                    }
                    if (question.explanation) {
                        html += `<div><strong>解析:</strong> ${escapeHtml(question.explanation)}</div>`;
                    }

                    // Metadata tags
                    const metaTags = [];
                    if (question.knowledge_point) metaTags.push(`<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:0.85em;margin-right:4px;">知识点: ${escapeHtml(question.knowledge_point)}</span>`);
                    if (question.difficulty) {
                        const dMap = {easy:'简单',medium:'中等',hard:'困难'};
                        const dColor = {easy:'#e8f5e9',medium:'#fff8e1',hard:'#ffebee'};
                        metaTags.push(`<span style="background:${dColor[question.difficulty]||'#f5f5f5'};padding:2px 8px;border-radius:4px;font-size:0.85em;margin-right:4px;">${dMap[question.difficulty]||question.difficulty}</span>`);
                    }
                    if (question.tags) metaTags.push(`<span style="background:#f3e5f5;padding:2px 8px;border-radius:4px;font-size:0.85em;">${escapeHtml(question.tags)}</span>`);
                    if (metaTags.length > 0) {
                        html += `<div style="margin-top:6px;">${metaTags.join(' ')}</div>`;
                    }

                    html += `</div>`;

                    html += `<div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">`;
                    html += `<button class="btn btn-outline btn-sm" onclick="editExamQuestion('${question.question_id}')">
                        <i class="fas fa-edit"></i> 编辑
                    </button>`;
                    html += `<button class="btn btn-replace btn-sm" onclick="openReplaceModal('${exam.exam_id}', '${question.question_id}', '${question.question_type}')">
                        <i class="fas fa-sync-alt"></i> 替换
                    </button>`;
                    html += `</div>`;

                    questionDiv.innerHTML = html;
                    typeSection.appendChild(questionDiv);
                });

                container.appendChild(typeSection);
            }

            document.getElementById('final-confirmation-section').style.display = 'block';
            document.getElementById('confirm-exam-btn').onclick = () => confirmExam(exam.exam_id);
            document.getElementById('revert-exam-btn').onclick = () => revertExamConfirmation(exam.exam_id);
            document.getElementById('confirm-exam-btn').style.display = 'inline-flex';
            document.getElementById('revert-exam-btn').style.display = 'none';

            document.getElementById('exam-preview-section').scrollIntoView({ behavior: 'smooth' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== Edit question in exam (inline) ==========
        async function editExamQuestion(questionId) {
            try {
                const response = await fetch(`/api/questions/${questionId}`);
                if (!response.ok) { alert('获取题目信息失败！'); return; }
                const question = await response.json();

                const container = document.getElementById(`exam-q-${questionId}`);
                if (!container) return;

                const isChoice = isChoiceType(question.question_type);
                const options = question.options || [];

                let html = `<div class="form-container" style="margin:0; padding:15px;">`;
                html += `<h4 style="margin-bottom:10px;"><i class="fas fa-edit"></i> 编辑题目</h4>`;
                html += `<div class="form-group"><label>题目内容</label>
                    <textarea id="edit-content-${questionId}" rows="3" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">${escapeHtml(question.content)}</textarea></div>`;

                if (isChoice) {
                    html += `<div class="form-row" style="gap:10px;">`;
                    for (let i = 0; i < 4; i++) {
                        html += `<div class="form-group" style="min-width:200px;"><label>选项${String.fromCharCode(65+i)}</label>
                            <input type="text" id="edit-opt${i}-${questionId}" value="${escapeHtml(options[i] || '')}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></div>`;
                    }
                    html += `</div>`;
                }

                html += `<div class="form-row" style="gap:10px;">
                    <div class="form-group" style="min-width:200px;"><label>答案</label>
                        <input type="text" id="edit-answer-${questionId}" value="${escapeHtml(question.answer || '')}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></div>
                    <div class="form-group" style="min-width:200px;"><label>参考答案</label>
                        <textarea id="edit-ref-${questionId}" rows="2" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">${escapeHtml(question.reference_answer || '')}</textarea></div>
                </div>`;
                html += `<div class="form-group"><label>解析</label>
                    <textarea id="edit-expl-${questionId}" rows="2" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">${escapeHtml(question.explanation || '')}</textarea></div>`;

                html += `<div style="display:flex;gap:8px;">
                    <button class="btn btn-success btn-sm" onclick="saveExamQuestion('${questionId}', ${isChoice})"><i class="fas fa-save"></i> 保存</button>
                    <button class="btn btn-outline btn-sm" onclick="refreshExam()"><i class="fas fa-times"></i> 取消</button>
                </div>`;
                html += `</div>`;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                alert('获取题目信息时发生错误！');
            }
        }

        async function saveExamQuestion(questionId, isChoice) {
            const data = {
                content: document.getElementById(`edit-content-${questionId}`).value,
                answer: document.getElementById(`edit-answer-${questionId}`).value,
                reference_answer: document.getElementById(`edit-ref-${questionId}`).value,
                explanation: document.getElementById(`edit-expl-${questionId}`).value,
            };
            if (isChoice) {
                data.options = [];
                for (let i = 0; i < 4; i++) {
                    const v = document.getElementById(`edit-opt${i}-${questionId}`).value;
                    if (v) data.options.push(v);
                }
            }

            try {
                const response = await fetch(`/api/questions/${questionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    alert('题目已更新！');
                    refreshExam();
                } else {
                    alert('更新失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('更新题目时发生错误！');
            }
        }

        async function refreshExam() {
            if (!currentExam) return;
            try {
                const response = await fetch(`/api/exams/${currentExam.exam_id}`);
                if (response.ok) {
                    currentExam = await response.json();
                    displayExam(currentExam);
                }
            } catch (e) {
                console.error('Error refreshing exam:', e);
            }
        }

        // ========== Replace question ==========
        let _replaceCandidates = [];
        let _replaceCtx = {};

        async function openReplaceModal(examId, oldQuestionId, questionType) {
            try {
                const response = await fetch(`/api/questions?type=${encodeURIComponent(questionType)}`);
                if (!response.ok) { alert('获取候选题目失败！'); return; }
                const allQuestions = await response.json();

                const examQuestionIds = new Set(currentExam.questions.map(q => q.question_id));
                _replaceCandidates = allQuestions.filter(q => !q.is_used && !examQuestionIds.has(q.question_id));
                _replaceCtx = { examId, oldQuestionId, questionType };

                if (_replaceCandidates.length === 0) {
                    alert(`没有可用的 ${questionType} 替换题目（所有同类型题目已被使用或已在试卷中）`);
                    return;
                }

                // Collect unique knowledge points and difficulties for filter dropdowns
                const kpSet = new Set();
                const diffSet = new Set();
                _replaceCandidates.forEach(q => {
                    if (q.knowledge_point) kpSet.add(q.knowledge_point);
                    if (q.difficulty) diffSet.add(q.difficulty);
                });

                const container = document.getElementById(`exam-q-${oldQuestionId}`);
                if (!container) return;

                const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };

                let html = `<div class="form-container" style="margin:0; padding:15px;">`;
                html += `<h4 style="margin-bottom:10px;"><i class="fas fa-sync-alt"></i> 替换题目 — 选择一道 ${escapeHtml(questionType)} 题 <span style="font-weight:normal;font-size:0.85em;color:#888;">（共 ${_replaceCandidates.length} 道可用）</span></h4>`;

                // Search bar
                html += `<div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">`;
                html += `<input type="text" id="replace-keyword" placeholder="搜索题目内容..." style="flex:1; min-width:180px; padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;" oninput="filterReplaceCandidates()">`;
                html += `<select id="replace-difficulty" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;" onchange="filterReplaceCandidates()">`;
                html += `<option value="">全部难度</option>`;
                diffSet.forEach(d => { html += `<option value="${d}">${diffLabels[d] || d}</option>`; });
                html += `</select>`;
                html += `<select id="replace-knowledge-point" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem; max-width:200px;" onchange="filterReplaceCandidates()">`;
                html += `<option value="">全部知识点</option>`;
                kpSet.forEach(kp => { html += `<option value="${escapeHtml(kp)}">${escapeHtml(kp)}</option>`; });
                html += `</select>`;
                html += `</div>`;

                html += `<div id="replace-candidates-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; padding:10px; background:white;">`;
                html += buildReplaceCandidatesHtml(_replaceCandidates);
                html += `</div>`;
                html += `<div id="replace-no-result" style="display:none; padding:15px; text-align:center; color:#999;">没有匹配的候选题目</div>`;
                html += `<div style="margin-top:10px;">
                    <button class="btn btn-outline btn-sm" onclick="refreshExam()"><i class="fas fa-times"></i> 取消</button>
                </div>`;
                html += `</div>`;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                alert('获取候选题目时发生错误！');
            }
        }

        function buildReplaceCandidatesHtml(list) {
            const { examId, oldQuestionId } = _replaceCtx;
            const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };
            const diffColors = { easy: '#e8f5e9', medium: '#fff8e1', hard: '#ffebee' };
            let html = '';
            list.forEach(q => {
                html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; transition: background 0.2s;"
                    onmouseenter="this.style.background='#e3f2fd'" onmouseleave="this.style.background='white'"
                    onclick="doReplace('${examId}', '${oldQuestionId}', '${q.question_id}')">
                    <strong>${escapeHtml(q.content.substring(0, 80))}${q.content.length > 80 ? '...' : ''}</strong>`;
                // Meta tags row
                const tags = [];
                if (q.difficulty) tags.push(`<span style="background:${diffColors[q.difficulty]||'#f5f5f5'};padding:1px 6px;border-radius:3px;font-size:0.8em;">${diffLabels[q.difficulty]||q.difficulty}</span>`);
                if (q.knowledge_point) tags.push(`<span style="background:#e3f2fd;padding:1px 6px;border-radius:3px;font-size:0.8em;">${escapeHtml(q.knowledge_point)}</span>`);
                if (q.answer) tags.push(`<span style="color:#666;font-size:0.8em;">答案: ${escapeHtml(q.answer)}</span>`);
                if (tags.length) html += `<div style="margin-top:4px;">${tags.join(' ')}</div>`;
                html += `</div>`;
            });
            return html;
        }

        function filterReplaceCandidates() {
            const keyword = (document.getElementById('replace-keyword').value || '').trim().toLowerCase();
            const difficulty = document.getElementById('replace-difficulty').value;
            const kp = document.getElementById('replace-knowledge-point').value;

            const filtered = _replaceCandidates.filter(q => {
                if (keyword && !q.content.toLowerCase().includes(keyword) && !(q.content_en && q.content_en.toLowerCase().includes(keyword))) return false;
                if (difficulty && q.difficulty !== difficulty) return false;
                if (kp && q.knowledge_point !== kp) return false;
                return true;
            });

            const listEl = document.getElementById('replace-candidates-list');
            const noResult = document.getElementById('replace-no-result');
            if (filtered.length === 0) {
                listEl.style.display = 'none';
                noResult.style.display = 'block';
            } else {
                listEl.style.display = 'block';
                noResult.style.display = 'none';
                listEl.innerHTML = buildReplaceCandidatesHtml(filtered);
            }
        }

        async function doReplace(examId, oldQuestionId, newQuestionId) {
            try {
                const response = await fetch(`/api/exams/${examId}/replace_question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_question_id: oldQuestionId, new_question_id: newQuestionId })
                });

                if (response.ok) {
                    alert('题目替换成功！');
                    currentExam = await response.json();
                    displayExam(currentExam);
                } else {
                    const err = await response.json().catch(() => null);
                    alert('替换失败！' + (err && err.error ? '\n' + err.error : ''));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('替换题目时发生错误！');
            }
        }

        // ========== Confirm / Revert exam ==========
        async function confirmExam(examId) {
            try {
                const response = await fetch(`/api/exams/${examId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('试卷确认成功！题目已标记为已使用。');
                    document.getElementById('confirm-exam-btn').style.display = 'none';
                    document.getElementById('revert-exam-btn').style.display = 'inline-flex';
                } else {
                    alert('确认试卷失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('确认试卷时发生错误！');
            }
        }

        async function revertExamConfirmation(examId) {
            try {
                const response = await fetch(`/api/exams/${examId}/revert_confirmation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('试卷确认已撤销！题目已标记为未使用。');
                    document.getElementById('confirm-exam-btn').style.display = 'inline-flex';
                    document.getElementById('revert-exam-btn').style.display = 'none';
                } else {
                    alert('撤销确认失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('撤销确认时发生错误！');
            }
        }

        // ========== Question Type Management ==========
        function renderQuestionTypesTable() {
            const tbody = document.getElementById('types-tbody');
            tbody.innerHTML = '';
            questionTypesCache.forEach(qt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${qt.id}</td>
                    <td>${escapeHtml(qt.name)}</td>
                    <td>${escapeHtml(qt.label)}</td>
                    <td>${qt.has_options ? '是' : '否'}</td>
                    <td>${qt.is_builtin ? '内置' : '自定义'}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editQuestionType(${qt.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${qt.is_builtin ? '' : `<button class="btn btn-danger btn-sm" onclick="deleteQuestionType(${qt.id})"><i class="fas fa-trash"></i></button>`}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        document.getElementById('add-type-btn').addEventListener('click', async () => {
            const name = document.getElementById('new-type-name').value.trim();
            const label = document.getElementById('new-type-label').value.trim();
            const hasOptions = document.getElementById('new-type-options').value === 'true';

            if (!name) { alert('请输入题型标识！'); return; }

            try {
                const response = await fetch('/api/question-types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, label: label || name, has_options: hasOptions })
                });
                if (response.ok) {
                    alert('题型添加成功！');
                    document.getElementById('new-type-name').value = '';
                    document.getElementById('new-type-label').value = '';
                    document.getElementById('new-type-options').value = 'false';
                    await loadQuestionTypes();
                    renderQuestionTypesTable();
                } else {
                    const err = await response.json();
                    alert('添加失败：' + (err.error || '未知错误'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('添加题型时发生错误！');
            }
        });

        async function editQuestionType(typeId) {
            const qt = questionTypesCache.find(t => t.id === typeId);
            if (!qt) return;
            const newLabel = prompt('修改显示名称：', qt.label);
            if (newLabel === null) return;

            try {
                const response = await fetch(`/api/question-types/${typeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label: newLabel })
                });
                if (response.ok) {
                    await loadQuestionTypes();
                    renderQuestionTypesTable();
                } else {
                    const err = await response.json();
                    alert('修改失败：' + (err.error || '未知错误'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('修改题型时发生错误！');
            }
        }

        async function deleteQuestionType(typeId) {
            if (!confirm('确定要删除这个题型吗？')) return;
            try {
                const response = await fetch(`/api/question-types/${typeId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('题型删除成功！');
                    await loadQuestionTypes();
                    renderQuestionTypesTable();
                } else {
                    const err = await response.json();
                    alert('删除失败：' + (err.error || '未知错误'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('删除题型时发生错误！');
            }
        }

        // ========== Usage Management ==========
        let usedQuestionsData = [];
        let selectedUsageIds = new Set();

        async function loadUsedQuestions() {
            try {
                const dateFrom = document.getElementById('usage-date-from').value;
                const dateTo = document.getElementById('usage-date-to').value;
                const typeFilter = document.getElementById('usage-type-filter').value;

                let url = '/api/questions?is_used=1';
                if (typeFilter) url += `&type=${encodeURIComponent(typeFilter)}`;

                const response = await fetch(url);
                if (!response.ok) { alert('获取已使用题目失败！'); return; }
                let questions = await response.json();

                // Client-side date filtering
                if (dateFrom) {
                    const from = new Date(dateFrom);
                    from.setHours(0, 0, 0, 0);
                    questions = questions.filter(q => q.used_date && new Date(q.used_date) >= from);
                }
                if (dateTo) {
                    const to = new Date(dateTo);
                    to.setHours(23, 59, 59, 999);
                    questions = questions.filter(q => q.used_date && new Date(q.used_date) <= to);
                }

                // Sort by used_date descending
                questions.sort((a, b) => {
                    if (!a.used_date) return 1;
                    if (!b.used_date) return -1;
                    return new Date(b.used_date) - new Date(a.used_date);
                });

                usedQuestionsData = questions;
                selectedUsageIds.clear();
                document.getElementById('usage-select-all').checked = false;
                renderUsageTable();
                renderUsageSummary();
                updateUsageBatchBar();

                // Populate type filter from cache
                const sel = document.getElementById('usage-type-filter');
                const curVal = sel.value;
                sel.innerHTML = '<option value="">全部题型</option>';
                questionTypesCache.forEach(qt => {
                    const opt = document.createElement('option');
                    opt.value = qt.name;
                    opt.textContent = qt.label;
                    sel.appendChild(opt);
                });
                sel.value = curVal;
            } catch (error) {
                console.error('Error:', error);
                alert('加载使用记录时发生错误！');
            }
        }

        function renderUsageSummary() {
            const el = document.getElementById('usage-summary');
            if (usedQuestionsData.length === 0) {
                el.style.display = 'none';
                return;
            }
            // Group by date
            const dateMap = {};
            const typeMap = {};
            usedQuestionsData.forEach(q => {
                const dateStr = q.used_date ? q.used_date.substring(0, 10) : '未知日期';
                dateMap[dateStr] = (dateMap[dateStr] || 0) + 1;
                typeMap[q.question_type] = (typeMap[q.question_type] || 0) + 1;
            });

            let html = `<strong>共 ${usedQuestionsData.length} 道已使用题目</strong>`;
            html += `<span style="margin-left:20px;">`;
            html += Object.entries(typeMap).map(([t, c]) => `${t}: ${c}题`).join('，');
            html += `</span>`;

            const dates = Object.keys(dateMap).sort().reverse();
            if (dates.length > 0) {
                html += `<div style="margin-top:6px; font-size:0.9em; color:#666;">使用日期分布：`;
                html += dates.map(d => `${d}(${dateMap[d]}题)`).join('、');
                html += `</div>`;
            }

            el.innerHTML = html;
            el.style.display = 'block';
        }

        function renderUsageTable() {
            const tbody = document.getElementById('usage-tbody');
            const emptyEl = document.getElementById('usage-empty');
            const tableEl = document.getElementById('usage-table');
            const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };

            if (usedQuestionsData.length === 0) {
                tbody.innerHTML = '';
                tableEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            tableEl.style.display = 'table';
            emptyEl.style.display = 'none';

            tbody.innerHTML = '';
            usedQuestionsData.forEach(q => {
                const tr = document.createElement('tr');
                const dateStr = q.used_date ? q.used_date.substring(0, 10) : '-';
                const diffText = q.difficulty ? (diffLabels[q.difficulty] || q.difficulty) : '-';
                tr.innerHTML = `
                    <td><input type="checkbox" class="usage-cb" data-id="${q.question_id}" ${selectedUsageIds.has(q.question_id) ? 'checked' : ''}></td>
                    <td title="${q.question_id}">${q.question_id.substring(0, 8)}...</td>
                    <td>${q.question_type}</td>
                    <td title="${escapeHtml(q.content)}">${escapeHtml(q.content.substring(0, 50))}${q.content.length > 50 ? '...' : ''}</td>
                    <td>${diffText}</td>
                    <td>${dateStr}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="releaseSingle('${q.question_id}')">
                            <i class="fas fa-unlock"></i> 释放
                        </button>
                    </td>`;
                tbody.appendChild(tr);
            });

            // Bind checkbox events
            tbody.querySelectorAll('.usage-cb').forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) selectedUsageIds.add(cb.dataset.id);
                    else selectedUsageIds.delete(cb.dataset.id);
                    updateUsageBatchBar();
                });
            });
        }

        document.getElementById('usage-select-all').addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('.usage-cb').forEach(cb => {
                cb.checked = checked;
                if (checked) selectedUsageIds.add(cb.dataset.id);
                else selectedUsageIds.delete(cb.dataset.id);
            });
            updateUsageBatchBar();
        });

        function updateUsageBatchBar() {
            const bar = document.getElementById('usage-batch-bar');
            const count = selectedUsageIds.size;
            document.getElementById('usage-batch-count').textContent = count;
            bar.style.display = (count > 0 || usedQuestionsData.length > 0) ? 'flex' : 'none';
            document.getElementById('usage-release-btn').disabled = count === 0;
        }

        document.getElementById('usage-release-btn').addEventListener('click', async () => {
            if (selectedUsageIds.size === 0) return;
            if (!confirm(`确定要释放选中的 ${selectedUsageIds.size} 道题目吗？释放后可重新参与组卷。`)) return;
            await doRelease(Array.from(selectedUsageIds));
        });

        document.getElementById('usage-release-all-btn').addEventListener('click', async () => {
            if (usedQuestionsData.length === 0) return;
            if (!confirm(`确定要释放当前筛选结果中的全部 ${usedQuestionsData.length} 道题目吗？`)) return;
            await doRelease(usedQuestionsData.map(q => q.question_id));
        });

        async function doRelease(questionIds) {
            try {
                const response = await fetch('/api/questions/batch-release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: questionIds })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`成功释放 ${result.released_count} 道题目！`);
                    loadUsedQuestions();
                } else {
                    const err = await response.json().catch(() => null);
                    alert('释放失败！' + (err?.error || ''));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('释放题目时发生错误！');
            }
        }

        async function releaseSingle(questionId) {
            if (!confirm('确定要释放这道题目吗？')) return;
            await doRelease([questionId]);
        }

        function clearUsageFilters() {
            document.getElementById('usage-date-from').value = '';
            document.getElementById('usage-date-to').value = '';
            document.getElementById('usage-type-filter').value = '';
            loadUsedQuestions();
        }

        // ========== Course Settings ==========
        async function loadCourseSettings() {
            try {
                const response = await fetch('/api/course-settings');
                if (!response.ok) return;
                const settings = await response.json();
                applyCourseSettings(settings);
                fillSettingsForm(settings);
            } catch (error) {
                console.error('Error loading course settings:', error);
            }
        }

        function applyCourseSettings(settings) {
            const titleEl = document.getElementById('site-title');
            const subtitleEl = document.getElementById('site-subtitle');

            if (settings.course_name) {
                const titleText = `${settings.course_name} 试题管理系统`;
                titleEl.innerHTML = `<i class="fas fa-graduation-cap"></i> ${escapeHtml(titleText)}`;
                document.title = titleText;
            } else {
                titleEl.innerHTML = '<i class="fas fa-graduation-cap"></i> 试题管理系统';
                document.title = '试题管理系统';
            }

            const infoParts = [];
            if (settings.course_code) infoParts.push(`课程代号: ${settings.course_code}`);
            if (settings.exam_format) infoParts.push(`考试形式: ${settings.exam_format}`);
            if (settings.exam_method) infoParts.push(`考试方式: ${settings.exam_method}`);
            if (settings.target_audience) infoParts.push(`使用对象: ${settings.target_audience}`);

            if (infoParts.length > 0) {
                subtitleEl.textContent = infoParts.join(' | ');
            } else {
                subtitleEl.textContent = '高效管理试题，智能生成试卷';
            }
        }

        function fillSettingsForm(settings) {
            document.getElementById('settings-institution-name').value = settings.institution_name || '';
            document.getElementById('settings-semester-info').value = settings.semester_info || '';
            document.getElementById('settings-exam-title').value = settings.exam_title || '';
            document.getElementById('settings-paper-label').value = settings.paper_label || '';
            document.getElementById('settings-course-name').value = settings.course_name || '';
            document.getElementById('settings-course-code').value = settings.course_code || '';
            document.getElementById('settings-exam-format').value = settings.exam_format || '';
            document.getElementById('settings-exam-method').value = settings.exam_method || '';
            document.getElementById('settings-target-audience').value = settings.target_audience || '';
        }

        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            const data = {
                institution_name: document.getElementById('settings-institution-name').value.trim(),
                semester_info: document.getElementById('settings-semester-info').value.trim(),
                exam_title: document.getElementById('settings-exam-title').value.trim(),
                paper_label: document.getElementById('settings-paper-label').value.trim(),
                course_name: document.getElementById('settings-course-name').value.trim(),
                course_code: document.getElementById('settings-course-code').value.trim(),
                exam_format: document.getElementById('settings-exam-format').value,
                exam_method: document.getElementById('settings-exam-method').value,
                target_audience: document.getElementById('settings-target-audience').value.trim(),
            };

            try {
                const response = await fetch('/api/course-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const settings = await response.json();
                    applyCourseSettings(settings);
                    alert('设置保存成功！');
                } else {
                    alert('保存设置失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('保存设置时发生错误！');
            }
        });

        // ========== Initialization ==========
        window.addEventListener('DOMContentLoaded', async () => {
            await loadQuestionTypes();
            renderDefaultExamConfig();
            loadQuestions();
            loadCourseSettings();
        });
    </script>
</body>
</html>
