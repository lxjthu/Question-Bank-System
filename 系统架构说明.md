# 试题管理系统 - 系统架构说明

## 项目概述

本项目是一个基于Flask的试题管理系统，支持双语（中英文）试题管理、试卷生成等功能。系统采用前后端分离架构，使用Flask作为后端框架，HTML/CSS/JavaScript作为前端界面。系统新增了模板下载、一键自动组卷、题目替换和试卷最终决定等功能，以提高试题管理效率。

## 当前文件架构

```
D:\code\试卷\试卷生成\
├── app/                          # 应用主目录
│   ├── __init__.py              # 包初始化文件
│   ├── db_models.py             # SQLAlchemy ORM 模型（QuestionTypeModel, QuestionModel, ExamModel）
│   ├── models.py                # 旧版数据模型（保留供参考）
│   ├── routes.py                # API路由定义（含题型管理、批量删除）
│   ├── utils.py                 # 工具函数（动态模板生成、导出、解析）
│   ├── factory.py               # 应用工厂（含种子数据）
│   ├── templates/               # HTML模板目录
│   │   └── index.html           # 主页面模板（4标签页SPA）
│   └── static/                  # 静态资源目录（预留）
├── tests/                        # pytest 测试目录
│   ├── conftest.py              # 共享 fixtures
│   ├── test_models.py           # ORM 模型测试
│   ├── test_question_api.py     # 题库 API 测试
│   ├── test_exam_api.py         # 试卷 API 测试
│   ├── test_business_logic.py   # 业务逻辑测试
│   ├── test_edge_cases.py       # 边界情况测试
│   ├── test_question_types.py   # 题型管理 API 测试
│   └── test_batch_delete.py     # 批量删除 API 测试
├── config.py                    # 配置文件（开发/测试/生产）
├── server.py                    # 应用入口
├── migrate_json_to_db.py        # JSON → SQLite 数据迁移脚本
├── exam_system.db               # SQLite 数据库文件
└── 系统架构说明.md               # 本文档
```

## 模块说明

### 1. app/db_models.py - 数据模型层
- **QuestionTypeModel** — 题型定义（name, label, has_options, is_builtin），支持动态扩展
- **QuestionModel** — 题目数据（支持所有已注册题型），包含双语字段（content_en, options_en）和元数据字段（knowledge_point, tags, difficulty）
- **ExamModel** — 试卷数据，通过 exam_questions 关联表与题目建立多对多关系
- 管理题目的采用状态和采用时间，避免不同年份试卷题目重复

### 2. app/routes.py - 控制器层
- 定义所有API路由（RESTful接口）
- 处理题库管理、试卷生成、Word文档转换等业务逻辑
- 处理模板下载、一键自动组卷、题目替换和试卷最终决定功能
- 题型管理 CRUD（GET/POST/PUT/DELETE /api/question-types）
- 批量操作：批量删除（POST /api/questions/batch-delete）和批量修改题型（POST /api/questions/batch-update-type）
- 搜索支持关键词、题型、语言、难度、知识点多维度过滤
- 双语字段（content_en, options_en）和元数据字段（knowledge_point, tags, difficulty）的增删改
- 试卷导出支持语言模式（zh/en/both）和答案开关（show_answer）
- 自动语言检测：提供英文内容时自动升级 language 为 both
- 使用Flask蓝图组织路由

### 3. app/utils.py - 工具层
- 文件类型验证函数
- Word文档转换器封装
- 动态Word模板生成器（从数据库读取题型，自动包含自定义题型，含双语和元数据格式示例）
- 通用题目模板解析器（支持任意题型，不硬编码题型名称；解析英文选项 `[A_en]` 和元数据行）
- 试卷导出为Word文档（支持中文/英文/中英对照三种模式，可选含答案或仅题目）

### 4. app/templates/index.html - 视图层
- 前端用户界面（四标签页 SPA）
- 题库管理：增删改查、批量删除、批量修改题型、按难度/知识点搜索
- 添加/编辑题目时可展开"双语与元数据"折叠面板（content_en, options_en, knowledge_point, tags, difficulty）
- 题目列表显示难度列和双语图标
- 试卷生成：动态题型配置、一键组卷、题目替换
- 试卷预览支持中文/英文/中英对照三种显示模式切换
- 导出面板支持语言模式和答案开关选择
- 提供试卷最终决定按钮和撤销功能
- JavaScript前端逻辑

### 5. config.py - 配置层
- 应用配置参数
- 文件上传限制设置
- 临时目录管理

### 6. server.py - 应用入口
- Flask应用工厂
- 服务器启动配置
- 路由注册

## 需实现功能

### 1. 题库管理功能
- **添加题目**：默认5种题型（单选题、是非题、论述题、计算题、材料题），可自定义追加其他题型
- **编辑题目**：修改现有题目内容
- **删除题目**：删除不需要的题目
- **导入题目**：从Word文档导入题目（支持标准格式）
- **导出题库**：导出为JSON或CSV格式
- **题目搜索**：按关键词、题型、知识点搜索
- **题目状态管理**：标记题目是否已被采用及采用时间

### 2. 试卷生成功能
- **题型配置**：默认配置（单选题每题2分，共5题；是非题每题1分，共10题；论述题每题10分，共3题；计算题每题10分，共2题；材料题每题30分，共1题；合计总分100分）
- **手动选题**：从题库中手动选择题目
- **自动组卷**：一键智能生成试卷，支持动态题型配置
- **试卷预览**：多种预览模式（全中文、全英文、中英对照、带/不带答案）
- **试卷生成**：根据配置生成完整试卷
- **试卷管理**：保存和加载试卷配置
- **试卷导出**：将保存的试卷导出为word

### 3. 模板下载功能
- **Word模板下载**：提供标准格式的Word试题模板，支持批量录入题库
- **格式规范**：模板采用标准格式，确保批量录入后可无障碍一键导入
- **使用说明**：提供模板使用说明和示例

### 4. 一键自动组卷功能
- **一键生成**：在题型配置完成后，一键自动生成试卷
- **题目预览**：组卷后直接在当前页面浏览所有题目
- **分组展示**：不同类型题目分组展示
- **题目替换**：每道题边上有替换按键，可搜索和选择对应类型的题目来替换
- **实时更新**：替换后实时更新试卷内容和总分

### 5. 试卷最终决定功能
- **最终决定按钮**：提供最终决定试卷的按钮
- **题目标记**：点击后将试卷对应的题目在题库中标记为已采用
- **采用时间记录**：记录题目被采用的时间
- **撤销功能**：支持撤销最终决定，取消题目的采用标记
- **防重复机制**：避免不同年份的试卷出现题目重复

### 6. 高级功能
- **实时总分计算**：动态显示试卷总分
- **题目替换**：在预览界面替换特定题目
- **多语言支持**：中英文双语界面和题目
- **Word导出**：将试卷导出为真正的Word文档（.docx格式），支持样式设置
- **动态题型配置**：支持自定义题型，可添加/删除题型配置
- **题库验证**：自动检查题库是否满足试卷配置要求

### 7. 用户界面
- **标签页导航**：题库管理、试卷生成、模板下载、题型管理
- **响应式设计**：适配不同屏幕尺寸
- **交互反馈**：操作提示和错误处理
- **数据验证**：前端和后端双重验证
- **一键组卷区域**：突出显示一键自动组卷功能区域
- **题目替换界面**：直观的题目替换操作界面

### 8. Word导出增强功能
- **真正的Word文档导出**：生成真正的.docx文件，而非浏览器打印功能
- **样式设置**：支持字体、字号、颜色、页面边距等格式设置
- **预览功能**：独立的预览窗口，可实时查看样式效果
- **独立工具**：提供word_exporter.py工具，支持更详细的样式定制
- **模板生成**：提供标准格式的Word模板生成工具

## 技术特点

### 1. 模块化架构
- 采用MVC设计模式
- 高内聚低耦合的模块设计
- 便于维护和扩展

### 2. 前后端分离
- 前端负责界面展示和用户交互
- 后端提供RESTful API服务
- 数据传输采用JSON格式

### 3. 数据持久化
- SQLite + SQLAlchemy ORM
- 题目使用统计跟踪
- 题目采用状态和时间记录
- 试卷配置保存功能
- 题型定义持久化（支持自定义题型）

### 4. 安全性
- 文件类型验证
- 输入数据校验
- 错误处理机制

## 系统优势

1. **易维护性**：模块化设计，职责清晰
2. **可扩展性**：预留接口，便于功能扩展
3. **用户友好**：直观的界面和操作流程
4. **功能完整**：涵盖试题管理全流程
5. **双语支持**：满足国际化教学需求
6. **高效组卷**：一键自动组卷，提高工作效率
7. **防重复机制**：避免不同年份试卷题目重复
8. **标准化模板**：提供标准格式模板，便于批量录入

## 部署说明

1. 安装依赖：`pip install flask flask-sqlalchemy python-docx pytest`
2. 启动服务器：`python server.py`
3. 访问地址：`http://localhost:5000`
4. 运行测试：`python -m pytest tests/ -v`（89 个测试用例）

## 未来扩展方向

1. 用户认证和权限管理
2. 试卷分析和统计功能（按难度/知识点分布统计）
3. 在线考试功能
4. 题库版本管理与变更历史