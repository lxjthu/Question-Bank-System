<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>试题管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --template-color: #9b59b6;
            --replace-color: #e67e22;
            --light-gray: #ecf0f1;
            --dark-gray: #7f8c8d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        .header h1 {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            position: relative;
            z-index: 2;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Navigation Styles */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            background: var(--light-gray);
            color: var(--primary-color);
        }

        .tab-button.active {
            color: var(--secondary-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }

        /* Main Content Styles */
        .main-content {
            padding: 30px;
            min-height: 600px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-container {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            min-width: 280px;
            flex: 1;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #2980b9 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #219653 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e67e22 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .btn-template {
            background: linear-gradient(135deg, var(--template-color) 0%, #8e44ad 100%);
            color: white;
        }

        .btn-replace {
            background: linear-gradient(135deg, var(--replace-color) 0%, #d35400 100%);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
            transition: background-color 0.2s ease;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Question Preview Styles */
        .question-preview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid var(--secondary-color);
            padding: 20px;
            margin: 10px 0;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            transition: all 0.3s ease;
        }

        .question-preview:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: translateX(10px);
        }

        /* Search Results Styles */
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 10px;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        /* Selected Questions Area */
        .selected-questions {
            border: 2px dashed var(--secondary-color);
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            min-height: 100px;
            margin: 20px 0;
        }

        /* Template Download Area */
        .template-download {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid var(--template-color);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 20px 0;
        }

        /* Auto Exam Generation Area */
        .auto-exam-generation {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 2px solid var(--warning-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        /* Exam Preview Area */
        .exam-preview {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid var(--success-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        /* Final Confirmation Area */
        .final-confirmation {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid var(--danger-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .form-group {
                min-width: 100%;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .main-content {
                padding: 15px;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        /* Additional styles for specific functionality */
        .question-type-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .question-type-header {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .exam-total-score {
            background: var(--accent-color);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-weight: bold;
            display: inline-block;
            margin: 10px 0;
        }

        /* Batch delete bar */
        .batch-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-radius: var(--border-radius);
        }
        .batch-bar.show { display: flex; }

        /* Exam type config row */
        .exam-type-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            border-radius: var(--border-radius);
            transition: opacity 0.15s;
        }
        .exam-type-row select,
        .exam-type-row input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
        }
        .exam-type-row select { min-width: 160px; }
        .exam-type-row input { width: 80px; }
        .exam-drag-handle {
            cursor: grab;
            color: #bbb;
            padding: 2px 4px;
            font-size: 1rem;
            line-height: 1;
            flex-shrink: 0;
            user-select: none;
        }
        .exam-drag-handle:hover { color: #888; }
        .exam-drag-handle:active { cursor: grabbing; }
        .exam-type-row.dragging { opacity: 0.35; }
        .exam-type-row.drag-over-top {
            border-top: 2px solid var(--secondary-color);
            margin-top: -2px;
        }
        .exam-type-row.drag-over-bottom {
            border-bottom: 2px solid var(--secondary-color);
            margin-bottom: -2px;
        }

        /* Type management area */
        .type-management-area {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border: 2px solid #5c6bc0;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        /* Fix #1: Remove double spacing inside form-row */
        .form-row > .form-group {
            margin-bottom: 0;
        }

        /* Fix #2: Button group */
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Fix #3: Status badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1.4;
        }
        .badge-used {
            background: #fde8e8;
            color: #c0392b;
        }
        .badge-unused {
            background: #e8f8e8;
            color: #27ae60;
        }

        /* Fix #4: Action buttons in table */
        .action-btns {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
        }

        /* Fix #5: Search bar button alignment */
        .form-group-btn {
            display: flex;
            align-items: flex-end;
            min-width: auto;
            flex: 0 0 auto;
        }

        /* Quill rich text editor */
        .ql-toolbar.ql-snow {
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border-color: #ddd;
            font-family: inherit;
            background: #fafafa;
        }
        .ql-container.ql-snow {
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border-color: #ddd;
            font-size: 14px;
        }
        .ql-editor { min-height: 80px; }
        .ql-editor img { max-width: 100%; display: block; }
        #quill-content .ql-editor { min-height: 120px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="site-title"><i class="fas fa-graduation-cap"></i> 试题管理系统</h1>
            <p id="site-subtitle">高效管理试题，智能生成试卷</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-button" data-tab="template-download">
                <i class="fas fa-file-import"></i> 题库导入与模板下载
            </button>
            <button class="tab-button active" data-tab="question-bank">
                <i class="fas fa-book"></i> 题库管理
            </button>
            <button class="tab-button" data-tab="exam-generation">
                <i class="fas fa-file-alt"></i> 试卷生成
            </button>
            <button class="tab-button" data-tab="type-management">
                <i class="fas fa-tags"></i> 题型管理
            </button>
            <button class="tab-button" data-tab="usage-management">
                <i class="fas fa-history"></i> 使用管理
            </button>
            <button class="tab-button" data-tab="system-settings">
                <i class="fas fa-cog"></i> 系统设置
            </button>
            <button class="tab-button" data-tab="ai-generation">
                <i class="fas fa-robot"></i> 知识图谱
            </button>
        </div>

        <div class="main-content">
            <!-- Question Bank Tab -->
            <div id="question-bank" class="tab-content active">
                <div class="form-container">
                    <h2><i class="fas fa-plus-circle"></i> 添加题目</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="question-subject">科目</label>
                            <input type="text" id="question-subject" list="subject-datalist-form" placeholder="如: 林业经济学">
                            <datalist id="subject-datalist-form"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="question-type">题型</label>
                            <select id="question-type">
                                <!-- populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="question-language">语言</label>
                            <select id="question-language">
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="both">中英对照</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>题目内容</label>
                        <div id="quill-content"></div>
                    </div>

                    <div class="form-row" id="options-container" style="display: none;">
                        <div class="form-group">
                            <label for="option-a">选项A</label>
                            <input type="text" id="option-a">
                        </div>
                        <div class="form-group">
                            <label for="option-b">选项B</label>
                            <input type="text" id="option-b">
                        </div>
                        <div class="form-group">
                            <label for="option-c">选项C</label>
                            <input type="text" id="option-c">
                        </div>
                        <div class="form-group">
                            <label for="option-d">选项D</label>
                            <input type="text" id="option-d">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="question-answer">答案</label>
                            <input type="text" id="question-answer">
                        </div>
                        <div class="form-group">
                            <label>参考答案</label>
                            <div id="quill-reference"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>解析</label>
                        <div id="quill-explanation"></div>
                    </div>

                    <details id="bilingual-details" style="margin-bottom: 20px;">
                        <summary style="cursor:pointer; font-weight:500; color:var(--primary-color); padding:8px 0;">
                            <i class="fas fa-globe"></i> 双语与元数据（可选）
                        </summary>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: var(--border-radius); margin-top: 10px;">
                            <div class="form-group">
                                <label for="question-content-en">英文题目</label>
                                <textarea id="question-content-en" rows="2" placeholder="English question content"></textarea>
                            </div>
                            <div class="form-row" id="options-en-container" style="display: none;">
                                <div class="form-group">
                                    <label for="option-a-en">英文选项A</label>
                                    <input type="text" id="option-a-en" placeholder="Option A">
                                </div>
                                <div class="form-group">
                                    <label for="option-b-en">英文选项B</label>
                                    <input type="text" id="option-b-en" placeholder="Option B">
                                </div>
                                <div class="form-group">
                                    <label for="option-c-en">英文选项C</label>
                                    <input type="text" id="option-c-en" placeholder="Option C">
                                </div>
                                <div class="form-group">
                                    <label for="option-d-en">英文选项D</label>
                                    <input type="text" id="option-d-en" placeholder="Option D">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="question-knowledge-point">知识点</label>
                                    <input type="text" id="question-knowledge-point" placeholder="如: 经济学基础">
                                </div>
                                <div class="form-group">
                                    <label for="question-tags">标签</label>
                                    <input type="text" id="question-tags" placeholder="逗号分隔，如: 基础,概念">
                                </div>
                                <div class="form-group">
                                    <label for="question-difficulty">难度</label>
                                    <select id="question-difficulty">
                                        <option value="">未设置</option>
                                        <option value="easy">简单 (Easy)</option>
                                        <option value="medium">中等 (Medium)</option>
                                        <option value="hard">困难 (Hard)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>

                    <button id="add-question-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存题目
                    </button>
                </div>

                <div class="card">
                    <h3><i class="fas fa-search"></i> 搜索题目</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <select id="search-subject">
                                <option value="">所有科目</option>
                                <!-- populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="text" id="search-keyword" placeholder="输入关键词搜索...">
                        </div>
                        <div class="form-group">
                            <select id="search-type">
                                <option value="">所有题型</option>
                                <!-- populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <select id="search-language">
                                <option value="">所有语言</option>
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="both">中英对照</option>
                            </select>
                        </div>
                        <div class="form-group form-group-btn">
                            <button id="search-btn" class="btn btn-outline">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                    <div id="question-count-bar" style="margin-top:8px; font-size:0.9rem; color:var(--dark-gray);"></div>
                </div>

                <div class="batch-bar" id="batch-bar">
                    <span style="color: var(--dark-gray); font-weight:500;">已选择 <span id="batch-count2">0</span> 题</span>
                    <select id="batch-type-select" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;">
                    </select>
                    <button id="batch-type-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-exchange-alt"></i> 批量修改题型
                    </button>
                    <button id="batch-delete-btn" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i> 批量删除 (<span id="batch-count">0</span>)
                    </button>
                </div>

                <div class="table-container">
                    <table id="questions-table">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="select-all-cb"></th>
                                <th>ID</th>
                                <th>科目</th>
                                <th>题型</th>
                                <th>内容</th>
                                <th>难度</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="questions-tbody">
                            <!-- Questions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Exam Generation Tab -->
            <div id="exam-generation" class="tab-content">
                <div class="auto-exam-generation">
                    <h3><i class="fas fa-bolt"></i> 一键自动组卷</h3>
                    <p>根据以下配置自动生成试卷：</p>

                    <div style="margin-bottom:15px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                        <label style="font-weight:500; color:var(--primary-color);" for="exam-subject-filter">
                            <i class="fas fa-book-open"></i> 组卷科目：
                        </label>
                        <select id="exam-subject-filter" style="padding:8px 14px; border:1px solid #ddd; border-radius:var(--border-radius); min-width:160px; font-size:0.95rem;">
                            <option value="">不限科目（所有题目）</option>
                            <!-- populated dynamically -->
                        </select>
                    </div>

                    <div id="exam-type-configs">
                        <!-- dynamic rows rendered by JS -->
                    </div>

                    <button id="add-exam-type-btn" class="btn btn-outline btn-sm" style="margin-bottom:15px;">
                        <i class="fas fa-plus"></i> 添加题型
                    </button>

                    <div id="exam-total-score" class="exam-total-score">
                        试卷总分: <span id="total-score">0</span> 分
                    </div>

                    <div style="margin-top: 15px;">
                        <button id="generate-exam-btn" class="btn btn-warning">
                            <i class="fas fa-magic"></i> 一键生成试卷
                        </button>
                    </div>
                </div>

                <div class="exam-preview" id="exam-preview-section" style="display: none;">
                    <h3><i class="fas fa-eye"></i> 试卷预览</h3>

                    <div style="margin-bottom: 15px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <span style="font-weight: 500; color: var(--primary-color);">显示语言：</span>
                        <button class="btn btn-sm btn-primary" id="mode-zh-btn" onclick="setExamDisplayMode('zh')">中文</button>
                        <button class="btn btn-sm btn-outline" id="mode-en-btn" onclick="setExamDisplayMode('en')">英文</button>
                        <button class="btn btn-sm btn-outline" id="mode-both-btn" onclick="setExamDisplayMode('both')">中英对照</button>
                    </div>

                    <div id="exam-questions-container">
                        <!-- Exam questions will be displayed here -->
                    </div>

                    <div class="final-confirmation" id="final-confirmation-section" style="display: none;">
                        <h3><i class="fas fa-check-circle"></i> 试卷最终决定</h3>
                        <p>确认后，试卷中的题目将被标记为已使用，避免在其他试卷中重复出现。</p>
                        <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                            <button id="confirm-exam-btn" class="btn btn-success">
                                <i class="fas fa-check"></i> 确认试卷
                            </button>
                            <button id="revert-exam-btn" class="btn btn-warning" style="display: none;">
                                <i class="fas fa-undo"></i> 撤销确认
                            </button>
                            <span style="color:#ccc; margin: 0 4px;">|</span>
                            <label for="export-mode-select" style="font-weight:500;">语言：</label>
                            <select id="export-mode-select" style="padding:8px 12px; border:1px solid #ddd; border-radius:var(--border-radius);">
                                <option value="zh">中文</option>
                                <option value="en">英文</option>
                                <option value="both">中英对照</option>
                            </select>
                            <label for="export-answer-select" style="font-weight:500;">内容：</label>
                            <select id="export-answer-select" style="padding:8px 12px; border:1px solid #ddd; border-radius:var(--border-radius);">
                                <option value="0">只导出题目</option>
                                <option value="1">题目 + 答案</option>
                            </select>
                            <button class="btn btn-template btn-sm" onclick="exportCurrentExam()">
                                <i class="fas fa-file-word"></i> 导出Word
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Download Tab -->
            <div id="template-download" class="tab-content">
                <div class="template-download">
                    <h3><i class="fas fa-file-word"></i> 试题库导入模板下载</h3>
                    <p>下载标准格式的Word试题模板，支持批量录入题库</p>
                    <p>模板采用标准格式，确保批量录入后可无障碍一键导入</p>

                    <button id="download-template-btn" class="btn btn-template">
                        <i class="fas fa-download"></i> 下载Word模板
                    </button>

                    <div style="margin-top: 20px;">
                        <h4>模板使用说明：</h4>
                        <ul style="text-align: left; margin-top: 10px;">
                            <li>每道题以 [题型] 开头，题型标识符用方括号包围</li>
                            <li>题型后可跟答案标识符（如 [A]、[ABD] 等）</li>
                            <li>选择题答案紧跟在题型标识后，用方括号包围</li>
                            <li>选择题选项格式：[选项字母] + 选项内容</li>
                            <li>解析可选，用 &lt;解析&gt;...&lt;解析&gt; 包围</li>
                            <li>参考答案用 &lt;参考答案&gt;...&lt;参考答案&gt; 包围</li>
                            <li>中文内容用 （中文） 标注，英文内容用 （英文） 标注</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-file-upload"></i> 导入题库</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="import-subject">导入科目 <span style="color:var(--danger-color);">*</span></label>
                            <input type="text" id="import-subject" list="subject-datalist-import" placeholder="请输入或选择考试科目" required>
                            <datalist id="subject-datalist-import"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="import-file">选择文件</label>
                            <input type="file" id="import-file" accept=".docx,.txt,.csv">
                        </div>
                    </div>
                    <button id="import-btn" class="btn btn-primary">
                        <i class="fas fa-upload"></i> 导入题库
                    </button>
                </div>

                <div class="card">
                    <h3><i class="fas fa-file-export"></i> 导出题库</h3>
                    <div class="btn-group">
                        <button id="export-json-btn" class="btn btn-outline">
                            <i class="fas fa-file-code"></i> 导出为JSON
                        </button>
                        <button id="export-csv-btn" class="btn btn-outline">
                            <i class="fas fa-file-csv"></i> 导出为CSV
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-top:20px;">
                    <h3><i class="fas fa-robot"></i> AI 出题提示词</h3>
                    <p>
                        <strong>方式一（有 PPT/PDF）：</strong>直接复制下方提示词，连同 PPT/PDF 文件一起发给支持文件上传的 AI（如 DeepSeek、豆包、千问等），AI 将自动出题。<br>
                        <strong>方式二（有复习要点）：</strong>上传复习要点文档，点击"生成含复习要点的提示词"，将要点直接嵌入提示词后复制给 AI，无需再上传文件。<br>
                        AI 生成的结果保存为 .txt 文件后，可通过上方"导入题库"功能导入系统。
                    </p>

                    <div class="form-row" style="align-items:center; margin-bottom:12px;">
                        <div class="form-group" style="min-width:220px;">
                            <label for="prompt-mode-select">选择出题模式</label>
                            <select id="prompt-mode-select">
                                <option value="zh">模式一：纯中文出题</option>
                                <option value="bilingual">模式二：中英双语出题</option>
                                <option value="en">模式三：纯英文出题</option>
                            </select>
                        </div>
                        <button id="copy-prompt-btn" class="btn btn-outline" style="align-self:flex-end;">
                            <i class="fas fa-copy"></i> 复制提示词
                        </button>
                    </div>

                    <!-- Review Notes Upload Panel -->
                    <div style="margin-bottom:14px; padding:12px 14px; background:#f0f4ff; border-radius:8px; border:1px solid #c5d0fa;">
                        <div style="font-weight:600; margin-bottom:5px; color:#3b5bdb; font-size:14px;">
                            <i class="fas fa-file-lines"></i> 上传复习要点（可选）
                        </div>
                        <p style="margin:0 0 10px; font-size:13px; color:#555;">
                            上传复习要点文档（.docx 或 .txt），系统将把要点内容嵌入提示词——无需再向 AI 上传 PPT/PDF，直接将生成的提示词发给 AI 即可出题。
                        </p>
                        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <input type="file" id="review-notes-file" accept=".docx,.txt"
                                style="flex:1; min-width:180px; font-size:13px;">
                            <button id="gen-prompt-with-notes-btn" class="btn btn-primary" style="white-space:nowrap;">
                                <i class="fas fa-wand-magic-sparkles"></i> 生成含复习要点的提示词
                            </button>
                            <button id="clear-review-notes-btn" class="btn btn-outline" style="white-space:nowrap; display:none;">
                                <i class="fas fa-times"></i> 清除要点
                            </button>
                        </div>
                        <div id="review-notes-status" style="margin-top:7px; font-size:13px;"></div>
                    </div>

                    <textarea id="prompt-display" readonly rows="18"
                        style="width:100%; font-family:monospace; font-size:13px; resize:vertical;
                               background:#f8f9fa; border:1px solid #ddd; padding:12px; border-radius:6px; box-sizing:border-box;">
                    </textarea>
                </div>
            </div>

            <!-- Type Management Tab -->
            <div id="type-management" class="tab-content">
                <div class="type-management-area">
                    <h3><i class="fas fa-tags"></i> 题型管理</h3>
                    <p>管理系统中的题型，内置题型不可删除。</p>

                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group" style="min-width:160px;">
                            <label for="new-type-name">题型标识</label>
                            <input type="text" id="new-type-name" placeholder="如: 简答>案例">
                        </div>
                        <div class="form-group" style="min-width:160px;">
                            <label for="new-type-label">显示名称</label>
                            <input type="text" id="new-type-label" placeholder="如: 案例分析题">
                        </div>
                        <div class="form-group" style="min-width:120px;">
                            <label for="new-type-options">有选项</label>
                            <select id="new-type-options">
                                <option value="false">否</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                        <div class="form-group" style="min-width:100px; display:flex; align-items:flex-end;">
                            <button id="add-type-btn" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> 添加
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container" style="margin-top: 20px;">
                    <table id="types-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标识</th>
                                <th>显示名称</th>
                                <th>有选项</th>
                                <th>类型</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="types-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Usage Management Tab -->
            <div id="usage-management" class="tab-content">
                <h3><i class="fas fa-history"></i> 题目使用管理</h3>
                <p>查看和管理已使用题目，按使用日期筛选后可一键释放，释放后题目可重新参与组卷。</p>

                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin:20px 0;">
                    <div class="form-group" style="margin-bottom:0; min-width:160px;">
                        <label for="usage-date-from">使用日期从</label>
                        <input type="date" id="usage-date-from" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius);">
                    </div>
                    <div class="form-group" style="margin-bottom:0; min-width:160px;">
                        <label for="usage-date-to">使用日期到</label>
                        <input type="date" id="usage-date-to" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius);">
                    </div>
                    <div class="form-group" style="margin-bottom:0; min-width:140px;">
                        <label for="usage-type-filter">题型</label>
                        <select id="usage-type-filter" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius);">
                            <option value="">全部题型</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="loadUsedQuestions()">
                        <i class="fas fa-search"></i> 查询
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="clearUsageFilters()">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>

                <div id="usage-summary" style="margin-bottom:15px; padding:12px 18px; background:#f8f9fa; border-radius:var(--border-radius); display:none;">
                </div>

                <div class="batch-bar" id="usage-batch-bar" style="background:#fff3e0;">
                    <span style="font-weight:500;">已选择 <span id="usage-batch-count">0</span> 题</span>
                    <button class="btn btn-warning btn-sm" id="usage-release-btn">
                        <i class="fas fa-unlock"></i> 释放选中题目
                    </button>
                    <button class="btn btn-warning btn-sm" id="usage-release-all-btn">
                        <i class="fas fa-unlock-alt"></i> 释放全部筛选结果
                    </button>
                </div>

                <div class="table-container">
                    <table id="usage-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="usage-select-all"></th>
                                <th>ID</th>
                                <th>题型</th>
                                <th>内容</th>
                                <th>难度</th>
                                <th>使用日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="usage-tbody">
                        </tbody>
                    </table>
                </div>
                <div id="usage-empty" style="display:none; padding:30px; text-align:center; color:#999;">
                    <i class="fas fa-check-circle" style="font-size:2em; margin-bottom:10px; display:block;"></i>
                    暂无已使用的题目
                </div>
            </div>

            <!-- System Settings Tab -->
            <div id="system-settings" class="tab-content">
                <div class="form-container">
                    <h3><i class="fas fa-cog"></i> 课程与系统设置</h3>
                    <p style="margin-bottom:20px; color:var(--dark-gray);">配置课程信息后，页面标题和导出试卷将自动使用这些信息。</p>

                    <h4 style="margin:16px 0 10px; color:#555; border-bottom:1px solid #eee; padding-bottom:6px;">试卷头部信息</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-institution-name">学校/机构名称</label>
                            <input type="text" id="settings-institution-name" placeholder="如: 中南财经政法大学">
                        </div>
                        <div class="form-group">
                            <label for="settings-semester-info">学期信息</label>
                            <input type="text" id="settings-semester-info" placeholder="如: 2023–2024学年第1学期">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-exam-title">考试标题</label>
                            <input type="text" id="settings-exam-title" placeholder="如: 期末考试试卷">
                        </div>
                        <div class="form-group" style="max-width: 160px; flex: 0 0 160px;">
                            <label for="settings-paper-label">试卷标签</label>
                            <input type="text" id="settings-paper-label" placeholder="如: A" maxlength="4">
                        </div>
                    </div>

                    <h4 style="margin:16px 0 10px; color:#555; border-bottom:1px solid #eee; padding-bottom:6px;">课程信息</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-course-name">课程名称</label>
                            <input type="text" id="settings-course-name" placeholder="如: 林业经济学（双语）">
                        </div>
                        <div class="form-group">
                            <label for="settings-course-code">课程代号</label>
                            <input type="text" id="settings-course-code" placeholder="如: FE301">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="settings-exam-format">考试形式</label>
                            <select id="settings-exam-format">
                                <option value="">未设置</option>
                                <option value="开卷">开卷</option>
                                <option value="闭卷">闭卷</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="settings-exam-method">考试方式</label>
                            <select id="settings-exam-method">
                                <option value="">未设置</option>
                                <option value="笔试">笔试</option>
                                <option value="口试">口试</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="settings-target-audience">使用对象</label>
                        <input type="text" id="settings-target-audience" placeholder="如: 林学专业本科生">
                    </div>

                    <button id="save-settings-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存设置
                    </button>
                </div>
            </div>

            <!-- AI Generation Tab -->
            <div id="ai-generation" class="tab-content">

                <!-- ── 出题模式切换 ── -->
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:14px; flex-wrap:wrap;">
                    <span style="font-size:0.9rem; color:#555; font-weight:500;">出题模式：</span>
                    <div style="display:inline-flex; border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#f5f5f5;">
                        <button id="ai-mode-btn-deepseek" onclick="setAiMode('deepseek')"
                            style="padding:8px 18px; font-size:0.88rem; border:none; cursor:pointer;
                                   background:var(--secondary-color); color:white; font-weight:500;
                                   display:flex; align-items:center; gap:6px;">
                            <i class="fas fa-brain"></i> DeepSeek 直出
                        </button>
                        <button id="ai-mode-btn-rag" onclick="setAiMode('rag')"
                            style="padding:8px 18px; font-size:0.88rem; border:none; cursor:pointer;
                                   background:transparent; color:#666;
                                   display:flex; align-items:center; gap:6px;">
                            <i class="fas fa-search"></i> RAG 向量检索
                        </button>
                    </div>
                    <span id="ai-mode-desc" style="font-size:0.78rem; color:#888;">
                        无需向量数据库，DeepSeek 直接分析文档知识结构并出题
                    </span>
                </div>

                <!-- ── RAG 模式切换弹窗（两阶段：确认 → 安装） ── -->
                <div id="rag-warning-modal" style="display:none; position:fixed; inset:0;
                    background:rgba(0,0,0,0.55); z-index:9999; justify-content:center; align-items:center;">
                    <div style="background:white; border-radius:10px; padding:28px 32px; max-width:500px;
                        width:90%; box-shadow:0 20px 40px rgba(0,0,0,0.3);">

                        <!-- 阶段1：确认提示 -->
                        <div id="rag-warn-phase1">
                            <h3 style="margin-bottom:14px; color:var(--warning-color);">
                                <i class="fas fa-exclamation-triangle"></i> 切换到 RAG 向量检索模式
                            </h3>
                            <p style="margin-bottom:12px; color:#444; line-height:1.7; font-size:0.92rem;">
                                RAG 模式需要在本地运行 <strong>向量嵌入模型</strong>，对硬件有较高要求：
                            </p>
                            <ul style="margin:0 0 14px 18px; color:#555; font-size:0.88rem; line-height:2.1;">
                                <li>推荐 <strong>GPU 显存 ≥ 4 GB</strong>（RTX 3060 及以上）</li>
                                <li>CPU 模式可用，但每次检索约需 10～30 秒</li>
                                <li>首次使用需下载嵌入模型权重：<strong>BGE-large-zh（约 1.3 GB）</strong></li>
                                <li>点击「确认」后将自动安装所需 Python 依赖包</li>
                            </ul>
                            <div style="display:flex; gap:10px; justify-content:flex-end;">
                                <button onclick="closeRagWarning(false)" class="btn btn-outline" style="padding:7px 18px;">
                                    取消
                                </button>
                                <button onclick="closeRagWarning(true)" class="btn btn-warning" style="padding:7px 18px;">
                                    确认，开始安装依赖
                                </button>
                            </div>
                        </div>

                        <!-- 阶段2：安装进度 -->
                        <div id="rag-warn-phase2" style="display:none;">
                            <h3 style="margin-bottom:18px; color:var(--secondary-color);">
                                <i class="fas fa-download"></i> 正在安装 RAG 依赖
                            </h3>
                            <div style="background:#f8f9fa; border-radius:6px; padding:14px 16px; margin-bottom:16px;
                                font-size:0.88rem; color:#444; min-height:48px; line-height:1.7;">
                                <i class="fas fa-spinner fa-spin" style="color:var(--secondary-color);"></i>
                                <span id="rag-install-log" style="margin-left:8px;">准备中...</span>
                            </div>
                            <div style="background:#eee; border-radius:4px; height:6px; overflow:hidden; margin-bottom:16px;">
                                <div id="rag-install-bar" style="height:100%; width:30%; background:var(--secondary-color);
                                    border-radius:4px; transition:width 0.4s;
                                    animation: rag-bar-anim 1.5s ease-in-out infinite alternate;"></div>
                            </div>
                            <p style="font-size:0.8rem; color:#999; margin:0;">
                                安装过程中请勿关闭窗口，网络较慢时可能需要数分钟。
                            </p>
                        </div>

                        <!-- 阶段3：安装结果 -->
                        <div id="rag-warn-phase3" style="display:none;">
                            <h3 id="rag-install-result-title" style="margin-bottom:14px;"></h3>
                            <p id="rag-install-result-msg" style="color:#555; font-size:0.9rem; margin-bottom:20px; line-height:1.7;"></p>
                            <div style="display:flex; gap:10px; justify-content:flex-end;">
                                <button id="rag-install-result-btn" onclick="closeRagWarning(false)"
                                    class="btn btn-outline" style="padding:7px 18px;">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                @keyframes rag-bar-anim { from { width:20%; } to { width:80%; } }
                </style>

                <!-- Top: Two columns -->
                <div style="display:flex; gap:16px; margin-bottom:16px; align-items:flex-start;">

                    <!-- Left column: Knowledge base management (25%) + API config -->
                    <div style="width:260px; flex-shrink:0; display:flex; flex-direction:column; gap:12px;">

                        <!-- DS 知识点提取面板（DeepSeek 直出模式，默认显示） -->
                        <div id="ds-kb-panel" class="form-container" style="padding:16px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                                <h3 style="margin:0;font-size:0.95rem;"><i class="fas fa-brain"></i> 文档知识提取</h3>
                                <button onclick="showDsKgModal()"
                                    style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;font-size:0.78rem;background:linear-gradient(135deg,#6c3483,#2980b9);color:#fff;border:none;border-radius:14px;cursor:pointer;white-space:nowrap;box-shadow:0 2px 5px rgba(0,0,0,0.15);"
                                    title="可视化展示已提取的知识点关系图谱">
                                    <i class="fas fa-project-diagram"></i> 知识图谱
                                </button>
                            </div>

                            <!-- 提取进度条 -->
                            <div id="ds-extract-progress" style="display:none; padding:7px 10px;
                                background:#fff3cd; border-radius:5px; margin-bottom:8px;
                                font-size:0.8rem; color:#856404;">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:6px;">
                                    <div style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span id="ds-extract-progress-text">提取中...</span>
                                    </div>
                                    <button id="ds-pause-btn" onclick="pauseDsExtract()"
                                        style="flex-shrink:0; padding:2px 9px; font-size:0.78rem;
                                               background:#e67e22; color:white; border:none;
                                               border-radius:4px; cursor:pointer; white-space:nowrap;">
                                        <i class="fas fa-pause"></i> 暂停
                                    </button>
                                </div>
                            </div>

                            <!-- 上传区域 -->
                            <div id="ds-upload-area"
                                style="border:2px dashed #aaa; border-radius:8px; padding:16px;
                                       text-align:center; cursor:pointer; background:#fafafa;
                                       margin-bottom:10px; transition:border-color 0.2s;"
                                ondragover="event.preventDefault(); this.style.borderColor='#3498db';"
                                ondragleave="this.style.borderColor='#aaa';"
                                ondrop="event.preventDefault(); this.style.borderColor='#aaa'; dsUploadFiles(event.dataTransfer.files);"
                                onclick="document.getElementById('ds-file-input').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size:1.6rem; color:#aaa; margin-bottom:5px; display:block;"></i>
                                <div style="font-size:0.83rem; color:#888;">拖拽或点击上传</div>
                                <div style="font-size:0.75rem; color:#bbb; margin-top:3px;">.md &nbsp;.txt &nbsp;.docx &nbsp;.pptx &nbsp;.pdf</div>
                            </div>
                            <input type="file" id="ds-file-input" style="display:none;" multiple
                                accept=".md,.txt,.docx,.pptx,.ppt,.pdf"
                                onchange="dsUploadFiles(this.files)">

                            <!-- DS 文档列表 -->
                            <div id="ds-doc-list" style="max-height:360px; overflow-y:auto;">
                                <div style="text-align:center; color:#bbb; padding:20px; font-size:0.85rem;">
                                    <i class="fas fa-folder-open"></i><br>暂无文档，请上传教材
                                </div>
                            </div>
                        </div>

                        <!-- RAG 知识库管理面板（RAG 向量检索模式，默认隐藏） -->
                        <div id="rag-kb-panel" class="form-container" style="padding:16px; display:none;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
                                <h3 style="margin:0;"><i class="fas fa-database"></i> 知识库管理</h3>
                                <a href="/kg" target="_blank"
                                    style="display:inline-flex;align-items:center;gap:5px;padding:4px 10px;font-size:0.78rem;background:linear-gradient(135deg,#9b59b6,#3498db);color:#fff;border-radius:14px;text-decoration:none;white-space:nowrap;box-shadow:0 2px 5px rgba(0,0,0,0.15);"
                                    title="在新标签页打开知识图谱">
                                    <i class="fas fa-project-diagram"></i> 知识图谱
                                </a>
                            </div>

                            <!-- Upload area -->
                            <div id="rag-upload-area"
                                style="border:2px dashed #aaa; border-radius:8px; padding:20px; text-align:center; cursor:pointer; background:#fafafa; margin-bottom:10px; transition:border-color 0.2s;"
                                ondragover="event.preventDefault(); this.style.borderColor='#3498db';"
                                ondragleave="this.style.borderColor='#aaa';"
                                ondrop="event.preventDefault(); this.style.borderColor='#aaa'; ragUploadFiles(event.dataTransfer.files);"
                                onclick="document.getElementById('rag-file-input').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size:1.8rem; color:#aaa; margin-bottom:6px; display:block;"></i>
                                <div style="font-size:0.85rem; color:#888;">拖拽或点击上传</div>
                                <div style="font-size:0.78rem; color:#bbb; margin-top:4px;">.md .txt .docx .pptx .pdf</div>
                            </div>
                            <input type="file" id="rag-file-input" style="display:none;" multiple
                                accept=".md,.txt,.docx,.pptx,.ppt,.pdf"
                                onchange="ragUploadFiles(this.files)">

                            <!-- Doc type selector -->
                            <div style="margin-bottom:10px; font-size:0.85rem; color:#555;">
                                文档类型：
                                <label style="margin-left:4px;"><input type="radio" name="rag-doc-type" value="auto" checked> 自动</label>
                                <label style="margin-left:8px;"><input type="radio" name="rag-doc-type" value="textbook"> 教材</label>
                                <label style="margin-left:8px;"><input type="radio" name="rag-doc-type" value="slides"> 幻灯片</label>
                            </div>

                            <!-- Document list -->
                            <div id="rag-doc-list" style="max-height:420px; overflow-y:auto;">
                                <div style="text-align:center; color:#bbb; padding:20px; font-size:0.85rem;">
                                    <i class="fas fa-folder-open"></i><br>暂无文档
                                </div>
                            </div>
                        </div>
                        <!-- /rag-kb-panel -->

                        <!-- API 配置卡片 -->
                        <div class="form-container" style="padding:14px;">
                            <h3 style="margin-bottom:10px; font-size:0.92rem; color:var(--primary-color);">
                                <i class="fas fa-key"></i> API 配置
                            </h3>
                            <div style="display:flex; flex-direction:column; gap:9px; font-size:0.83rem;">
                                <div>
                                    <label style="display:block; margin-bottom:3px; color:#666;">PaddleOCR 服务地址</label>
                                    <input type="text" id="cfg-paddle-url"
                                        placeholder="https://your-paddleocr/layout-parsing"
                                        style="width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.78rem; font-family:monospace; box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block; margin-bottom:3px; color:#666;">PaddleOCR API Key</label>
                                    <input type="password" id="cfg-paddle-token"
                                        placeholder="token / api key"
                                        style="width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.78rem; font-family:monospace; box-sizing:border-box;">
                                </div>
                                <div>
                                    <label style="display:block; margin-bottom:3px; color:#666;">DeepSeek API Key</label>
                                    <input type="password" id="cfg-deepseek-key"
                                        placeholder="sk-..."
                                        style="width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:5px; font-size:0.78rem; font-family:monospace; box-sizing:border-box;">
                                </div>
                                <div style="display:flex; align-items:center; gap:8px; margin-top:2px;">
                                    <button class="btn btn-primary" onclick="saveRagConfig()"
                                        style="padding:5px 14px; font-size:0.8rem;">
                                        <i class="fas fa-save"></i> 保存
                                    </button>
                                    <span id="cfg-save-status" style="font-size:0.78rem; color:#888;"></span>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Right column: Generation config (remaining width) -->
                    <div style="flex:1; min-width:0;">
                        <div class="form-container" style="padding:16px;">
                            <h3 style="margin-bottom:14px;"><i class="fas fa-sliders-h"></i> 出题配置</h3>

                            <!-- 出题科目 -->
                            <div style="margin-bottom:14px;">
                                <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--primary-color);">出题科目</label>
                                <input type="text" id="rag-subject" placeholder="如：林业经济学"
                                    style="width:100%; padding:10px 15px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:1rem;">
                            </div>

                            <!-- 参考文档 -->
                            <div style="margin-bottom:14px;">
                                <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--primary-color);">
                                    参考文档 <span style="font-weight:normal; font-size:0.8rem; color:#888;">（可多选）</span>
                                </label>
                                <div id="rag-doc-checkboxes"
                                    style="border:1px solid #ddd; border-radius:6px; padding:8px; max-height:100px; overflow-y:auto; background:#fff; font-size:0.9rem; text-align:left;">
                                    <span style="color:#bbb;">上传文档后在此选择</span>
                                </div>
                            </div>

                            <!-- 章节筛选 + 知识点：左右两列 -->
                            <div style="display:flex; gap:16px; margin-bottom:14px;">
                                <!-- 章节筛选 -->
                                <div style="flex:1; min-width:0;">
                                    <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--primary-color);">
                                        章节筛选 <span style="font-weight:normal; font-size:0.78rem; color:#888;">（留空则全部）</span>
                                    </label>
                                    <input type="text" id="rag-chapter-search" placeholder="搜索章节..."
                                        style="width:100%; padding:7px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.88rem; margin-bottom:4px;"
                                        oninput="filterRagChapters()">
                                    <div id="rag-chapter-list"
                                        style="border:1px solid #ddd; border-radius:6px; padding:6px; max-height:130px; overflow-y:auto; background:#fff; font-size:0.85rem; text-align:left;">
                                        <span style="color:#bbb;">选择文档后加载章节</span>
                                    </div>
                                </div>
                                <!-- 知识点/节名 -->
                                <div style="flex:1; min-width:0;">
                                    <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--primary-color);">
                                        知识点/节名 <span style="font-weight:normal; font-size:0.78rem; color:#888;">（留空则全部）</span>
                                    </label>
                                    <input type="text" id="rag-section-search" placeholder="搜索知识点..."
                                        style="width:100%; padding:7px 10px; border:1px solid #ddd; border-radius:6px; font-size:0.88rem; margin-bottom:4px;"
                                        oninput="filterRagSections()">
                                    <div id="rag-section-list"
                                        style="border:1px solid #ddd; border-radius:6px; padding:6px; max-height:130px; overflow-y:auto; background:#fff; font-size:0.85rem; text-align:left;">
                                        <span style="color:#bbb;">选择文档后加载</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 出题语言 + 题型与数量：左右两列，不使用 form-group 避免 min-width 干扰 -->
                            <div style="display:flex; gap:24px; align-items:flex-start;">
                                <!-- 出题语言 -->
                                <div style="flex-shrink:0; width:90px;">
                                    <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--primary-color);">出题语言</label>
                                    <div style="display:flex; flex-direction:column; gap:8px; margin-top:4px;">
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.9rem; white-space:nowrap;">
                                            <input type="radio" name="rag-lang" value="zh" checked onchange="setRagPromptMode('zh')"> 中文
                                        </label>
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.9rem; white-space:nowrap;">
                                            <input type="radio" name="rag-lang" value="bilingual" onchange="setRagPromptMode('bilingual')"> 双语
                                        </label>
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.9rem; white-space:nowrap;">
                                            <input type="radio" name="rag-lang" value="en" onchange="setRagPromptMode('en')"> 英文
                                        </label>
                                    </div>
                                </div>

                                <!-- 题型与数量表 -->
                                <div style="flex:1; min-width:0;">
                                    <label style="display:block; margin-bottom:5px; font-weight:500; color:var(--primary-color);">题型与数量</label>
                                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                                        <thead>
                                            <tr style="background:#f5f5f5;">
                                                <th style="text-align:left; padding:5px 10px; border:1px solid #ddd; font-weight:500;">题型</th>
                                                <th style="text-align:center; padding:5px 10px; border:1px solid #ddd; width:90px; font-weight:500;">数量（题）</th>
                                                <th style="text-align:center; padding:5px 10px; border:1px solid #ddd; width:50px; font-weight:500;">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rag-type-rows"></tbody>
                                    </table>
                                    <button class="btn btn-outline btn-sm" onclick="addRagTypeRow()" style="margin-top:8px; font-size:0.85rem;">
                                        <i class="fas fa-plus"></i> 添加题型
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompt editor -->
                <div class="form-container" style="padding:16px; margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:8px;">
                        <h3 style="margin:0;"><i class="fas fa-edit"></i> 提示词模板（可编辑）</h3>
                        <div style="display:flex; gap:6px;">
                            <button class="btn btn-outline" id="rag-lang-btn-zh" onclick="setRagPromptMode('zh')" style="padding:5px 12px; font-size:0.85rem;">中文</button>
                            <button class="btn btn-outline" id="rag-lang-btn-bilingual" onclick="setRagPromptMode('bilingual')" style="padding:5px 12px; font-size:0.85rem;">双语</button>
                            <button class="btn btn-outline" id="rag-lang-btn-en" onclick="setRagPromptMode('en')" style="padding:5px 12px; font-size:0.85rem;">English</button>
                        </div>
                    </div>
                    <textarea id="rag-prompt-editor"
                        style="width:100%; height:280px; font-family:monospace; font-size:0.82rem; padding:10px; border:1px solid #ddd; border-radius:6px; resize:vertical; line-height:1.5;"></textarea>
                </div>

                <!-- Generate button -->
                <div style="text-align:center; margin-bottom:16px;">
                    <button id="rag-generate-btn" class="btn btn-success" onclick="ragGenerate()" style="padding:12px 40px; font-size:1.1rem;">
                        <i class="fas fa-magic"></i> 一键出题
                    </button>
                    <div id="rag-generate-info" style="font-size:0.8rem; color:#888; margin-top:6px;"></div>
                </div>

                <!-- Results area -->
                <div class="form-container" style="padding:16px;">
                    <h3 style="margin-bottom:10px;"><i class="fas fa-list-alt"></i> 生成结果</h3>
                    <textarea id="rag-result" readonly
                        style="width:100%; height:400px; font-family:monospace; font-size:0.82rem; padding:10px; border:1px solid #ddd; border-radius:6px; resize:vertical; line-height:1.5; background:#f9f9f9;"
                        placeholder="点击「一键出题」后，生成的题目将显示在这里..."></textarea>
                    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                        <button class="btn btn-outline" onclick="ragCopyResult()">
                            <i class="fas fa-copy"></i> 复制结果
                        </button>
                        <button class="btn btn-primary" onclick="ragImportToBank()">
                            <i class="fas fa-file-import"></i> 导入题库
                        </button>
                        <span id="rag-import-status" style="align-self:center; font-size:0.85rem; color:#888;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
    <script>
        // ========== Global question types cache ==========
        let questionTypesCache = [];

        async function loadQuestionTypes() {
            try {
                const response = await fetch('/api/question-types');
                if (response.ok) {
                    questionTypesCache = await response.json();
                    populateTypeDropdowns();
                }
            } catch (error) {
                console.error('Error loading question types:', error);
            }
        }

        function isChoiceType(typeName) {
            const qt = questionTypesCache.find(t => t.name === typeName);
            return qt ? qt.has_options : false;
        }

        function populateTypeDropdowns() {
            // Add question type dropdown
            const addSelect = document.getElementById('question-type');
            const currentVal = addSelect.value;
            addSelect.innerHTML = '';
            questionTypesCache.forEach(qt => {
                const opt = document.createElement('option');
                opt.value = qt.name;
                opt.textContent = qt.label;
                addSelect.appendChild(opt);
            });
            if (currentVal) addSelect.value = currentVal;

            // Toggle options on change
            toggleOptionsContainer();

            // Search type dropdown
            const searchSelect = document.getElementById('search-type');
            const searchVal = searchSelect.value;
            searchSelect.innerHTML = '<option value="">所有题型</option>';
            questionTypesCache.forEach(qt => {
                const opt = document.createElement('option');
                opt.value = qt.name;
                opt.textContent = qt.label;
                searchSelect.appendChild(opt);
            });
            if (searchVal) searchSelect.value = searchVal;

            // Batch type change dropdown
            const batchSelect = document.getElementById('batch-type-select');
            batchSelect.innerHTML = '';
            questionTypesCache.forEach(qt => {
                const opt = document.createElement('option');
                opt.value = qt.name;
                opt.textContent = qt.label;
                batchSelect.appendChild(opt);
            });

            // 初始化 RAG 题型表格（loadQuestionTypes 加载完成后执行一次）
            initRagTypeTable();
        }

        function toggleOptionsContainer() {
            const typeSelect = document.getElementById('question-type');
            const isChoice = isChoiceType(typeSelect.value);
            document.getElementById('options-container').style.display = isChoice ? 'flex' : 'none';
            const enContainer = document.getElementById('options-en-container');
            if (enContainer) enContainer.style.display = isChoice ? 'flex' : 'none';
        }

        // Tab switching functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');

                if (tabId === 'type-management') renderQuestionTypesTable();
                if (tabId === 'usage-management') loadUsedQuestions();
                if (tabId === 'ai-generation') { (_aiMode === 'deepseek' ? loadDsDocs() : loadRagDocs()); loadRagConfig(); }
            });
        });

        // Toggle options container based on question type
        document.getElementById('question-type').addEventListener('change', toggleOptionsContainer);

        // Add/Update question functionality
        document.getElementById('add-question-btn').addEventListener('click', async () => {
            const questionType = document.getElementById('question-type').value;
            const language = document.getElementById('question-language').value;
            const _qcHtml = quillContent.root.innerHTML;
            const content = (_qcHtml === '<p><br></p>' || _qcHtml === '') ? '' : _qcHtml;

            let options = [];
            if (isChoiceType(questionType)) {
                const optionA = document.getElementById('option-a').value;
                const optionB = document.getElementById('option-b').value;
                const optionC = document.getElementById('option-c').value;
                const optionD = document.getElementById('option-d').value;

                if (optionA) options.push(optionA);
                if (optionB) options.push(optionB);
                if (optionC) options.push(optionC);
                if (optionD) options.push(optionD);
            }

            const answer = document.getElementById('question-answer').value;
            const _qrHtml = quillReference.root.innerHTML;
            const reference = (_qrHtml === '<p><br></p>' || _qrHtml === '') ? '' : _qrHtml;
            const _qeHtml = quillExplanation.root.innerHTML;
            const explanation = (_qeHtml === '<p><br></p>' || _qeHtml === '') ? '' : _qeHtml;

            // Collect bilingual/metadata fields
            const contentEn = document.getElementById('question-content-en').value;
            let optionsEn = [];
            if (isChoiceType(questionType)) {
                const oa = document.getElementById('option-a-en').value;
                const ob = document.getElementById('option-b-en').value;
                const oc = document.getElementById('option-c-en').value;
                const od = document.getElementById('option-d-en').value;
                if (oa) optionsEn.push(oa);
                if (ob) optionsEn.push(ob);
                if (oc) optionsEn.push(oc);
                if (od) optionsEn.push(od);
            }
            const questionSubject = document.getElementById('question-subject').value;
            const knowledgePoint = document.getElementById('question-knowledge-point').value;
            const tags = document.getElementById('question-tags').value;
            const difficulty = document.getElementById('question-difficulty').value;

            const questionData = {
                question_type: questionType,
                content: content,
                options: options,
                answer: answer,
                reference_answer: reference,
                explanation: explanation,
                language: language,
                content_en: contentEn || null,
                options_en: optionsEn.length > 0 ? optionsEn : null,
                subject: questionSubject || null,
                knowledge_point: knowledgePoint || null,
                tags: tags || null,
                difficulty: difficulty || null,
            };

            try {
                let response;
                if (editingQuestionId) {
                    response = await fetch(`/api/questions/${editingQuestionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                } else {
                    response = await fetch('/api/questions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                }

                if (response.ok) {
                    alert(editingQuestionId ? '题目更新成功！' : '题目添加成功！');
                    cancelEdit();
                    loadQuestions();
                } else {
                    alert(editingQuestionId ? '更新题目失败！' : '添加题目失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert(editingQuestionId ? '更新题目时发生错误！' : '添加题目时发生错误！');
            }
        });

        // Search functionality
        document.getElementById('search-btn').addEventListener('click', loadQuestions);

        // ========== Batch selection state ==========
        let selectedQuestionIds = new Set();

        function updateBatchBar() {
            const count = selectedQuestionIds.size;
            document.getElementById('batch-count').textContent = count;
            document.getElementById('batch-count2').textContent = count;
            const bar = document.getElementById('batch-bar');
            bar.classList.toggle('show', count > 0);
        }

        document.getElementById('select-all-cb').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.question-cb');
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
                if (this.checked) {
                    selectedQuestionIds.add(cb.dataset.id);
                } else {
                    selectedQuestionIds.delete(cb.dataset.id);
                }
            });
            updateBatchBar();
        });

        document.getElementById('batch-delete-btn').addEventListener('click', async () => {
            if (selectedQuestionIds.size === 0) return;
            if (!confirm(`确定要删除选中的 ${selectedQuestionIds.size} 道题目吗？`)) return;
            try {
                const response = await fetch('/api/questions/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: Array.from(selectedQuestionIds) })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`成功删除 ${result.deleted_count} 道题目！`);
                    selectedQuestionIds.clear();
                    document.getElementById('select-all-cb').checked = false;
                    updateBatchBar();
                    loadQuestions();
                } else {
                    alert('批量删除失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('批量删除时发生错误！');
            }
        });

        document.getElementById('batch-type-btn').addEventListener('click', async () => {
            if (selectedQuestionIds.size === 0) return;
            const newType = document.getElementById('batch-type-select').value;
            const qt = questionTypesCache.find(t => t.name === newType);
            const label = qt ? qt.label : newType;
            if (!confirm(`确定要将选中的 ${selectedQuestionIds.size} 道题目的题型修改为「${label}」吗？`)) return;
            try {
                const response = await fetch('/api/questions/batch-update-type', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: Array.from(selectedQuestionIds), question_type: newType })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`成功修改 ${result.updated_count} 道题目的题型为「${label}」！`);
                    selectedQuestionIds.clear();
                    document.getElementById('select-all-cb').checked = false;
                    updateBatchBar();
                    loadQuestions();
                } else {
                    const err = await response.json().catch(() => null);
                    alert(err?.error || '批量修改题型失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('批量修改题型时发生错误！');
            }
        });

        // Load questions function
        async function loadQuestions() {
            const keyword = document.getElementById('search-keyword').value;
            const type = document.getElementById('search-type').value;
            const language = document.getElementById('search-language').value;
            const subject = document.getElementById('search-subject').value;

            let url = '/api/questions';
            const params = [];
            if (subject) params.push(`subject=${encodeURIComponent(subject)}`);
            if (keyword) params.push(`keyword=${encodeURIComponent(keyword)}`);
            if (type) params.push(`type=${encodeURIComponent(type)}`);
            if (language) params.push(`language=${encodeURIComponent(language)}`);

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            try {
                const response = await fetch(url);
                const questions = await response.json();

                const tbody = document.getElementById('questions-tbody');
                tbody.innerHTML = '';
                selectedQuestionIds.clear();
                document.getElementById('select-all-cb').checked = false;
                updateBatchBar();

                // Show question count
                const countBar = document.getElementById('question-count-bar');
                if (countBar) {
                    const subjectLabel = subject ? `「${subject}」` : '全部科目';
                    countBar.textContent = `共找到 ${questions.length} 道题目（${subjectLabel}）`;
                }

                questions.forEach(question => {
                    const row = document.createElement('tr');
                    const status = question.is_used ? '已使用' : '未使用';
                    const statusClass = question.is_used ? 'badge badge-used' : 'badge badge-unused';

                    const bilingualIcon = question.content_en ? ' <i class="fas fa-globe" title="双语" style="color:var(--secondary-color);"></i>' : '';
                    const difficultyMap = { easy: '简单', medium: '中等', hard: '困难' };
                    const difficultyText = question.difficulty ? (difficultyMap[question.difficulty] || question.difficulty) : '-';
                    const metaTitle = [
                        question.subject ? '科目: ' + question.subject : '',
                        question.knowledge_point ? '知识点: ' + question.knowledge_point : '',
                        question.tags ? '标签: ' + question.tags : ''
                    ].filter(Boolean).join('\n');

                    row.innerHTML = `
                        <td><input type="checkbox" class="question-cb" data-id="${question.question_id}"></td>
                        <td>${question.question_id.substring(0, 8)}...</td>
                        <td>${question.subject || '-'}</td>
                        <td>${question.question_type}</td>
                        <td title="${escapeHtml(metaTitle)}">${escapeHtml(stripHtml(question.content).substring(0, 50))}${stripHtml(question.content).length > 50 ? '...' : ''}${bilingualIcon}</td>
                        <td>${difficultyText}</td>
                        <td><span class="${statusClass}">${status}</span></td>
                        <td><div class="action-btns">
                            <button class="btn btn-outline btn-sm" onclick="editQuestion('${question.question_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${question.question_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        </td>
                    `;

                    // Bind checkbox
                    const cb = row.querySelector('.question-cb');
                    cb.addEventListener('change', function() {
                        if (this.checked) {
                            selectedQuestionIds.add(this.dataset.id);
                        } else {
                            selectedQuestionIds.delete(this.dataset.id);
                        }
                        updateBatchBar();
                    });

                    // Click row to enter edit mode (excluding checkbox and action buttons)
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', function(e) {
                        if (e.target.closest('.action-btns') || e.target.type === 'checkbox') return;
                        editQuestion(question.question_id);
                    });

                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        // Currently editing question ID (null means adding new)
        let editingQuestionId = null;

        // Edit question function
        async function editQuestion(questionId) {
            try {
                const response = await fetch(`/api/questions/${questionId}`);
                if (!response.ok) {
                    alert('获取题目信息失败！');
                    return;
                }
                const question = await response.json();

                // Switch to question bank tab
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector('[data-tab="question-bank"]').classList.add('active');
                document.getElementById('question-bank').classList.add('active');

                // Fill form with question data
                document.getElementById('question-subject').value = question.subject || '';
                document.getElementById('question-type').value = question.question_type;
                document.getElementById('question-language').value = question.language || 'zh';
                quillContent.root.innerHTML = question.content || '';
                document.getElementById('question-answer').value = question.answer || '';
                quillReference.root.innerHTML = question.reference_answer || '';
                quillExplanation.root.innerHTML = question.explanation || '';

                // Show/hide options and fill them
                const optionsContainer = document.getElementById('options-container');
                if (isChoiceType(question.question_type)) {
                    optionsContainer.style.display = 'flex';
                    const options = question.options || [];
                    document.getElementById('option-a').value = options[0] || '';
                    document.getElementById('option-b').value = options[1] || '';
                    document.getElementById('option-c').value = options[2] || '';
                    document.getElementById('option-d').value = options[3] || '';
                } else {
                    optionsContainer.style.display = 'none';
                    document.getElementById('option-a').value = '';
                    document.getElementById('option-b').value = '';
                    document.getElementById('option-c').value = '';
                    document.getElementById('option-d').value = '';
                }

                // Fill bilingual/metadata fields
                document.getElementById('question-content-en').value = question.content_en || '';
                const optionsEn = question.options_en || [];
                document.getElementById('option-a-en').value = optionsEn[0] || '';
                document.getElementById('option-b-en').value = optionsEn[1] || '';
                document.getElementById('option-c-en').value = optionsEn[2] || '';
                document.getElementById('option-d-en').value = optionsEn[3] || '';
                document.getElementById('question-knowledge-point').value = question.knowledge_point || '';
                document.getElementById('question-tags').value = question.tags || '';
                document.getElementById('question-difficulty').value = question.difficulty || '';
                // Open the details if bilingual/metadata exists
                if (question.content_en || question.knowledge_point || question.tags || question.difficulty) {
                    document.getElementById('bilingual-details').open = true;
                }

                editingQuestionId = questionId;
                const btn = document.getElementById('add-question-btn');
                btn.innerHTML = '<i class="fas fa-save"></i> 更新题目';
                btn.className = 'btn btn-success';

                let cancelBtn = document.getElementById('cancel-edit-btn');
                if (!cancelBtn) {
                    cancelBtn = document.createElement('button');
                    cancelBtn.id = 'cancel-edit-btn';
                    cancelBtn.className = 'btn btn-outline';
                    cancelBtn.style.marginLeft = '10px';
                    cancelBtn.innerHTML = '<i class="fas fa-times"></i> 取消编辑';
                    cancelBtn.addEventListener('click', cancelEdit);
                    btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
                }
                cancelBtn.style.display = 'inline-flex';

                document.querySelector('.form-container h2').innerHTML = '<i class="fas fa-edit"></i> 编辑题目';
                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error:', error);
                alert('获取题目信息时发生错误！');
            }
        }

        function cancelEdit() {
            editingQuestionId = null;
            const btn = document.getElementById('add-question-btn');
            btn.innerHTML = '<i class="fas fa-save"></i> 保存题目';
            btn.className = 'btn btn-primary';

            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) cancelBtn.style.display = 'none';

            document.querySelector('.form-container h2').innerHTML = '<i class="fas fa-plus-circle"></i> 添加题目';

            document.getElementById('question-subject').value = '';
            document.getElementById('question-type').value = questionTypesCache.length ? questionTypesCache[0].name : '';
            document.getElementById('question-language').value = 'zh';
            quillContent.setText('');
            document.getElementById('option-a').value = '';
            document.getElementById('option-b').value = '';
            document.getElementById('option-c').value = '';
            document.getElementById('option-d').value = '';
            document.getElementById('question-answer').value = '';
            quillReference.setText('');
            quillExplanation.setText('');
            document.getElementById('question-content-en').value = '';
            document.getElementById('option-a-en').value = '';
            document.getElementById('option-b-en').value = '';
            document.getElementById('option-c-en').value = '';
            document.getElementById('option-d-en').value = '';
            document.getElementById('question-knowledge-point').value = '';
            document.getElementById('question-tags').value = '';
            document.getElementById('question-difficulty').value = '';
            document.getElementById('bilingual-details').open = false;
            toggleOptionsContainer();
        }

        // Delete question function
        async function deleteQuestion(questionId) {
            if (confirm('确定要删除这个题目吗？')) {
                try {
                    const response = await fetch(`/api/questions/${questionId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('题目删除成功！');
                        loadQuestions();
                    } else {
                        alert('删除题目失败！');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('删除题目时发生错误！');
                }
            }
        }

        // Template download functionality
        document.getElementById('download-template-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/templates/download');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'question_template.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('下载模板失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('下载模板时发生错误！');
            }
        });

        // Import functionality
        document.getElementById('import-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            const importSubject = document.getElementById('import-subject').value.trim();

            if (!importSubject) {
                alert('请填写考试科目！');
                document.getElementById('import-subject').focus();
                return;
            }

            if (!file) {
                alert('请选择一个文件！');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('subject', importSubject);

            try {
                const response = await fetch('/api/questions/import', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    const skipMsg = result.skipped > 0 ? `，跳过重复题目 ${result.skipped} 道` : '';
                    alert(`题库导入成功！科目：${importSubject}\n导入 ${result.count} 道题目${skipMsg}`);
                    fileInput.value = '';
                    loadQuestions();
                    loadSubjects();  // refresh subject dropdowns
                } else {
                    const errorData = await response.json();
                    alert(`导入失败: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导入题库时发生错误！');
            }
        });

        // Export functionality
        document.getElementById('export-json-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/questions/export?format=json');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `question_bank_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('导出失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导出题库时发生错误！');
            }
        });

        document.getElementById('export-csv-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/questions/export?format=csv');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `question_bank_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('导出失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导出题库时发生错误！');
            }
        });

        // ========== Dynamic exam type config ==========
        let examTypeRowId = 0;

        const defaultExamRows = [
            { name: '单选', count: 5, points: 2 },
            { name: '是非', count: 10, points: 1 },
            { name: '简答>论述', count: 3, points: 10 },
            { name: '简答>计算', count: 2, points: 10 },
            { name: '简答>材料分析', count: 1, points: 30 },
        ];

        function renderDefaultExamConfig() {
            const container = document.getElementById('exam-type-configs');
            container.innerHTML = '';
            examTypeRowId = 0;
            defaultExamRows.forEach(row => addExamTypeRow(row.name, row.count, row.points));
        }

        // ── 拖拽排序状态 ──────────────────────────────────────────────────────────
        let _examDragSrc = null;

        function _examDragStart(e) {
            _examDragSrc = e.currentTarget;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', _examDragSrc.id);
            // 稍微延迟加 class，避免截图时已变透明
            requestAnimationFrame(() => _examDragSrc.classList.add('dragging'));
        }

        function _examDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const row = e.currentTarget;
            if (row === _examDragSrc) return;
            const midY = row.getBoundingClientRect().top + row.getBoundingClientRect().height / 2;
            if (e.clientY < midY) {
                row.classList.add('drag-over-top');
                row.classList.remove('drag-over-bottom');
            } else {
                row.classList.add('drag-over-bottom');
                row.classList.remove('drag-over-top');
            }
        }

        function _examDragLeave(e) {
            e.currentTarget.classList.remove('drag-over-top', 'drag-over-bottom');
        }

        function _examDrop(e) {
            e.preventDefault();
            const target = e.currentTarget;
            target.classList.remove('drag-over-top', 'drag-over-bottom');
            if (!_examDragSrc || target === _examDragSrc) return;
            const container = document.getElementById('exam-type-configs');
            const midY = target.getBoundingClientRect().top + target.getBoundingClientRect().height / 2;
            if (e.clientY < midY) {
                container.insertBefore(_examDragSrc, target);
            } else {
                container.insertBefore(_examDragSrc, target.nextSibling);
            }
        }

        function _examDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('#exam-type-configs .exam-type-row').forEach(r => {
                r.classList.remove('drag-over-top', 'drag-over-bottom');
            });
            _examDragSrc = null;
        }

        function _bindDragEvents(div) {
            div.setAttribute('draggable', 'true');
            div.addEventListener('dragstart',  _examDragStart);
            div.addEventListener('dragover',   _examDragOver);
            div.addEventListener('dragleave',  _examDragLeave);
            div.addEventListener('drop',       _examDrop);
            div.addEventListener('dragend',    _examDragEnd);
        }

        function addExamTypeRow(typeName, count, points) {
            const container = document.getElementById('exam-type-configs');
            const rowId = examTypeRowId++;
            const div = document.createElement('div');
            div.className = 'exam-type-row';
            div.id = `exam-type-row-${rowId}`;

            let selectHtml = `<select class="exam-type-select" data-row="${rowId}">`;
            questionTypesCache.forEach(qt => {
                const selected = qt.name === typeName ? ' selected' : '';
                selectHtml += `<option value="${qt.name}"${selected}>${qt.label}</option>`;
            });
            selectHtml += `</select>`;

            div.innerHTML = `
                <span class="exam-drag-handle" title="拖动调整顺序"><i class="fas fa-grip-vertical"></i></span>
                ${selectHtml}
                <input type="number" class="exam-type-count" data-row="${rowId}" value="${count || 0}" min="0" placeholder="数量">
                <small>题</small>
                <input type="number" class="exam-type-points" data-row="${rowId}" value="${points || 0}" min="0" placeholder="分数">
                <small>分/题</small>
                <button class="btn btn-danger btn-sm" onclick="removeExamTypeRow(${rowId})" title="删除">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);

            // 绑定拖拽和计分事件
            _bindDragEvents(div);
            div.querySelector('.exam-type-count').addEventListener('input', updateTotalScore);
            div.querySelector('.exam-type-points').addEventListener('input', updateTotalScore);

            updateTotalScore();
        }

        function removeExamTypeRow(rowId) {
            const row = document.getElementById(`exam-type-row-${rowId}`);
            if (row) row.remove();
            updateTotalScore();
        }

        document.getElementById('add-exam-type-btn').addEventListener('click', () => {
            addExamTypeRow('', 0, 0);
        });

        function getExamConfig() {
            const config = {};
            document.querySelectorAll('.exam-type-row').forEach(row => {
                const select = row.querySelector('.exam-type-select');
                const countInput = row.querySelector('.exam-type-count');
                const pointsInput = row.querySelector('.exam-type-points');
                if (select && select.value) {
                    config[select.value] = {
                        count: parseInt(countInput.value) || 0,
                        points: parseInt(pointsInput.value) || 0,
                    };
                }
            });
            return config;
        }

        function updateTotalScore() {
            const config = getExamConfig();
            let total = 0;
            for (const settings of Object.values(config)) {
                total += settings.count * settings.points;
            }
            document.getElementById('total-score').textContent = total;
        }

        // ========== Current exam state ==========
        let currentExam = null;

        // ========== Auto exam generation ==========
        document.getElementById('generate-exam-btn').addEventListener('click', async () => {
            const config = getExamConfig();
            const examSubject = document.getElementById('exam-subject-filter').value;
            const subjectSuffix = examSubject ? `_${examSubject}` : '';
            const examData = {
                name: `自动组卷${subjectSuffix}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}`,
                config: config,
                subject: examSubject || null,
            };

            try {
                const response = await fetch('/api/exams/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(examData)
                });

                if (response.ok) {
                    currentExam = await response.json();
                    displayExam(currentExam);
                } else {
                    const err = await response.json().catch(() => null);
                    alert('生成试卷失败！' + (err && err.error ? '\n' + err.error : ''));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('生成试卷时发生错误！');
            }
        });

        // ========== Exam display mode ==========
        let examDisplayMode = 'zh';

        function setExamDisplayMode(mode) {
            examDisplayMode = mode;
            // Update button styles
            ['zh', 'en', 'both'].forEach(m => {
                const btn = document.getElementById(`mode-${m}-btn`);
                if (btn) {
                    btn.className = m === mode ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';
                }
            });
            if (currentExam) displayExam(currentExam);
        }

        async function exportCurrentExam() {
            if (!currentExam) { alert('请先生成试卷！'); return; }
            const mode = document.getElementById('export-mode-select').value;
            const showAnswer = document.getElementById('export-answer-select').value;
            const suffix = showAnswer === '1' ? '含答案' : '题目';
            try {
                const response = await fetch(`/api/exams/${currentExam.exam_id}/export?mode=${mode}&show_answer=${showAnswer}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentExam.name}_${mode}_${suffix}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('导出失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('导出试卷时发生错误！');
            }
        }

        // ========== Display exam ==========
        function displayExam(exam) {
            currentExam = exam;
            document.getElementById('exam-preview-section').style.display = 'block';

            const questionsByType = {};
            const typeOrder = [];
            exam.questions.forEach(question => {
                if (!questionsByType[question.question_type]) {
                    questionsByType[question.question_type] = [];
                    typeOrder.push(question.question_type);
                }
                questionsByType[question.question_type].push(question);
            });

            const container = document.getElementById('exam-questions-container');
            container.innerHTML = '';

            let globalIndex = 0;
            for (const type of typeOrder) {
                const questions = questionsByType[type];
                const config = exam.config[type] || {};
                const perPoint = config.points || 0;
                const subtotal = questions.length * perPoint;

                const typeSection = document.createElement('div');
                typeSection.className = 'question-type-section';

                const header = document.createElement('div');
                header.className = 'question-type-header';
                header.innerHTML = `${type} （共${questions.length}题，每题${perPoint}分，小计${subtotal}分）`;
                typeSection.appendChild(header);

                questions.forEach((question, index) => {
                    globalIndex++;
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-preview';
                    questionDiv.id = `exam-q-${question.question_id}`;

                    const mode = examDisplayMode;
                    const contentEn = question.content_en || '';
                    const optionsEn = question.options_en || [];

                    let html = `<div class="exam-question-content">`;

                    // Content based on display mode
                    if (mode === 'zh') {
                        html += `<strong>${globalIndex}. ${escapeHtml(question.content)}</strong>`;
                    } else if (mode === 'en') {
                        const displayContent = contentEn || question.content;
                        html += `<strong>${globalIndex}. ${escapeHtml(displayContent)}</strong>`;
                    } else {
                        html += `<strong>${globalIndex}. ${escapeHtml(question.content)}</strong>`;
                        if (contentEn) {
                            html += `<div style="margin-top:4px; color:#555; font-style:italic;">${escapeHtml(contentEn)}</div>`;
                        }
                    }

                    // Options based on display mode
                    if (mode === 'zh' && question.options && question.options.length > 0) {
                        html += '<div style="margin: 8px 0 0 20px;">';
                        question.options.forEach((option, optIndex) => {
                            html += `<div>${String.fromCharCode(65 + optIndex)}. ${escapeHtml(option)}</div>`;
                        });
                        html += '</div>';
                    } else if (mode === 'en') {
                        const displayOpts = optionsEn.length > 0 ? optionsEn : (question.options || []);
                        if (displayOpts.length > 0) {
                            html += '<div style="margin: 8px 0 0 20px;">';
                            displayOpts.forEach((option, optIndex) => {
                                html += `<div>${String.fromCharCode(65 + optIndex)}. ${escapeHtml(option)}</div>`;
                            });
                            html += '</div>';
                        }
                    } else if (mode === 'both' && question.options && question.options.length > 0) {
                        html += '<div style="margin: 8px 0 0 20px;">';
                        const maxLen = Math.max(question.options.length, optionsEn.length);
                        for (let oi = 0; oi < maxLen; oi++) {
                            const zhOpt = question.options[oi] || '';
                            const enOpt = optionsEn[oi] || '';
                            if (enOpt) {
                                html += `<div>${String.fromCharCode(65 + oi)}. ${escapeHtml(zhOpt)} / ${escapeHtml(enOpt)}</div>`;
                            } else {
                                html += `<div>${String.fromCharCode(65 + oi)}. ${escapeHtml(zhOpt)}</div>`;
                            }
                        }
                        html += '</div>';
                    }

                    if (question.answer) {
                        html += `<div style="margin-top:6px;"><strong>答案:</strong> ${escapeHtml(question.answer)}</div>`;
                    }
                    if (question.reference_answer) {
                        html += `<div><strong>参考答案:</strong> ${escapeHtml(question.reference_answer)}</div>`;
                    }
                    if (question.explanation) {
                        html += `<div><strong>解析:</strong> ${escapeHtml(question.explanation)}</div>`;
                    }

                    // Metadata tags
                    const metaTags = [];
                    if (question.knowledge_point) metaTags.push(`<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:0.85em;margin-right:4px;">知识点: ${escapeHtml(question.knowledge_point)}</span>`);
                    if (question.difficulty) {
                        const dMap = {easy:'简单',medium:'中等',hard:'困难'};
                        const dColor = {easy:'#e8f5e9',medium:'#fff8e1',hard:'#ffebee'};
                        metaTags.push(`<span style="background:${dColor[question.difficulty]||'#f5f5f5'};padding:2px 8px;border-radius:4px;font-size:0.85em;margin-right:4px;">${dMap[question.difficulty]||question.difficulty}</span>`);
                    }
                    if (question.tags) metaTags.push(`<span style="background:#f3e5f5;padding:2px 8px;border-radius:4px;font-size:0.85em;">${escapeHtml(question.tags)}</span>`);
                    if (metaTags.length > 0) {
                        html += `<div style="margin-top:6px;">${metaTags.join(' ')}</div>`;
                    }

                    html += `</div>`;

                    html += `<div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">`;
                    html += `<button class="btn btn-outline btn-sm" onclick="editExamQuestion('${question.question_id}')">
                        <i class="fas fa-edit"></i> 编辑
                    </button>`;
                    html += `<button class="btn btn-replace btn-sm" onclick="openReplaceModal('${exam.exam_id}', '${question.question_id}', '${question.question_type}')">
                        <i class="fas fa-sync-alt"></i> 替换
                    </button>`;
                    html += `</div>`;

                    questionDiv.innerHTML = html;
                    typeSection.appendChild(questionDiv);
                });

                container.appendChild(typeSection);
            }

            document.getElementById('final-confirmation-section').style.display = 'block';
            document.getElementById('confirm-exam-btn').onclick = () => confirmExam(exam.exam_id);
            document.getElementById('revert-exam-btn').onclick = () => revertExamConfirmation(exam.exam_id);
            document.getElementById('confirm-exam-btn').style.display = 'inline-flex';
            document.getElementById('revert-exam-btn').style.display = 'none';

            document.getElementById('exam-preview-section').scrollIntoView({ behavior: 'smooth' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function stripHtml(html) {
            if (!html || !html.includes('<')) return html || '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // ========== Edit question in exam (inline) ==========
        async function editExamQuestion(questionId) {
            try {
                const response = await fetch(`/api/questions/${questionId}`);
                if (!response.ok) { alert('获取题目信息失败！'); return; }
                const question = await response.json();

                const container = document.getElementById(`exam-q-${questionId}`);
                if (!container) return;

                const isChoice = isChoiceType(question.question_type);
                const options = question.options || [];

                let html = `<div class="form-container" style="margin:0; padding:15px;">`;
                html += `<h4 style="margin-bottom:10px;"><i class="fas fa-edit"></i> 编辑题目</h4>`;
                html += `<div class="form-group"><label>题目内容</label>
                    <textarea id="edit-content-${questionId}" rows="3" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">${escapeHtml(question.content)}</textarea></div>`;

                if (isChoice) {
                    html += `<div class="form-row" style="gap:10px;">`;
                    for (let i = 0; i < 4; i++) {
                        html += `<div class="form-group" style="min-width:200px;"><label>选项${String.fromCharCode(65+i)}</label>
                            <input type="text" id="edit-opt${i}-${questionId}" value="${escapeHtml(options[i] || '')}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></div>`;
                    }
                    html += `</div>`;
                }

                html += `<div class="form-row" style="gap:10px;">
                    <div class="form-group" style="min-width:200px;"><label>答案</label>
                        <input type="text" id="edit-answer-${questionId}" value="${escapeHtml(question.answer || '')}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;"></div>
                    <div class="form-group" style="min-width:200px;"><label>参考答案</label>
                        <textarea id="edit-ref-${questionId}" rows="2" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">${escapeHtml(question.reference_answer || '')}</textarea></div>
                </div>`;
                html += `<div class="form-group"><label>解析</label>
                    <textarea id="edit-expl-${questionId}" rows="2" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">${escapeHtml(question.explanation || '')}</textarea></div>`;

                html += `<div style="display:flex;gap:8px;">
                    <button class="btn btn-success btn-sm" onclick="saveExamQuestion('${questionId}', ${isChoice})"><i class="fas fa-save"></i> 保存</button>
                    <button class="btn btn-outline btn-sm" onclick="refreshExam()"><i class="fas fa-times"></i> 取消</button>
                </div>`;
                html += `</div>`;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                alert('获取题目信息时发生错误！');
            }
        }

        async function saveExamQuestion(questionId, isChoice) {
            const data = {
                content: document.getElementById(`edit-content-${questionId}`).value,
                answer: document.getElementById(`edit-answer-${questionId}`).value,
                reference_answer: document.getElementById(`edit-ref-${questionId}`).value,
                explanation: document.getElementById(`edit-expl-${questionId}`).value,
            };
            if (isChoice) {
                data.options = [];
                for (let i = 0; i < 4; i++) {
                    const v = document.getElementById(`edit-opt${i}-${questionId}`).value;
                    if (v) data.options.push(v);
                }
            }

            try {
                const response = await fetch(`/api/questions/${questionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    alert('题目已更新！');
                    refreshExam();
                } else {
                    alert('更新失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('更新题目时发生错误！');
            }
        }

        async function refreshExam() {
            if (!currentExam) return;
            try {
                const response = await fetch(`/api/exams/${currentExam.exam_id}`);
                if (response.ok) {
                    currentExam = await response.json();
                    displayExam(currentExam);
                }
            } catch (e) {
                console.error('Error refreshing exam:', e);
            }
        }

        // ========== Replace question ==========
        let _replaceCandidates = [];      // subject-filtered candidates (drives the list)
        let _replaceAllCandidates = [];   // all candidates regardless of subject
        let _replaceCtx = {};

        async function openReplaceModal(examId, oldQuestionId, questionType) {
            try {
                // Fetch all same-type questions across all subjects
                const response = await fetch(`/api/questions?type=${encodeURIComponent(questionType)}`);
                if (!response.ok) { alert('获取候选题目失败！'); return; }
                const allQuestions = await response.json();

                const examQuestionIds = new Set(currentExam.questions.map(q => q.question_id));
                _replaceAllCandidates = allQuestions.filter(q => !q.is_used && !examQuestionIds.has(q.question_id));

                if (_replaceAllCandidates.length === 0) {
                    alert(`没有可用的 ${questionType} 替换题目（所有同类型题目已被使用或已在试卷中）`);
                    return;
                }

                // Infer default subject from current exam questions (first non-empty subject wins)
                const examSubject = (currentExam.questions.map(q => q.subject).find(s => s)) || '';

                // Collect all subjects available among candidates
                const subjectSet = new Set(_replaceAllCandidates.map(q => q.subject).filter(Boolean));

                _replaceCtx = { examId, oldQuestionId, questionType, examSubject };

                // Apply default subject filter
                _replaceCandidates = examSubject
                    ? _replaceAllCandidates.filter(q => q.subject === examSubject)
                    : _replaceAllCandidates;

                const container = document.getElementById(`exam-q-${oldQuestionId}`);
                if (!container) return;

                const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };

                let html = `<div class="form-container" style="margin:0; padding:15px;">`;
                html += `<h4 style="margin-bottom:10px;"><i class="fas fa-sync-alt"></i> 替换题目 — 选择一道 ${escapeHtml(questionType)} 题</h4>`;

                // Row 1: subject filter
                html += `<div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; align-items:center;">`;
                html += `<label style="font-size:0.9rem;color:#555;white-space:nowrap;">科目：</label>`;
                html += `<select id="replace-subject" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;" onchange="updateReplaceSubject()">`;
                if (examSubject) {
                    html += `<option value="${escapeHtml(examSubject)}" selected>${escapeHtml(examSubject)}（当前组卷科目）</option>`;
                }
                html += `<option value=""${!examSubject ? ' selected' : ''}>全部科目</option>`;
                subjectSet.forEach(s => {
                    if (s !== examSubject) html += `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`;
                });
                html += `</select>`;
                html += `<span id="replace-count-label" style="font-size:0.85em;color:#888;">共 ${_replaceCandidates.length} 道可用</span>`;
                html += `</div>`;

                // Row 2: keyword / difficulty / knowledge_point filters
                html += `<div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; align-items:center;">`;
                html += `<input type="text" id="replace-keyword" placeholder="搜索题目内容..." style="flex:1; min-width:180px; padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;" oninput="filterReplaceCandidates()">`;
                html += `<select id="replace-difficulty" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem;" onchange="filterReplaceCandidates()">`;
                html += `<option value="">全部难度</option>`;
                const initDiffSet = new Set(_replaceCandidates.map(q => q.difficulty).filter(Boolean));
                initDiffSet.forEach(d => { html += `<option value="${d}">${diffLabels[d] || d}</option>`; });
                html += `</select>`;
                html += `<select id="replace-knowledge-point" style="padding:6px 10px; border:1px solid #ddd; border-radius:var(--border-radius); font-size:0.9rem; max-width:200px;" onchange="filterReplaceCandidates()">`;
                html += `<option value="">全部知识点</option>`;
                const initKpSet = new Set(_replaceCandidates.map(q => q.knowledge_point).filter(Boolean));
                initKpSet.forEach(kp => { html += `<option value="${escapeHtml(kp)}">${escapeHtml(kp)}</option>`; });
                html += `</select>`;
                html += `</div>`;

                html += `<div id="replace-candidates-list" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; border-radius:6px; padding:10px; background:white;">`;
                html += buildReplaceCandidatesHtml(_replaceCandidates);
                html += `</div>`;
                html += `<div id="replace-no-result" style="display:none; padding:15px; text-align:center; color:#999;">没有匹配的候选题目</div>`;
                html += `<div style="margin-top:10px;">
                    <button class="btn btn-outline btn-sm" onclick="refreshExam()"><i class="fas fa-times"></i> 取消</button>
                </div>`;
                html += `</div>`;

                container.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                alert('获取候选题目时发生错误！');
            }
        }

        // Called when subject dropdown changes — re-filters candidates and rebuilds diff/kp dropdowns
        function updateReplaceSubject() {
            const subject = document.getElementById('replace-subject').value;
            _replaceCandidates = subject
                ? _replaceAllCandidates.filter(q => q.subject === subject)
                : _replaceAllCandidates;

            // Reset keyword filter
            const kwEl = document.getElementById('replace-keyword');
            if (kwEl) kwEl.value = '';

            // Rebuild difficulty dropdown
            const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };
            const diffSet = new Set(_replaceCandidates.map(q => q.difficulty).filter(Boolean));
            const diffSel = document.getElementById('replace-difficulty');
            if (diffSel) {
                diffSel.innerHTML = '<option value="">全部难度</option>';
                diffSet.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = diffLabels[d] || d;
                    diffSel.appendChild(opt);
                });
            }

            // Rebuild knowledge_point dropdown
            const kpSet = new Set(_replaceCandidates.map(q => q.knowledge_point).filter(Boolean));
            const kpSel = document.getElementById('replace-knowledge-point');
            if (kpSel) {
                kpSel.innerHTML = '<option value="">全部知识点</option>';
                kpSet.forEach(kp => {
                    const opt = document.createElement('option');
                    opt.value = kp;
                    opt.textContent = kp;
                    kpSel.appendChild(opt);
                });
            }

            // Update count label and render list
            const countLabel = document.getElementById('replace-count-label');
            if (countLabel) countLabel.textContent = `共 ${_replaceCandidates.length} 道可用`;

            const listEl = document.getElementById('replace-candidates-list');
            const noResult = document.getElementById('replace-no-result');
            if (_replaceCandidates.length === 0) {
                if (listEl) listEl.style.display = 'none';
                if (noResult) { noResult.style.display = 'block'; noResult.textContent = '该科目暂无可用候选题目'; }
            } else {
                if (listEl) { listEl.style.display = 'block'; listEl.innerHTML = buildReplaceCandidatesHtml(_replaceCandidates); }
                if (noResult) noResult.style.display = 'none';
            }
        }

        function buildReplaceCandidatesHtml(list) {
            const { examId, oldQuestionId } = _replaceCtx;
            const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };
            const diffColors = { easy: '#e8f5e9', medium: '#fff8e1', hard: '#ffebee' };
            let html = '';
            list.forEach(q => {
                html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; transition: background 0.2s;"
                    onmouseenter="this.style.background='#e3f2fd'" onmouseleave="this.style.background='white'"
                    onclick="doReplace('${examId}', '${oldQuestionId}', '${q.question_id}')">
                    <strong>${escapeHtml(stripHtml(q.content).substring(0, 80))}${stripHtml(q.content).length > 80 ? '...' : ''}</strong>`;
                // Meta tags row
                const tags = [];
                if (q.subject) tags.push(`<span style="background:#f3e5f5;padding:1px 6px;border-radius:3px;font-size:0.8em;">${escapeHtml(q.subject)}</span>`);
                if (q.difficulty) tags.push(`<span style="background:${diffColors[q.difficulty]||'#f5f5f5'};padding:1px 6px;border-radius:3px;font-size:0.8em;">${diffLabels[q.difficulty]||q.difficulty}</span>`);
                if (q.knowledge_point) tags.push(`<span style="background:#e3f2fd;padding:1px 6px;border-radius:3px;font-size:0.8em;">${escapeHtml(q.knowledge_point)}</span>`);
                if (q.answer) tags.push(`<span style="color:#666;font-size:0.8em;">答案: ${escapeHtml(q.answer)}</span>`);
                if (tags.length) html += `<div style="margin-top:4px;">${tags.join(' ')}</div>`;
                html += `</div>`;
            });
            return html;
        }

        function filterReplaceCandidates() {
            const keyword = (document.getElementById('replace-keyword').value || '').trim().toLowerCase();
            const difficulty = document.getElementById('replace-difficulty').value;
            const kp = document.getElementById('replace-knowledge-point').value;

            const filtered = _replaceCandidates.filter(q => {
                if (keyword && !q.content.toLowerCase().includes(keyword) && !(q.content_en && q.content_en.toLowerCase().includes(keyword))) return false;
                if (difficulty && q.difficulty !== difficulty) return false;
                if (kp && q.knowledge_point !== kp) return false;
                return true;
            });

            const listEl = document.getElementById('replace-candidates-list');
            const noResult = document.getElementById('replace-no-result');
            if (filtered.length === 0) {
                listEl.style.display = 'none';
                noResult.style.display = 'block';
                noResult.textContent = '没有匹配的候选题目';
            } else {
                listEl.style.display = 'block';
                noResult.style.display = 'none';
                listEl.innerHTML = buildReplaceCandidatesHtml(filtered);
            }
        }

        async function doReplace(examId, oldQuestionId, newQuestionId) {
            try {
                const response = await fetch(`/api/exams/${examId}/replace_question`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_question_id: oldQuestionId, new_question_id: newQuestionId })
                });

                if (response.ok) {
                    alert('题目替换成功！');
                    currentExam = await response.json();
                    displayExam(currentExam);
                } else {
                    const err = await response.json().catch(() => null);
                    alert('替换失败！' + (err && err.error ? '\n' + err.error : ''));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('替换题目时发生错误！');
            }
        }

        // ========== Confirm / Revert exam ==========
        async function confirmExam(examId) {
            try {
                const response = await fetch(`/api/exams/${examId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('试卷确认成功！题目已标记为已使用。');
                    document.getElementById('confirm-exam-btn').style.display = 'none';
                    document.getElementById('revert-exam-btn').style.display = 'inline-flex';
                } else {
                    alert('确认试卷失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('确认试卷时发生错误！');
            }
        }

        async function revertExamConfirmation(examId) {
            try {
                const response = await fetch(`/api/exams/${examId}/revert_confirmation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('试卷确认已撤销！题目已标记为未使用。');
                    document.getElementById('confirm-exam-btn').style.display = 'inline-flex';
                    document.getElementById('revert-exam-btn').style.display = 'none';
                } else {
                    alert('撤销确认失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('撤销确认时发生错误！');
            }
        }

        // ========== Question Type Management ==========
        function renderQuestionTypesTable() {
            const tbody = document.getElementById('types-tbody');
            tbody.innerHTML = '';
            questionTypesCache.forEach(qt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${qt.id}</td>
                    <td>${escapeHtml(qt.name)}</td>
                    <td>${escapeHtml(qt.label)}</td>
                    <td>${qt.has_options ? '是' : '否'}</td>
                    <td>${qt.is_builtin ? '内置' : '自定义'}</td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="editQuestionType(${qt.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${qt.is_builtin ? '' : `<button class="btn btn-danger btn-sm" onclick="deleteQuestionType(${qt.id})"><i class="fas fa-trash"></i></button>`}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        document.getElementById('add-type-btn').addEventListener('click', async () => {
            const name = document.getElementById('new-type-name').value.trim();
            const label = document.getElementById('new-type-label').value.trim();
            const hasOptions = document.getElementById('new-type-options').value === 'true';

            if (!name) { alert('请输入题型标识！'); return; }

            try {
                const response = await fetch('/api/question-types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, label: label || name, has_options: hasOptions })
                });
                if (response.ok) {
                    alert('题型添加成功！');
                    document.getElementById('new-type-name').value = '';
                    document.getElementById('new-type-label').value = '';
                    document.getElementById('new-type-options').value = 'false';
                    await loadQuestionTypes();
                    renderQuestionTypesTable();
                } else {
                    const err = await response.json();
                    alert('添加失败：' + (err.error || '未知错误'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('添加题型时发生错误！');
            }
        });

        async function editQuestionType(typeId) {
            const qt = questionTypesCache.find(t => t.id === typeId);
            if (!qt) return;
            const newLabel = prompt('修改显示名称：', qt.label);
            if (newLabel === null) return;

            try {
                const response = await fetch(`/api/question-types/${typeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label: newLabel })
                });
                if (response.ok) {
                    await loadQuestionTypes();
                    renderQuestionTypesTable();
                } else {
                    const err = await response.json();
                    alert('修改失败：' + (err.error || '未知错误'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('修改题型时发生错误！');
            }
        }

        async function deleteQuestionType(typeId) {
            if (!confirm('确定要删除这个题型吗？')) return;
            try {
                const response = await fetch(`/api/question-types/${typeId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('题型删除成功！');
                    await loadQuestionTypes();
                    renderQuestionTypesTable();
                } else {
                    const err = await response.json();
                    alert('删除失败：' + (err.error || '未知错误'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('删除题型时发生错误！');
            }
        }

        // ========== Usage Management ==========
        let usedQuestionsData = [];
        let selectedUsageIds = new Set();

        async function loadUsedQuestions() {
            try {
                const dateFrom = document.getElementById('usage-date-from').value;
                const dateTo = document.getElementById('usage-date-to').value;
                const typeFilter = document.getElementById('usage-type-filter').value;

                let url = '/api/questions?is_used=1';
                if (typeFilter) url += `&type=${encodeURIComponent(typeFilter)}`;

                const response = await fetch(url);
                if (!response.ok) { alert('获取已使用题目失败！'); return; }
                let questions = await response.json();

                // Client-side date filtering
                if (dateFrom) {
                    const from = new Date(dateFrom);
                    from.setHours(0, 0, 0, 0);
                    questions = questions.filter(q => q.used_date && new Date(q.used_date) >= from);
                }
                if (dateTo) {
                    const to = new Date(dateTo);
                    to.setHours(23, 59, 59, 999);
                    questions = questions.filter(q => q.used_date && new Date(q.used_date) <= to);
                }

                // Sort by used_date descending
                questions.sort((a, b) => {
                    if (!a.used_date) return 1;
                    if (!b.used_date) return -1;
                    return new Date(b.used_date) - new Date(a.used_date);
                });

                usedQuestionsData = questions;
                selectedUsageIds.clear();
                document.getElementById('usage-select-all').checked = false;
                renderUsageTable();
                renderUsageSummary();
                updateUsageBatchBar();

                // Populate type filter from cache
                const sel = document.getElementById('usage-type-filter');
                const curVal = sel.value;
                sel.innerHTML = '<option value="">全部题型</option>';
                questionTypesCache.forEach(qt => {
                    const opt = document.createElement('option');
                    opt.value = qt.name;
                    opt.textContent = qt.label;
                    sel.appendChild(opt);
                });
                sel.value = curVal;
            } catch (error) {
                console.error('Error:', error);
                alert('加载使用记录时发生错误！');
            }
        }

        function renderUsageSummary() {
            const el = document.getElementById('usage-summary');
            if (usedQuestionsData.length === 0) {
                el.style.display = 'none';
                return;
            }
            // Group by date
            const dateMap = {};
            const typeMap = {};
            usedQuestionsData.forEach(q => {
                const dateStr = q.used_date ? q.used_date.substring(0, 10) : '未知日期';
                dateMap[dateStr] = (dateMap[dateStr] || 0) + 1;
                typeMap[q.question_type] = (typeMap[q.question_type] || 0) + 1;
            });

            let html = `<strong>共 ${usedQuestionsData.length} 道已使用题目</strong>`;
            html += `<span style="margin-left:20px;">`;
            html += Object.entries(typeMap).map(([t, c]) => `${t}: ${c}题`).join('，');
            html += `</span>`;

            const dates = Object.keys(dateMap).sort().reverse();
            if (dates.length > 0) {
                html += `<div style="margin-top:6px; font-size:0.9em; color:#666;">使用日期分布：`;
                html += dates.map(d => `${d}(${dateMap[d]}题)`).join('、');
                html += `</div>`;
            }

            el.innerHTML = html;
            el.style.display = 'block';
        }

        function renderUsageTable() {
            const tbody = document.getElementById('usage-tbody');
            const emptyEl = document.getElementById('usage-empty');
            const tableEl = document.getElementById('usage-table');
            const diffLabels = { easy: '简单', medium: '中等', hard: '困难' };

            if (usedQuestionsData.length === 0) {
                tbody.innerHTML = '';
                tableEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            tableEl.style.display = 'table';
            emptyEl.style.display = 'none';

            tbody.innerHTML = '';
            usedQuestionsData.forEach(q => {
                const tr = document.createElement('tr');
                const dateStr = q.used_date ? q.used_date.substring(0, 10) : '-';
                const diffText = q.difficulty ? (diffLabels[q.difficulty] || q.difficulty) : '-';
                tr.innerHTML = `
                    <td><input type="checkbox" class="usage-cb" data-id="${q.question_id}" ${selectedUsageIds.has(q.question_id) ? 'checked' : ''}></td>
                    <td title="${q.question_id}">${q.question_id.substring(0, 8)}...</td>
                    <td>${q.question_type}</td>
                    <td title="${escapeHtml(stripHtml(q.content))}">${escapeHtml(stripHtml(q.content).substring(0, 50))}${stripHtml(q.content).length > 50 ? '...' : ''}</td>
                    <td>${diffText}</td>
                    <td>${dateStr}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="releaseSingle('${q.question_id}')">
                            <i class="fas fa-unlock"></i> 释放
                        </button>
                    </td>`;
                tbody.appendChild(tr);
            });

            // Bind checkbox events
            tbody.querySelectorAll('.usage-cb').forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) selectedUsageIds.add(cb.dataset.id);
                    else selectedUsageIds.delete(cb.dataset.id);
                    updateUsageBatchBar();
                });
            });
        }

        document.getElementById('usage-select-all').addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('.usage-cb').forEach(cb => {
                cb.checked = checked;
                if (checked) selectedUsageIds.add(cb.dataset.id);
                else selectedUsageIds.delete(cb.dataset.id);
            });
            updateUsageBatchBar();
        });

        function updateUsageBatchBar() {
            const bar = document.getElementById('usage-batch-bar');
            const count = selectedUsageIds.size;
            document.getElementById('usage-batch-count').textContent = count;
            bar.style.display = (count > 0 || usedQuestionsData.length > 0) ? 'flex' : 'none';
            document.getElementById('usage-release-btn').disabled = count === 0;
        }

        document.getElementById('usage-release-btn').addEventListener('click', async () => {
            if (selectedUsageIds.size === 0) return;
            if (!confirm(`确定要释放选中的 ${selectedUsageIds.size} 道题目吗？释放后可重新参与组卷。`)) return;
            await doRelease(Array.from(selectedUsageIds));
        });

        document.getElementById('usage-release-all-btn').addEventListener('click', async () => {
            if (usedQuestionsData.length === 0) return;
            if (!confirm(`确定要释放当前筛选结果中的全部 ${usedQuestionsData.length} 道题目吗？`)) return;
            await doRelease(usedQuestionsData.map(q => q.question_id));
        });

        async function doRelease(questionIds) {
            try {
                const response = await fetch('/api/questions/batch-release', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: questionIds })
                });
                if (response.ok) {
                    const result = await response.json();
                    alert(`成功释放 ${result.released_count} 道题目！`);
                    loadUsedQuestions();
                } else {
                    const err = await response.json().catch(() => null);
                    alert('释放失败！' + (err?.error || ''));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('释放题目时发生错误！');
            }
        }

        async function releaseSingle(questionId) {
            if (!confirm('确定要释放这道题目吗？')) return;
            await doRelease([questionId]);
        }

        function clearUsageFilters() {
            document.getElementById('usage-date-from').value = '';
            document.getElementById('usage-date-to').value = '';
            document.getElementById('usage-type-filter').value = '';
            loadUsedQuestions();
        }

        // ========== Course Settings ==========
        async function loadCourseSettings() {
            try {
                const response = await fetch('/api/course-settings');
                if (!response.ok) return;
                const settings = await response.json();
                applyCourseSettings(settings);
                fillSettingsForm(settings);
            } catch (error) {
                console.error('Error loading course settings:', error);
            }
        }

        function applyCourseSettings(settings) {
            const titleEl = document.getElementById('site-title');
            const subtitleEl = document.getElementById('site-subtitle');

            if (settings.course_name) {
                const titleText = `${settings.course_name} 试题管理系统`;
                titleEl.innerHTML = `<i class="fas fa-graduation-cap"></i> ${escapeHtml(titleText)}`;
                document.title = titleText;
            } else {
                titleEl.innerHTML = '<i class="fas fa-graduation-cap"></i> 试题管理系统';
                document.title = '试题管理系统';
            }

            const infoParts = [];
            if (settings.course_code) infoParts.push(`课程代号: ${settings.course_code}`);
            if (settings.exam_format) infoParts.push(`考试形式: ${settings.exam_format}`);
            if (settings.exam_method) infoParts.push(`考试方式: ${settings.exam_method}`);
            if (settings.target_audience) infoParts.push(`使用对象: ${settings.target_audience}`);

            if (infoParts.length > 0) {
                subtitleEl.textContent = infoParts.join(' | ');
            } else {
                subtitleEl.textContent = '高效管理试题，智能生成试卷';
            }
        }

        function fillSettingsForm(settings) {
            document.getElementById('settings-institution-name').value = settings.institution_name || '';
            document.getElementById('settings-semester-info').value = settings.semester_info || '';
            document.getElementById('settings-exam-title').value = settings.exam_title || '';
            document.getElementById('settings-paper-label').value = settings.paper_label || '';
            document.getElementById('settings-course-name').value = settings.course_name || '';
            document.getElementById('settings-course-code').value = settings.course_code || '';
            document.getElementById('settings-exam-format').value = settings.exam_format || '';
            document.getElementById('settings-exam-method').value = settings.exam_method || '';
            document.getElementById('settings-target-audience').value = settings.target_audience || '';
        }

        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            const data = {
                institution_name: document.getElementById('settings-institution-name').value.trim(),
                semester_info: document.getElementById('settings-semester-info').value.trim(),
                exam_title: document.getElementById('settings-exam-title').value.trim(),
                paper_label: document.getElementById('settings-paper-label').value.trim(),
                course_name: document.getElementById('settings-course-name').value.trim(),
                course_code: document.getElementById('settings-course-code').value.trim(),
                exam_format: document.getElementById('settings-exam-format').value,
                exam_method: document.getElementById('settings-exam-method').value,
                target_audience: document.getElementById('settings-target-audience').value.trim(),
            };

            try {
                const response = await fetch('/api/course-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const settings = await response.json();
                    applyCourseSettings(settings);
                    alert('设置保存成功！');
                } else {
                    alert('保存设置失败！');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('保存设置时发生错误！');
            }
        });

        // ========== Subject management ==========
        async function loadSubjects() {
            try {
                const response = await fetch('/api/questions/subjects');
                if (!response.ok) return;
                const subjects = await response.json();

                // Populate search subject dropdown
                const searchSubjectSel = document.getElementById('search-subject');
                const currentSearchVal = searchSubjectSel.value;
                searchSubjectSel.innerHTML = '<option value="">所有科目</option>';
                subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    searchSubjectSel.appendChild(opt);
                });
                if (currentSearchVal) searchSubjectSel.value = currentSearchVal;

                // Populate exam subject filter dropdown
                const examSubjectSel = document.getElementById('exam-subject-filter');
                const currentExamVal = examSubjectSel.value;
                examSubjectSel.innerHTML = '<option value="">不限科目（所有题目）</option>';
                subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    examSubjectSel.appendChild(opt);
                });
                if (currentExamVal) examSubjectSel.value = currentExamVal;

                // Populate datalists (form and import)
                ['subject-datalist-form', 'subject-datalist-import'].forEach(dlId => {
                    const dl = document.getElementById(dlId);
                    if (!dl) return;
                    dl.innerHTML = '';
                    subjects.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        dl.appendChild(opt);
                    });
                });
            } catch (e) {
                console.error('Error loading subjects:', e);
            }
        }

        // ========== AI Prompts ==========
        const AI_PROMPTS = {
            zh: `你是一位专业的教学内容设计专家，擅长根据课程材料出题。

请仔细阅读我上传的文件（PPT/PDF），全面理解其中的知识点、概念、原理和案例，然后按照以下要求生成一套完整题库。

### 出题要求

**题型与数量：**
- 单选题：15题（每题4个选项A/B/C/D，只有1个正确答案）
- 多选题：8题（每题4个选项A/B/C/D，有2～4个正确答案）
- 是非题：10题（判断正误，答案为"正确"或"错误"）
- 简答题：5题（需提供参考答案）
- 论述题：3题（需提供较详细的参考答案）
- 材料分析题：2题（结合实际案例或材料进行分析）

**质量要求：**
1. 题目内容必须忠实于文件中的知识点，不得编造文件中没有的内容
2. 在每种题型中，题目难度分布约为：简单(easy) 30%、中等(medium) 50%、困难(hard) 20%，三个难度的出题标准如下：
   - **简单(easy)**：答案可以直接在上传材料的原文中找到，考查对定义、概念、步骤等基础内容的识记与理解；是非题和单选题以简单题为主
   - **中等(medium)**：需要结合具体实例或现实应用场景作答，不能仅靠背诵原文，要求学生能将概念迁移到新情境中；典型形式如"举例说明……""分析某案例""比较两种做法的异同"，或在选择、判断题中设计与现实结合的选项
   - **困难(hard)**：需要综合运用多个知识点，跨章节融会贯通，要求学生对知识体系有整体把握；典型形式如"比较多种理论/方法的适用条件""论述某问题的完整解决路径""对给定材料进行批判性分析"；论述题和材料分析题以困难题为主
3. 覆盖文件中的主要章节和核心概念
4. 每道题必须标注对应的知识点（知识点从文件中提取，放在解析里）
5. 选择题的干扰项要合理，不能过于明显
6. 简答题和论述题的参考答案要完整、准确；困难题的参考答案需体现跨知识点的整合与推理过程
7. **题目必须独立成立**，严禁在题干中出现任何引用上传文件位置或呈现方式的表述，例如"如第X章所述""见PPT第X张幻灯片""根据上图""如材料图表所示""结合上文"等——考生在考试时只能看到题目本身，无法看到你所参考的PPT或PDF文件

**输出格式（必须严格遵守）：**

⚠️ **导入格式关键要素（写错会导致题目无法导入）：**
- **所有括号和尖括号必须是半角字符**：\`[\` \`]\` \`<\` \`>\`，不能用全角 \`【】\`、\`（）\`、\`＜＞\`
- **题型名称必须与系统题型完全一致**，层级题型用 \`>\` 分隔且两侧无空格，如 \`[简答>材料分析]\`
- **选择题答案**：紧跟题型，必须大写字母，如 \`[单选][A]\`、\`[多选][ABD]\`；不能小写
- **是非题答案**：只能写 \`[正确]\` 或 \`[错误]\`，不能用"是/对/T"等替代
- **选项行必须顶格写**，行首不能有任何空格：\`[A]选项内容\`（正确）、\` [A]选项内容\`（错误）
- **英文选项格式**：\`[A_en]Option text\`，下划线和 \`en\` 必须小写，只能单个大写字母
- **\`<参考答案>\` 和 \`<解析>\` 标签必须成对出现**，并用 \`</参考答案>\` 和 \`</解析>\` 闭合
- **知识点/标签/难度/英文题目字段必须写在 \`<解析>\` 块内**，写在块外会被当作题目内容
- **难度只能写** \`easy\`、\`medium\` 或 \`hard\`（全小写英文），不能写中文

---
**单选题格式：**
[单选][正确选项字母]
题目内容？
[A]选项A内容
[B]选项B内容
[C]选项C内容
[D]选项D内容
<解析>
解析说明（为什么选这个答案）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>

---
**多选题格式：**
[多选][正确选项字母组合，如ABD]
题目内容？
[A]选项A内容
[B]选项B内容
[C]选项C内容
[D]选项D内容
<解析>
解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>

---
**是非题格式：**
[是非][正确|错误]
题目陈述句。
<解析>
解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>

---
**简答题格式：**
[简答]
题目内容？
<参考答案>
参考答案内容（要点1；要点2；要点3……）
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>

---
**论述题格式：**
[简答>论述]
题目内容？
<参考答案>
详细的参考答案，分点论述，逻辑清晰。
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:hard
</解析>

---
**材料分析题格式：**
[简答>材料分析]
【材料】
材料内容（一段与课程相关的实际案例、数据或文字材料）

【问题】
基于以上材料，请分析……？
<参考答案>
参考答案（结合材料和理论进行分析）
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:hard
</解析>

---

### 格式注意事项

1. 题型标识符必须用方括号包围，如 [单选]、[多选]、[是非]、[简答]、[简答>论述]、[简答>材料分析]
2. 选择题答案紧跟题型标识后，用方括号包围，如 [单选][A]、[多选][ABD]
3. 是非题答案只能是 [正确] 或 [错误]，无需列选项
4. 选项格式：[A]内容、[B]内容，字母大写
5. <解析>...</解析> 中的元数据行格式固定，冒号后不加空格，字段名不可更改
6. 难度值只能是：easy、medium、hard 三选一，必须用英文小写
7. 每道题之间可以有空行，便于阅读
8. 不要添加题号（系统会自动编号）
9. 不要在题目外添加任何说明性文字、章节标题或分割线
10. 不要使用 \`*\`、\`**\`、\`#\` 等 Markdown 格式符号，不要对文字加粗，不要添加标题标记

现在请开始出题，直接输出题目内容，不需要任何前言。`,

            bilingual: `你是一位专业的双语教学内容设计专家，擅长设计中英双语课程题库。

请仔细阅读我上传的文件（PPT/PDF），全面理解其中的知识点，然后按照以下要求生成一套完整的中英双语题库。

### 出题要求

**题型与数量：**
- 单选题：15题（每题4个选项，只有1个正确答案）
- 多选题：8题（每题4个选项，有2～4个正确答案）
- 是非题：10题（判断正误）
- 简答题：5题
- 论述题：3题
- 材料分析题：2题

**质量要求：**
1. 题目内容必须忠实于文件中的知识点，不得编造
2. 题目难度分布约为：简单(easy) 30%、中等(medium) 50%、困难(hard) 20%，三个难度的出题标准如下：
   - **简单(easy)**：答案可以直接在上传材料的原文中找到，考查对定义、概念、步骤等基础内容的识记与理解；是非题和单选题以简单题为主
   - **中等(medium)**：需要结合具体实例或现实应用场景作答，不能仅靠背诵原文，要求学生能将概念迁移到新情境中；典型形式如"举例说明……""分析某案例""比较两种做法的异同"
   - **困难(hard)**：需要综合运用多个知识点，跨章节融会贯通，要求学生对知识体系有整体把握；典型形式如"比较多种理论/方法的适用条件""论述某问题的完整解决路径""对给定材料进行批判性分析"；论述题和材料分析题以困难题为主
3. 覆盖文件中的主要章节和核心概念
4. 每道题必须同时提供中文和英文版本，语义完全对应，英文表达符合学术规范
5. 选择题的中英文选项必须一一对应，顺序和含义完全一致
6. 简答题和论述题的参考答案要完整、准确；困难题的参考答案需体现跨知识点的整合与推理过程
7. **题目必须独立成立**，严禁在题干中出现任何引用上传文件位置或呈现方式的表述，例如"如第X章所述""见PPT第X张幻灯片""根据上图""如材料图表所示""结合上文"等——考生在考试时只能看到题目本身，无法看到你所参考的PPT或PDF文件

**双语输出格式（必须严格遵守）：**

⚠️ **导入格式关键要素（写错会导致题目无法导入）：**
- **所有括号和尖括号必须是半角字符**：\`[\` \`]\` \`<\` \`>\`，不能用全角 \`【】\`、\`（）\`、\`＜＞\`
- **题型名称必须与系统题型完全一致**，层级题型用 \`>\` 分隔且两侧无空格，如 \`[简答>材料分析]\`
- **选择题答案**：紧跟题型，必须大写字母，如 \`[单选][A]\`、\`[多选][ABD]\`；不能小写
- **是非题答案**：只能写 \`[正确]\` 或 \`[错误]\`，不能用"是/对/T"等替代
- **选项行必须顶格写**，行首不能有任何空格：\`[A]选项内容\`（正确）、\` [A]选项内容\`（错误）
- **英文选项格式**：\`[A_en]Option text\`，下划线和 \`en\` 必须小写，只能单个大写字母
- **\`<参考答案>\` 和 \`<解析>\` 标签必须成对出现**，并用 \`</参考答案>\` 和 \`</解析>\` 闭合
- **知识点/标签/难度/英文题目字段必须写在 \`<解析>\` 块内**，写在块外会被当作题目内容
- **难度只能写** \`easy\`、\`medium\` 或 \`hard\`（全小写英文），不能写中文

---
**双语单选题格式：**
[单选][正确选项字母]
中文题目内容？
[A]中文选项A
[B]中文选项B
[C]中文选项C
[D]中文选项D
[A_en]English option A
[B_en]English option B
[C_en]English option C
[D_en]English option D
<解析>
中文解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>

---
**双语多选题格式：**
[多选][正确选项字母组合，如ABD]
中文题目内容？
[A]中文选项A
[B]中文选项B
[C]中文选项C
[D]中文选项D
[A_en]English option A
[B_en]English option B
[C_en]English option C
[D_en]English option D
<解析>
中文解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>

---
**双语是非题格式：**
[是非][正确|错误]
中文题目陈述句。
<解析>
中文解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the statement.
难度:easy|medium|hard
</解析>

---
**双语简答题格式：**
[简答]
中文题目内容？
<参考答案>
中文参考答案（要点1；要点2；要点3……）
</参考答案>
<解析>
中文解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>

---
**双语论述题格式：**
[简答>论述]
中文题目内容？
<参考答案>
中文参考答案，分点论述，逻辑清晰。
</参考答案>
<解析>
中文解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:hard
</解析>

---
**双语材料分析题格式：**
[简答>材料分析]
【材料】
材料内容（中文）

【问题】
中文问题？
<参考答案>
中文参考答案
</参考答案>
<解析>
中文解析（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:【Material】English material content. 【Question】English question?
难度:hard
</解析>

---

### 双语格式关键规则

1. **选择题选项顺序**：先列全部4个中文选项 [A][B][C][D]，再列全部4个英文选项 [A_en][B_en][C_en][D_en]，英文选项必须与对应中文选项语义一致，字母编号对应
2. **英文题目字段**：所有题型均在 <解析> 区段内写一行 \`英文题目:\` 提供英文题干，是非题、简答题等非选择题同样需要此字段
3. **材料分析题英文**：在 \`英文题目:\` 字段内将材料和问题合并写出，用 【Material】/【Question】 分隔
4. **题型标识符**：始终使用中文标识符 [单选]、[多选]、[是非]、[简答] 等，不要改为英文
5. **答案格式**：选择题答案字母 [A]～[D]、是非题答案 [正确]/[错误] 均保持不变
6. **冒号格式**：\`英文题目:\` 使用英文半角冒号，\`英文题目:\` 之后直接跟英文内容，不加空格
7. **解析语言**：<解析> 内的中文解析文字可以用中文，但字段名（知识点、标签、英文题目、难度）格式不变
8. 不要添加题号，不要在题目外添加任何说明文字
9. 不要使用 \`*\`、\`**\`、\`#\` 等 Markdown 格式符号，不要对文字加粗，不要添加标题标记

现在请开始出题，直接输出题目内容，不需要任何前言。`,

            en: `You are a professional academic content designer specializing in creating exam questions.

Please carefully read the uploaded file (PPT/PDF), fully understand all knowledge points, concepts, principles and cases, then generate a complete question bank following the requirements below.

### Question Requirements

**Types and quantities:**
- Single-choice questions: 15 (4 options A/B/C/D, only 1 correct answer)
- Multiple-choice questions: 8 (4 options A/B/C/D, 2~4 correct answers)
- True/False questions: 10 (answer: True or False)
- Short answer questions: 5 (provide reference answers)
- Essay questions: 3 (provide detailed reference answers)
- Case analysis questions: 2 (analysis based on real cases or materials)

**Quality requirements:**
1. Content must be faithfully based on the knowledge points in the file; do not fabricate content
2. Difficulty distribution: approximately 30% easy, 50% medium, 20% hard. Apply the following criteria for each level:
   - **Easy**: The answer can be found directly in the original text of the uploaded material. Tests recall and comprehension of definitions, concepts, and procedures. True/False and single-choice questions should be mostly easy.
   - **Medium**: Requires combining course concepts with concrete examples or real-world application scenarios. Students cannot rely on rote memorization alone — they must transfer concepts to new contexts. Typical forms: "Give an example of…", "Analyze a given case", "Compare two approaches".
   - **Hard**: Requires integrating multiple knowledge points across chapters and demonstrating a holistic understanding of the subject. Typical forms: "Compare the applicability of multiple theories/methods", "Describe a complete solution path for a problem", "Critically analyze a given scenario". Essay and case analysis questions should be mostly hard.
3. Cover major chapters and core concepts from the file
4. Each question must include the corresponding knowledge point (from chapter/section titles)
5. Distractors for choice questions must be plausible, not obviously wrong
6. Reference answers for short answer and essay questions must be complete and accurate; hard question answers should explicitly show cross-topic integration and reasoning
7. **Every question must be self-contained.** Do not include any references to the source material's location or presentation, such as "as discussed in Chapter X", "refer to slide Y", "as shown in the figure above", "according to the passage", or "based on the chart" — students taking the exam can only see the questions themselves, not the PPT or PDF file you are reading

**Output format (must follow strictly):**

⚠️ **Critical format requirements (errors will cause import failure):**
- **All brackets and angle brackets must be ASCII (half-width)**: \`[\` \`]\` \`<\` \`>\` — never use full-width variants \`【】\` \`（）\` \`＜＞\`
- **Question type must exactly match a registered system type**; hierarchical types use \`>\` with no spaces, e.g. \`[简答>材料分析]\`
- **Choice answer**: right after the type tag, uppercase letters only — \`[单选][A]\`, \`[多选][ABD]\`; never lowercase
- **True/False answer**: only \`[正确]\` or \`[错误]\` — no substitutes like "True/False/T/F"
- **Option lines must be flush-left** with no leading spaces: \`[A]Option text\` ✓ vs \` [A]Option text\` ✗
- **English option format**: \`[A_en]Option text\` — underscore and \`en\` must be lowercase, single uppercase letter only
- **\`<参考答案>\` and \`<解析>\` tags must appear in matching pairs**, closed with \`</参考答案>\` and \`</解析>\`
- **Metadata fields** (知识点/标签/难度) **must be inside the \`<解析>\` block** — if placed outside, they will be treated as question content
- **Difficulty must be** \`easy\`, \`medium\`, or \`hard\` (lowercase English only)

---
**Single-choice format:**
[单选][Correct option letter]
Question content in English?
[A]Option A
[B]Option B
[C]Option C
[D]Option D
[A_en]Option A (same text repeated for bilingual storage)
[B_en]Option B
[C_en]Option C
[D_en]Option D
<解析>
Explanation in English.
知识点:Knowledge point name (can be in English)
标签:tag1,tag2
英文题目:Question content in English? (same as above)
难度:easy|medium|hard
</解析>

---
**Multiple-choice format:**
[多选][Correct letters combined, e.g. ABD]
Question content in English?
[A]Option A
[B]Option B
[C]Option C
[D]Option D
[A_en]Option A
[B_en]Option B
[C_en]Option C
[D_en]Option D
<解析>
Explanation in English.
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question content in English?
难度:easy|medium|hard
</解析>

---
**True/False format:**
[是非][正确|错误]
Statement in English.
<解析>
Explanation in English.
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Statement in English. (same as above)
难度:easy|medium|hard
</解析>

---
**Short answer format:**
[简答]
Question in English?
<参考答案>
Reference answer in English (point 1; point 2; point 3...)
</参考答案>
<解析>
Explanation (optional).
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question in English?
难度:easy|medium|hard
</解析>

---
**Essay format:**
[简答>论述]
Question in English?
<参考答案>
Detailed reference answer in English, logically structured.
</参考答案>
<解析>
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question in English?
难度:hard
</解析>

---
**Case analysis format:**
[简答>材料分析]
[Case]
Case material content in English.

[Question]
Based on the above case, analyze...?
<参考答案>
Reference answer in English, integrating theory and case.
</参考答案>
<解析>
知识点:Knowledge point name
标签:tag1,tag2
英文题目:[Case] Case material. [Question] Question in English?
难度:hard
</解析>

---

### Format rules

1. **Question type markers**: Keep Chinese markers [单选], [多选], [是非], [简答], [简答>论述], [简答>材料分析] — these are system codes, do NOT translate them
2. **Answer markers**: Keep [A]~[D] for choices; use [正确] for True, [错误] for False — do NOT change these
3. **Metadata field names**: Keep Chinese field names 知识点, 标签, 英文题目, 难度 exactly as shown — do NOT translate them
4. **For single-choice/multiple-choice**: List all Chinese-slot options [A]~[D] first (with English text), then repeat the same options as [A_en]~[D_en]. This stores the English text in both the options and bilingual options fields.
5. **英文题目 field**: Fill in the same English question text — this enables bilingual export from the system
6. **Difficulty**: Must be one of: easy, medium, hard (lowercase English)
7. Do not add question numbers; do not add any explanatory text outside question blocks
8. Do not use Markdown formatting characters such as \`*\`, \`**\`, or \`#\`; do not bold text or add heading markers

Now please start generating questions. Output question content directly without any preamble.`
        };

        // State: extracted text from uploaded review notes file
        let _reviewNotesText = '';

        /**
         * Build the AI prompt for the given mode, optionally embedding review notes.
         * When notesText is provided the "read the uploaded file" instruction is
         * replaced with the actual notes content so users can skip uploading to the AI.
         */
        function buildPromptWithNotes(mode, notesText) {
            if (!notesText) return AI_PROMPTS[mode];

            if (mode === 'zh') {
                const oldIntro = '请仔细阅读我上传的文件（PPT/PDF），全面理解其中的知识点、概念、原理和案例，然后按照以下要求生成一套完整题库。';
                const newBlock =
                    '以下是本课程的复习要点，请仔细阅读并以这些知识点为核心进行出题，确保每个重要知识点均有题目覆盖。\n\n' +
                    '=== 复习要点 ===\n' + notesText + '\n=== 复习要点结束 ===\n\n' +
                    '请根据以上复习要点，全面理解其中的知识点、概念、原理和案例，然后按照以下要求生成一套完整题库。';
                return AI_PROMPTS[mode].replace(oldIntro, newBlock);
            }

            if (mode === 'bilingual') {
                const oldIntro = '请仔细阅读我上传的文件（PPT/PDF），全面理解其中的知识点，然后按照以下要求生成一套完整的中英双语题库。';
                const newBlock =
                    '以下是本课程的复习要点，请仔细阅读并以这些知识点为核心进行出题，确保每个重要知识点均有题目覆盖。\n\n' +
                    '=== 复习要点 ===\n' + notesText + '\n=== 复习要点结束 ===\n\n' +
                    '请根据以上复习要点，全面理解其中的知识点，然后按照以下要求生成一套完整的中英双语题库。';
                return AI_PROMPTS[mode].replace(oldIntro, newBlock);
            }

            if (mode === 'en') {
                const oldIntro = 'Please carefully read the uploaded file (PPT/PDF), fully understand all knowledge points, concepts, principles and cases, then generate a complete question bank following the requirements below.';
                const newBlock =
                    'The following are the key review points for this course. Please carefully read them and base your questions on these knowledge points, ensuring all listed topics are covered.\n\n' +
                    '=== Key Review Points ===\n' + notesText + '\n=== End of Review Points ===\n\n' +
                    'Please carefully read the above review points, fully understand all knowledge points, concepts, principles and cases, then generate a complete question bank following the requirements below.';
                return AI_PROMPTS[mode].replace(oldIntro, newBlock);
            }

            return AI_PROMPTS[mode];
        }

        function updatePromptDisplay() {
            const mode = document.getElementById('prompt-mode-select').value;
            document.getElementById('prompt-display').value = buildPromptWithNotes(mode, _reviewNotesText);
        }

        document.getElementById('prompt-mode-select').addEventListener('change', updatePromptDisplay);
        updatePromptDisplay();

        document.getElementById('copy-prompt-btn').addEventListener('click', () => {
            const ta = document.getElementById('prompt-display');
            navigator.clipboard.writeText(ta.value).then(() => {
                const btn = document.getElementById('copy-prompt-btn');
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> 复制提示词'; }, 2000);
            }).catch(() => {
                ta.select();
                document.execCommand('copy');
                const btn = document.getElementById('copy-prompt-btn');
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i> 复制提示词'; }, 2000);
            });
        });

        // ========== Review Notes Upload ==========
        document.getElementById('gen-prompt-with-notes-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('review-notes-file');
            const statusEl = document.getElementById('review-notes-status');
            const clearBtn = document.getElementById('clear-review-notes-btn');

            if (!fileInput.files || !fileInput.files[0]) {
                statusEl.style.color = '#c92a2a';
                statusEl.textContent = '请先选择复习要点文件（.docx 或 .txt）。';
                return;
            }

            const btn = document.getElementById('gen-prompt-with-notes-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 解析中…';
            statusEl.style.color = '#868e96';
            statusEl.textContent = '正在解析文件内容…';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const resp = await fetch('/api/parse-review-notes', { method: 'POST', body: formData });
                const data = await resp.json();
                if (!resp.ok) {
                    statusEl.style.color = '#c92a2a';
                    statusEl.textContent = `解析失败：${data.error || '未知错误'}`;
                    return;
                }
                _reviewNotesText = data.text;
                updatePromptDisplay();
                statusEl.style.color = '#2f9e44';
                statusEl.textContent = `✓ 复习要点已嵌入提示词（${data.text.length} 字符）。切换出题模式时提示词自动更新。`;
                clearBtn.style.display = '';
            } catch (e) {
                statusEl.style.color = '#c92a2a';
                statusEl.textContent = `请求失败：${e.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> 生成含复习要点的提示词';
            }
        });

        document.getElementById('clear-review-notes-btn').addEventListener('click', () => {
            _reviewNotesText = '';
            document.getElementById('review-notes-file').value = '';
            document.getElementById('review-notes-status').textContent = '';
            document.getElementById('clear-review-notes-btn').style.display = 'none';
            updatePromptDisplay();
        });

        // ========== Quill Rich Text Editors ==========
        function makeQuillEditor(containerId) {
            const quill = new Quill(containerId, {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            ['image'],
                            ['clean']
                        ],
                        handlers: {
                            image: function () {
                                const input = document.createElement('input');
                                input.setAttribute('type', 'file');
                                input.setAttribute('accept', 'image/*');
                                input.click();
                                input.onchange = async () => {
                                    const file = input.files[0];
                                    if (!file) return;
                                    const fd = new FormData();
                                    fd.append('file', file);
                                    try {
                                        const resp = await fetch('/api/images/upload', { method: 'POST', body: fd });
                                        if (resp.ok) {
                                            const data = await resp.json();
                                            const range = quill.getSelection(true);
                                            quill.insertEmbed(range.index, 'image', data.url, 'user');
                                        } else {
                                            alert('图片上传失败');
                                        }
                                    } catch (e) {
                                        alert('图片上传出错：' + e.message);
                                    }
                                };
                            }
                        }
                    }
                }
            });
            return quill;
        }

        const quillContent     = makeQuillEditor('#quill-content');
        const quillReference   = makeQuillEditor('#quill-reference');
        const quillExplanation = makeQuillEditor('#quill-explanation');

        // ========== Initialization ==========
        window.addEventListener('DOMContentLoaded', async () => {
            await loadQuestionTypes();
            await loadSubjects();
            renderDefaultExamConfig();
            loadQuestions();
            loadCourseSettings();
            // Pre-fill AI tab prompt template (DS mode by default)
            setRagPromptMode('zh');
            // Load DS docs for default DeepSeek mode
            loadDsDocs();
        });

        // ========== AI 智能出题 ==========

        // ── 提示词模板常量 ─────────────────────────────────────────────────────

        const RAG_PROMPT_ZH = `你是一位专业的教学内容设计专家，擅长根据课程材料出题。

以下是从知识库检索到的参考内容：

{context}

请根据以上参考内容，按照以下要求生成题目。

**题型与数量：**
{question_list}

**质量要求：**
1. 内容必须忠实于参考内容中的知识点，不得编造
2. 难度分布约为：简单(easy) 30%、中等(medium) 50%、困难(hard) 20%
   - 简单(easy)：答案可在参考内容原文中直接找到，考查识记理解
   - 中等(medium)：需结合具体实例或场景，不能仅靠背诵，要求迁移应用
   - 困难(hard)：需综合运用多个知识点，要求整体把握和批判性分析
3. 覆盖参考内容的主要知识点和核心概念
4. 每道题必须标注对应知识点（写在解析里）
5. 题目必须独立成立，严禁出现引用文件位置的表述，如"如第X章所述""见图""根据上文"等

**输出格式（必须严格遵守）：**

⚠️ 导入格式关键要素（写错会导致导入失败）：
- 所有括号必须是半角字符：[ ] < > 不能用全角【】（）＜＞
- 题型名称必须完全一致，层级题型用 > 分隔且两侧无空格，如 [简答>材料分析]
- 选择题答案：紧跟题型，大写字母，如 [单选][A]、[多选][ABD]；不能小写
- 是非题答案：只能写 [正确] 或 [错误]，不能用"是/对/T"替代
- 选项行必须顶格写，行首不能有任何空格：[A]选项内容
- <参考答案> 和 <解析> 标签必须成对出现，用 </参考答案> 和 </解析> 闭合
- 难度只能写 easy、medium 或 hard（全小写英文）
- 知识点/标签/难度字段必须写在 <解析> 块内

{format_examples}

注意事项：
1. 不要添加题号（系统会自动编号）
2. 不要在题目外添加任何说明文字、章节标题或分割线
3. 不要使用 *、**、# 等 Markdown 格式符号，不要对文字加粗

现在请开始出题，直接输出题目内容，不需要任何前言。`;

        const RAG_PROMPT_BILINGUAL = `你是一位专业的双语教学内容设计专家，擅长设计中英双语课程题库。

以下是从知识库检索到的参考内容：

{context}

请根据以上参考内容，按照以下要求生成中英双语题目。

**题型与数量：**
{question_list}

**质量要求：**
1. 内容必须忠实于参考内容中的知识点，不得编造
2. 难度分布约为：简单(easy) 30%、中等(medium) 50%、困难(hard) 20%
3. 每道题必须同时提供中文和英文版本，语义完全对应，英文表达符合学术规范
4. 覆盖参考内容的主要知识点和核心概念
5. 题目必须独立成立，严禁出现引用文件位置的表述

**双语输出格式（必须严格遵守）：**

⚠️ 导入格式关键要素：
- 所有括号必须是半角字符：[ ] < > 不能用全角【】（）＜＞
- 题型名称必须完全一致，层级题型用 > 分隔且两侧无空格，如 [简答>材料分析]
- 选择题答案：紧跟题型，大写字母，如 [单选][A]、[多选][ABD]
- 是非题答案：只能写 [正确] 或 [错误]
- 选项行必须顶格写，无前导空格：[A]选项内容
- 英文选项格式：[A_en]Option text，下划线和 en 必须小写
- <参考答案> 和 <解析> 标签必须成对出现并正确闭合
- 英文题目字段必须写在 <解析> 块内：英文题目:English question text
- 难度只能写 easy、medium 或 hard（全小写英文）

{format_examples}

双语格式规则：
1. 选择题选项顺序：先列全部中文选项 [A][B][C][D]，再列全部英文选项 [A_en][B_en][C_en][D_en]
2. 所有题型均在 <解析> 内写一行 英文题目: 提供英文题干
3. 题型标识符始终使用中文 [单选]、[多选]、[是非]、[简答] 等
4. 不要添加题号，不要在题目外添加任何说明文字
5. 不要使用 *、**、# 等 Markdown 格式符号

现在请开始出题，直接输出题目内容，不需要任何前言。`;

        const RAG_PROMPT_EN = `You are a professional academic content designer specializing in creating exam questions.

The following content has been retrieved from the knowledge base as reference:

{context}

Based on the above reference content, generate exam questions according to the requirements below.

**Types and quantities:**
{question_list}

**Quality requirements:**
1. Content must be faithfully based on the reference material; do not fabricate content
2. Difficulty distribution: approximately 30% easy, 50% medium, 20% hard
   - Easy: answer found directly in reference text; tests recall and comprehension
   - Medium: requires combining concepts with real-world examples; tests application
   - Hard: requires integrating multiple knowledge points; tests critical analysis
3. Cover major knowledge points and core concepts from the reference content
4. Every question must be self-contained; do not reference the source material's location

**Output format (must follow strictly):**

⚠️ Critical format requirements (errors will cause import failure):
- All brackets must be ASCII (half-width): [ ] < > — never use full-width variants
- Question type must exactly match: hierarchical types use > with no spaces, e.g. [简答>材料分析]
- Choice answer: right after the type tag, uppercase letters — [单选][A], [多选][ABD]
- True/False answer: only [正确] for True, [错误] for False — do NOT change these
- Option lines must be flush-left with no leading spaces: [A]Option text
- English option format: [A_en]Option text — underscore and en must be lowercase
- Tags must appear in matching pairs: </参考答案> and </解析>
- Difficulty must be: easy, medium, or hard (lowercase English only)
- Metadata fields must be inside the <解析> block

{format_examples}

Important notes:
1. Keep Chinese type markers [单选], [多选], [是非], [简答], [简答>论述], [简答>材料分析] — these are system codes
2. Keep [正确] for True and [错误] for False — do NOT change
3. Keep Chinese field names 知识点, 标签, 英文题目, 难度 exactly as shown
4. Do not add question numbers; do not add explanatory text outside question blocks
5. Do not use Markdown formatting: *, **, #

Now please start generating questions. Output question content directly without any preamble.`;

        // ── 状态变量 ────────────────────────────────────────────────────────────
        let _aiMode = 'deepseek';   // 'deepseek' | 'rag' — 出题模式
        let _ragAllChapters = [];   // [{num, name}, ...]
        let _ragAllSections = [];   // [{num, name}, ...]
        let _ragAllKps = [];        // DS 模式知识点列表
        let _ragCurrentMode = 'zh'; // zh / bilingual / en
        let _currentDsTaskId = null; // 当前正在运行的 DS 提取任务 ID

        // ── AI 出题模式切换 ───────────────────────────────────────────────────────

        function setAiMode(mode) {
            if (mode === 'rag' && _aiMode !== 'rag') {
                showRagWarning();  // 先弹警告，确认后再切换
                return;
            }
            _aiMode = mode;
            _applyAiMode();
        }

        function _applyAiMode() {
            const isDS = _aiMode === 'deepseek';

            // 切换左侧面板
            const dsPanel  = document.getElementById('ds-kb-panel');
            const ragPanel = document.getElementById('rag-kb-panel');
            if (dsPanel)  dsPanel.style.display  = isDS ? '' : 'none';
            if (ragPanel) ragPanel.style.display = isDS ? 'none' : '';

            // 切换按钮样式
            const dsBtn  = document.getElementById('ai-mode-btn-deepseek');
            const ragBtn = document.getElementById('ai-mode-btn-rag');
            if (dsBtn && ragBtn) {
                dsBtn.style.background  = isDS ? 'var(--secondary-color)' : 'transparent';
                dsBtn.style.color       = isDS ? 'white' : '#666';
                ragBtn.style.background = isDS ? 'transparent' : 'var(--secondary-color)';
                ragBtn.style.color      = isDS ? '#666' : 'white';
            }

            // 更新模式说明
            const desc = document.getElementById('ai-mode-desc');
            if (desc) {
                desc.textContent = isDS
                    ? '无需向量数据库，DeepSeek 直接分析文档知识结构并出题'
                    : 'BGE 嵌入模型 + Qdrant 向量库混合检索，语义匹配精度更高';
            }

            // 刷新提示词（不同模式用不同前言）
            setRagPromptMode(_ragCurrentMode);

            // 刷新文档列表和章节/知识点列表
            if (isDS) {
                loadDsDocs();
            } else {
                loadRagDocs();
            }
        }

        function showRagWarning() {
            // 重置为阶段1
            document.getElementById('rag-warn-phase1').style.display = '';
            document.getElementById('rag-warn-phase2').style.display = 'none';
            document.getElementById('rag-warn-phase3').style.display = 'none';
            const modal = document.getElementById('rag-warning-modal');
            if (modal) modal.style.display = 'flex';
        }

        function closeRagWarning(confirmed) {
            const modal = document.getElementById('rag-warning-modal');
            if (!confirmed) {
                if (modal) modal.style.display = 'none';
                return;
            }
            // 进入阶段2：触发安装
            document.getElementById('rag-warn-phase1').style.display = 'none';
            document.getElementById('rag-warn-phase2').style.display = '';
            _startRagDepInstall();
        }

        async function _startRagDepInstall() {
            try {
                const resp = await fetch('/api/rag/install-rag-deps', { method: 'POST' });
                const data = await resp.json();
                if (data.error) { _ragInstallFinish(false, data.error); return; }
                _pollRagInstall(data.task_id);
            } catch (e) {
                _ragInstallFinish(false, '网络请求失败：' + e.message);
            }
        }

        function _pollRagInstall(taskId) {
            const logEl = document.getElementById('rag-install-log');
            const timer = setInterval(async () => {
                try {
                    const resp = await fetch(`/api/rag/install-tasks/${taskId}`);
                    const task = await resp.json();
                    if (logEl) logEl.textContent = task.log || '';
                    if (task.status === 'done') {
                        clearInterval(timer);
                        _ragInstallFinish(true, task.log);
                    } else if (task.status === 'error') {
                        clearInterval(timer);
                        _ragInstallFinish(false, task.log);
                    }
                } catch (e) { /* 网络抖动，继续轮询 */ }
            }, 2000);
        }

        function _ragInstallFinish(success, msg) {
            document.getElementById('rag-warn-phase2').style.display = 'none';
            document.getElementById('rag-warn-phase3').style.display = '';
            const titleEl = document.getElementById('rag-install-result-title');
            const msgEl   = document.getElementById('rag-install-result-msg');
            const btnEl   = document.getElementById('rag-install-result-btn');
            if (success) {
                titleEl.innerHTML = '<i class="fas fa-check-circle" style="color:var(--success-color);"></i> 依赖安装成功';
                titleEl.style.color = 'var(--success-color)';
                msgEl.textContent = msg;
                btnEl.textContent = '切换到 RAG 模式';
                btnEl.onclick = () => {
                    document.getElementById('rag-warning-modal').style.display = 'none';
                    _aiMode = 'rag';
                    _applyAiMode();
                };
            } else {
                titleEl.innerHTML = '<i class="fas fa-times-circle" style="color:var(--danger-color);"></i> 安装失败';
                titleEl.style.color = 'var(--danger-color)';
                msgEl.textContent = msg;
                btnEl.textContent = '关闭';
                btnEl.onclick = () => {
                    document.getElementById('rag-warning-modal').style.display = 'none';
                };
            }
        }

        // ── DS 文档管理 ───────────────────────────────────────────────────────────

        async function loadDsDocs() {
            try {
                const resp = await fetch('/api/rag/ds-docs');
                if (!resp.ok) return;
                const docs = await resp.json();
                renderDsDocList(docs);
                renderDsDocCheckboxes(docs);
            } catch (e) {
                console.error('loadDsDocs error:', e);
            }
        }

        function renderDsDocList(docs) {
            const el = document.getElementById('ds-doc-list');
            if (!el) return;
            if (!docs || docs.length === 0) {
                el.innerHTML = '<div style="text-align:center;color:#bbb;padding:20px;font-size:0.85rem;"><i class="fas fa-folder-open"></i><br>暂无文档，请上传教材</div>';
                return;
            }
            el.innerHTML = docs.map(d => {
                const statusIcon =
                    d.status === 'done'
                        ? '<i class="fas fa-check-circle" style="color:#27ae60;"></i>'
                    : d.status === 'extracting'
                        ? '<i class="fas fa-spinner fa-spin" style="color:#f39c12;"></i>'
                    : d.status === 'paused'
                        ? '<i class="fas fa-pause-circle" style="color:#e67e22;"></i>'
                    : d.status === 'error'
                        ? `<i class="fas fa-times-circle" style="color:#e74c3c;" title="${escapeHtml(d.error_msg)}"></i>`
                    : '<i class="fas fa-upload" style="color:#3498db;"></i>';

                const kpInfo =
                    d.status === 'done'
                        ? `${d.kp_count || 0} 个知识点`
                    : d.status === 'paused'
                        ? `已提取 ${d.ch_with_kps || 0}/${d.chapter_count || 0} 章 · ${d.kp_count || 0} 个知识点`
                    : `${d.chapter_count || 0} 章，待提取`;

                // 操作按钮区
                let actionBtns = '';
                if (d.status === 'extracting') {
                    actionBtns = '<span style="font-size:0.75rem;color:#f39c12;padding:2px 4px;">提取中...</span>';
                } else if (d.status === 'paused') {
                    actionBtns = `
                        <button onclick="dsExtract('${escapeHtml(d.doc_id)}', true)"
                            title="从上次暂停处继续提取"
                            style="background:none;border:1px solid #e67e22;color:#e67e22;cursor:pointer;
                                   padding:2px 7px;font-size:0.75rem;border-radius:4px;white-space:nowrap;"
                            onmouseover="this.style.background='#fef5ec'" onmouseout="this.style.background='none'">
                            <i class="fas fa-play"></i> 继续
                        </button>
                        <button onclick="dsExtract('${escapeHtml(d.doc_id)}', false)"
                            title="清除已提取数据，从头重新提取所有章节"
                            style="background:none;border:1px solid #95a5a6;color:#95a5a6;cursor:pointer;
                                   padding:2px 7px;font-size:0.75rem;border-radius:4px;white-space:nowrap;"
                            onmouseover="this.style.background='#f2f3f4'" onmouseout="this.style.background='none'">
                            <i class="fas fa-redo-alt"></i>
                        </button>`;
                } else {
                    actionBtns = `
                        <button onclick="dsExtract('${escapeHtml(d.doc_id)}')"
                            title="${d.kp_count > 0 ? '重新提取（会清空已有知识点）' : '提取知识点'}"
                            style="background:none;border:1px solid #3498db;color:#3498db;cursor:pointer;
                                   padding:2px 7px;font-size:0.75rem;border-radius:4px;white-space:nowrap;"
                            onmouseover="this.style.background='#ebf5fb'" onmouseout="this.style.background='none'">
                            <i class="fas fa-magic"></i> ${d.kp_count > 0 ? '重新提取' : '提取'}
                        </button>`;
                }

                return `
                <div style="padding:7px 4px;border-bottom:1px solid #f0f0f0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:4px;">
                        <div style="flex:1;min-width:0;overflow:hidden;">
                            <div style="display:flex;align-items:center;gap:5px;font-size:0.82rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                ${statusIcon}
                                <span title="${escapeHtml(d.doc_id)}">${escapeHtml(d.doc_id)}</span>
                            </div>
                            <div style="color:#888;font-size:0.75rem;margin-top:2px;">${kpInfo}</div>
                        </div>
                        <div style="display:flex;gap:3px;flex-shrink:0;">
                            ${(d.status === 'done' || d.status === 'paused') && d.kp_count > 0 ? `
                            <button onclick="showDsKgModal('${escapeHtml(d.doc_id)}')" title="查看此文档的知识图谱"
                                style="background:none;border:1px solid #8e44ad;color:#8e44ad;cursor:pointer;
                                       padding:2px 7px;font-size:0.75rem;border-radius:4px;white-space:nowrap;"
                                onmouseover="this.style.background='#f5eef8'" onmouseout="this.style.background='none'">
                                <i class="fas fa-project-diagram"></i>
                            </button>` : ''}
                            ${actionBtns}
                            <button onclick="dsDeleteDoc('${escapeHtml(d.doc_id)}')" title="删除文档"
                                style="background:none;border:none;color:#e74c3c;cursor:pointer;padding:2px 5px;font-size:0.9rem;"
                                onmouseover="this.style.background='#ffeaea'" onmouseout="this.style.background='none'">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderDsDocCheckboxes(docs) {
            if (_aiMode !== 'deepseek') return;
            const el = document.getElementById('rag-doc-checkboxes');
            if (!el) return;
            const doneDocs = (docs || []).filter(d => d.status === 'done' || d.status === 'paused');
            if (doneDocs.length === 0) {
                el.innerHTML = '<span style="color:#bbb;">请先上传文档并点击「提取」按钮</span>';
                _ragAllChapters = [];
                _ragAllSections = [];
                renderRagChapterList([]);
                renderRagSectionList([]);
                return;
            }
            el.innerHTML = doneDocs.map(d => `
                <label style="display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="rag-doc-cb" value="${escapeHtml(d.doc_id)}" checked
                        onchange="updateRagMeta()">
                    ${escapeHtml(d.doc_id)}
                    <span style="color:#aaa;font-size:0.75rem;">(${d.kp_count || 0}个KP)</span>
                </label>
            `).join('');
            updateRagMeta();
        }

        async function dsDeleteDoc(docId) {
            if (!confirm(`确认删除文档「${docId}」及其知识点数据？此操作不可撤销。`)) return;
            try {
                const resp = await fetch(`/api/rag/ds-docs/${encodeURIComponent(docId)}`, { method: 'DELETE' });
                const data = await resp.json();
                if (data.success) {
                    await loadDsDocs();
                } else {
                    alert('删除失败：' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('删除出错：' + e.message);
            }
        }

        // ── DS 知识图谱可视化 ──────────────────────────────────────────────────────

        let _dsKgD3Ready = false;

        // 全局调色板 & 关系颜色（供渲染和筛选面板共用，颜色一致）
        const _dsKgPalette = [
            '#3498db','#e74c3c','#27ae60','#f39c12','#9b59b6',
            '#1abc9c','#e67e22','#2c3e50','#e91e63','#00bcd4',
            '#8bc34a','#ff5722','#607d8b','#795548','#ff9800',
        ];
        const _dsKgRelColors = {
            '从属': '#3498db', '比较': '#e67e22', '并列': '#27ae60',
            '交叉': '#9b59b6', '前提': '#e74c3c',
        };

        // 全量原始数据（切换筛选条件时不重新请求）
        let _dsKgAllNodes    = [];
        let _dsKgAllLinks    = [];
        let _dsKgAllChapters = [];

        // 稳定的章节颜色（以全量章节列表为基准，避免筛选后颜色跳变）
        function _dsKgColorOf(chName) {
            const idx = _dsKgAllChapters.findIndex(c => c.name === chName);
            return _dsKgPalette[(idx < 0 ? 0 : idx) % _dsKgPalette.length];
        }

        // ── 构建左侧筛选面板 ──────────────────────────────────────────────────
        function _buildDsKgFilterPanel() {
            // 章节复选框
            const chPanel = document.getElementById('ds-kg-chapter-checks');
            if (chPanel) {
                chPanel.innerHTML = _dsKgAllChapters.map(ch => `
                    <label style="display:flex;align-items:center;gap:5px;padding:2px 0;
                                  cursor:pointer;font-size:0.78rem;overflow:hidden;min-width:0;">
                        <input type="checkbox" class="ds-kg-ch-cb" value="${escapeHtml(ch.name)}"
                               checked onchange="_applyDsKgFilter()" style="flex-shrink:0;">
                        <span style="width:8px;height:8px;border-radius:50%;
                                     background:${_dsKgColorOf(ch.name)};flex-shrink:0;"></span>
                        <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                              title="${escapeHtml(ch.name)}">${escapeHtml(ch.name)}</span>
                    </label>`).join('');
            }
            // 关系类型复选框
            const relPanel = document.getElementById('ds-kg-rel-checks');
            if (relPanel) {
                const entries = [...Object.entries(_dsKgRelColors), ['_other', '#aaa']];
                relPanel.innerHTML = entries.map(([t, c]) => `
                    <label style="display:flex;align-items:center;gap:5px;padding:2px 0;
                                  cursor:pointer;font-size:0.78rem;">
                        <input type="checkbox" class="ds-kg-rel-cb" value="${escapeHtml(t)}"
                               checked onchange="_applyDsKgFilter()" style="flex-shrink:0;">
                        <span style="width:18px;height:2px;background:${c};
                                     flex-shrink:0;border-radius:1px;display:inline-block;"></span>
                        <span>${t === '_other' ? '其他' : escapeHtml(t)}</span>
                    </label>`).join('');
            }
        }

        // ── 应用筛选并重渲染 ──────────────────────────────────────────────────
        function _applyDsKgFilter() {
            const selectedCh  = new Set([...document.querySelectorAll('.ds-kg-ch-cb:checked')].map(cb => cb.value));
            const selectedRel = new Set([...document.querySelectorAll('.ds-kg-rel-cb:checked')].map(cb => cb.value));
            const searchText  = (document.getElementById('ds-kg-kp-search')?.value || '').trim().toLowerCase();

            // 筛选节点：按章节 + 知识点关键词
            let filteredNodes = _dsKgAllNodes.filter(n => selectedCh.has(n.chapter));
            if (searchText) {
                filteredNodes = filteredNodes.filter(n =>
                    n.name.toLowerCase().includes(searchText) ||
                    (n.content || '').toLowerCase().includes(searchText)
                );
            }

            // 筛选边：两端均在可见节点内 + 关系类型被勾选
            const nodeIds = new Set(filteredNodes.map(n => n.id));
            const knownTypes = new Set(Object.keys(_dsKgRelColors));
            const filteredLinks = _dsKgAllLinks.filter(l => {
                if (!nodeIds.has(l.source) || !nodeIds.has(l.target)) return false;
                const key = knownTypes.has(l.type) ? l.type : '_other';
                return selectedRel.has(key);
            });

            // 更新统计文字
            const stats = document.getElementById('ds-kg-filter-stats');
            if (stats) stats.textContent = `${filteredNodes.length} 个知识点 · ${filteredLinks.length} 条关系`;

            // 只把有可见节点的章节传给渲染（用于图例）
            const visCh = new Set(filteredNodes.map(n => n.chapter));
            const filteredChapters = _dsKgAllChapters.filter(c => visCh.has(c.name));
            _renderDsKg(filteredNodes, filteredLinks, filteredChapters);
        }

        function _dsKgSelectAllChapters(checked) {
            document.querySelectorAll('.ds-kg-ch-cb').forEach(cb => cb.checked = checked);
            _applyDsKgFilter();
        }

        function _resetDsKgFilter() {
            document.querySelectorAll('.ds-kg-ch-cb').forEach(cb => cb.checked = true);
            document.querySelectorAll('.ds-kg-rel-cb').forEach(cb => cb.checked = true);
            const s = document.getElementById('ds-kg-kp-search');
            if (s) s.value = '';
            _applyDsKgFilter();
        }

        function _loadD3(cb) {
            if (window.d3) { cb(); return; }
            const s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js';
            s.onload = () => { _dsKgD3Ready = true; cb(); };
            s.onerror = () => {
                const c = document.getElementById('ds-kg-container');
                if (c) c.innerHTML = '<div style="padding:40px;text-align:center;color:#e74c3c;"><i class="fas fa-exclamation-triangle"></i> D3.js 加载失败，请检查网络连接后重试</div>';
            };
            document.head.appendChild(s);
        }

        // docId 可选：传入则只展示该文档；不传则展示所有已勾选文档
        async function showDsKgModal(docId) {
            const modal = document.getElementById('ds-kg-modal');
            modal.style.display = 'flex';

            // 确定要查询的 doc_ids
            let ids = [];
            if (docId) {
                ids = [docId];
            } else {
                ids = [...document.querySelectorAll('.rag-doc-cb:checked')].map(cb => cb.value);
            }

            const subtitle = document.getElementById('ds-kg-subtitle');
            if (subtitle) {
                subtitle.textContent = ids.length === 1 ? `（${ids[0]}）`
                    : ids.length > 1 ? `（${ids.length} 个文档）` : '（全部文档）';
            }

            const container = document.getElementById('ds-kg-container');
            container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#888;font-size:0.9rem;"><i class="fas fa-spinner fa-spin" style="margin-right:8px;font-size:1.2rem;"></i>加载知识图谱...</div>';

            _loadD3(async () => {
                try {
                    const qs = ids.length > 0
                        ? '?' + ids.map(id => `doc_id=${encodeURIComponent(id)}`).join('&')
                        : '';
                    const resp = await fetch('/api/rag/ds-graph' + qs);
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const data = await resp.json();
                    _dsKgAllNodes    = data.nodes    || [];
                    _dsKgAllLinks    = data.links    || [];
                    _dsKgAllChapters = data.chapters || [];
                    _buildDsKgFilterPanel();
                    _applyDsKgFilter();
                } catch (e) {
                    container.innerHTML = `<div style="padding:40px;text-align:center;color:#e74c3c;">加载失败：${escapeHtml(e.message)}</div>`;
                }
            });
        }

        function closeDsKgModal() {
            const modal = document.getElementById('ds-kg-modal');
            if (modal) modal.style.display = 'none';
            // 停止仿真，释放内存
            if (window._dsKgSimulation) { window._dsKgSimulation.stop(); window._dsKgSimulation = null; }
            const c = document.getElementById('ds-kg-container');
            if (c) c.innerHTML = '';
            const tt = document.getElementById('ds-kg-tooltip');
            if (tt) tt.style.display = 'none';
            // 清空全量数据
            _dsKgAllNodes = []; _dsKgAllLinks = []; _dsKgAllChapters = [];
        }

        function _renderDsKg(nodes, links, chapters) {
            const container = document.getElementById('ds-kg-container');
            const legend    = document.getElementById('ds-kg-legend');
            container.innerHTML = '';

            if (!nodes.length) {
                container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#aaa;font-size:0.88rem;"><i class="fas fa-info-circle" style="margin-right:6px;"></i>暂无知识点数据，请先完成知识点提取</div>';
                if (legend) legend.innerHTML = '';
                return;
            }

            // ── 颜色映射（使用全局常量，章节色以全量列表为基准保证一致） ──────
            const colorOf = ch => _dsKgColorOf(ch);
            const relColor = t => _dsKgRelColors[t] || '#aaa';
            const chNames  = chapters.map(c => c.name); // 供图例区使用（当前可见章节）

            // ── 图例 ──────────────────────────────────────────────────────────
            if (legend) {
                const chHtml = chNames.map(ch =>
                    `<span style="display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:10px;background:${colorOf(ch)}18;border:1px solid ${colorOf(ch)}55;cursor:default;" title="${escapeHtml(ch)}">
                        <span style="width:7px;height:7px;border-radius:50%;background:${colorOf(ch)};flex-shrink:0;"></span>
                        <span style="max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#333;">${escapeHtml(ch)}</span>
                    </span>`
                ).join('');
                const relHtml = Object.entries(_dsKgRelColors).map(([t, c]) =>
                    `<span style="display:inline-flex;align-items:center;gap:3px;">
                        <span style="width:18px;height:2px;background:${c};display:inline-block;border-radius:1px;"></span>
                        <span style="color:#666;">${escapeHtml(t)}</span>
                    </span>`
                ).join('');
                legend.innerHTML = chHtml
                    + (chHtml && relHtml ? '<span style="color:#ddd;margin:0 6px;">│</span>' : '')
                    + relHtml
                    + `<span style="margin-left:auto;color:#aaa;">${nodes.length} 个知识点 · ${links.length} 条关系</span>`;
            }

            // ── D3 绘图 ───────────────────────────────────────────────────────
            const W = container.clientWidth  || 900;
            const H = container.clientHeight || 520;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', W).attr('height', H)
                .style('cursor', 'grab');

            // 箭头标记
            const defs = svg.append('defs');
            [...Object.keys(_dsKgRelColors), '_default'].forEach(t => {
                const col = _dsKgRelColors[t] || '#aaa';
                defs.append('marker')
                    .attr('id', `dskg-arrow-${t}`)
                    .attr('viewBox', '0 -5 10 10').attr('refX', 32).attr('refY', 0)
                    .attr('markerWidth', 5).attr('markerHeight', 5).attr('orient', 'auto')
                    .append('path').attr('d', 'M0,-5L10,0L0,5').attr('fill', col);
            });

            const g = svg.append('g');

            // 缩放平移
            svg.call(
                d3.zoom().scaleExtent([0.1, 5])
                    .on('zoom', e => { g.attr('transform', e.transform); })
            );

            // 克隆数据（D3 会直接修改 source/target 为对象引用）
            const nodesD = nodes.map(n => ({...n}));
            const linksD = links.map(l => ({...l}));

            // 力仿真
            const sim = d3.forceSimulation(nodesD)
                .force('link',      d3.forceLink(linksD).id(d => d.id).distance(140).strength(0.4))
                .force('charge',    d3.forceManyBody().strength(-320))
                .force('center',    d3.forceCenter(W / 2, H / 2))
                .force('collision', d3.forceCollide(46));
            window._dsKgSimulation = sim;

            // 边
            const edgeG = g.append('g');
            const edgeLine = edgeG.selectAll('line').data(linksD).enter().append('line')
                .attr('stroke', d => relColor(d.type))
                .attr('stroke-width', 1.5).attr('stroke-opacity', 0.65)
                .attr('marker-end', d => `url(#dskg-arrow-${d.type in _dsKgRelColors ? d.type : '_default'})`);

            const edgeLabel = edgeG.selectAll('text').data(linksD).enter().append('text')
                .attr('font-size', 8.5).attr('fill', d => relColor(d.type))
                .attr('text-anchor', 'middle').attr('dy', -3)
                .text(d => d.type || '');

            // 节点
            const nodeG = g.append('g').selectAll('g').data(nodesD).enter().append('g')
                .call(d3.drag()
                    .on('start', (e, d) => { if (!e.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag',  (e, d) => { d.fx = e.x; d.fy = e.y; })
                    .on('end',   (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null; })
                );

            nodeG.append('circle')
                .attr('r', 22)
                .attr('fill', d => colorOf(d.chapter))
                .attr('fill-opacity', 0.82)
                .attr('stroke', d => colorOf(d.chapter))
                .attr('stroke-width', 2.5).attr('stroke-opacity', 0.4);

            nodeG.append('text')
                .attr('text-anchor', 'middle').attr('dy', '0.35em')
                .attr('font-size', 9).attr('fill', '#fff').attr('font-weight', '600')
                .attr('pointer-events', 'none')
                .text(d => d.name.length > 7 ? d.name.slice(0, 7) + '…' : d.name);

            // Tooltip
            const tt = document.getElementById('ds-kg-tooltip');
            nodeG.on('mouseenter', (e, d) => {
                if (!tt) return;
                tt.style.display = 'block';
                tt.innerHTML =
                    `<div style="font-weight:600;color:#2c3e50;margin-bottom:4px;font-size:0.83rem;">${escapeHtml(d.name)}</div>` +
                    `<div style="color:#8e44ad;font-size:0.71rem;margin-bottom:5px;"><i class="fas fa-book-open" style="font-size:0.65rem;"></i> ${escapeHtml(d.chapter || '')}</div>` +
                    `<div style="color:#555;max-height:110px;overflow:hidden;">${escapeHtml((d.content || '').slice(0, 220))}${(d.content||'').length > 220 ? '…' : ''}</div>`;
                _moveDsKgTt(e);
            }).on('mousemove', _moveDsKgTt).on('mouseleave', () => { if (tt) tt.style.display = 'none'; });

            sim.on('tick', () => {
                edgeLine
                    .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                edgeLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);
                nodeG.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function _moveDsKgTt(e) {
            const tt = document.getElementById('ds-kg-tooltip');
            if (!tt) return;
            const x = e.clientX + 14, y = e.clientY - 10;
            tt.style.left = (x + tt.offsetWidth  > window.innerWidth  - 10 ? x - tt.offsetWidth  - 28 : x) + 'px';
            tt.style.top  = (y + tt.offsetHeight > window.innerHeight - 10 ? y - tt.offsetHeight - 20 : y) + 'px';
        }

        // ESC 关闭图谱 modal
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                const m = document.getElementById('ds-kg-modal');
                if (m && m.style.display !== 'none') closeDsKgModal();
            }
        });

        // ── DS 文件上传 ────────────────────────────────────────────────────────────

        async function dsUploadFiles(files) {
            if (!files || files.length === 0) return;
            const subject = document.getElementById('rag-subject')?.value || '';

            for (const file of files) {
                const statusEl = addDsUploadStatus(file.name);
                const fd = new FormData();
                fd.append('file', file);
                fd.append('subject', subject);
                try {
                    const resp = await fetch('/api/rag/ds-upload', { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok || data.error) {
                        updateDsUploadStatus(statusEl, 'error', data.error || '上传失败');
                    } else if (data.async) {
                        // PDF / PPTX 走 OCR 异步流程
                        updateDsUploadStatus(statusEl, 'processing', 'OCR 处理中...');
                        pollDsUploadTask(data.task_id, statusEl);
                    } else {
                        updateDsUploadStatus(statusEl, 'done',
                            `已解析 ${data.chapter_count} 个章节，点击「提取」按钮提取知识点`);
                        await loadDsDocs();
                    }
                } catch (e) {
                    updateDsUploadStatus(statusEl, 'error', e.message);
                }
            }
            document.getElementById('ds-file-input').value = '';
        }

        function addDsUploadStatus(filename) {
            const container = document.getElementById('ds-doc-list');
            const div = document.createElement('div');
            div.style.cssText = 'padding:6px 4px;border-bottom:1px solid #f0f0f0;font-size:0.82rem;';
            div.innerHTML = `<div style="display:flex;align-items:center;gap:6px;">
                <i class="fas fa-spinner fa-spin" style="color:#3498db;"></i>
                <span>${escapeHtml(filename)}</span>
                <span class="ds-upload-msg" style="color:#888;font-size:0.75rem;">上传中...</span>
            </div>`;
            container.insertBefore(div, container.firstChild);
            return div;
        }

        function updateDsUploadStatus(el, status, msg) {
            const icons  = {
                done: 'fa-check-circle',
                error: 'fa-times-circle',
                processing: 'fa-spinner fa-spin',
                timeout: 'fa-exclamation-circle',
            };
            const colors = {
                done: '#27ae60',
                error: '#e74c3c',
                processing: '#f39c12',
                timeout: '#e67e22',
            };
            const icon  = el.querySelector('i');
            const msgEl = el.querySelector('.ds-upload-msg');
            if (icon) {
                icon.className = `fas ${icons[status] || 'fa-spinner fa-spin'} `;
                icon.style.color = colors[status] || '#3498db';
            }
            if (msgEl) msgEl.textContent = msg;
        }

        async function pollDsUploadTask(taskId, statusEl) {
            const poll = async () => {
                try {
                    const resp = await fetch(`/api/rag/ds-tasks/${taskId}`);
                    const task = await resp.json();
                    if (task.status === 'done') {
                        updateDsUploadStatus(statusEl, 'done', task.message);
                        await loadDsDocs();
                    } else if (task.status === 'timeout') {
                        // 超时但有检查点可续传
                        const done = task.done_chunks || 0;
                        const total = task.total_chunks || '?';
                        updateDsUploadStatus(statusEl, 'timeout',
                            `OCR 超时（已完成 ${done}/${total} 块）`);
                        // 渲染重试按钮
                        _renderRetryButton(statusEl, taskId, task.doc_id);
                    } else if (task.status === 'error') {
                        updateDsUploadStatus(statusEl, 'error', task.message);
                    } else {
                        const progressMsg = task.total_chunks
                            ? `OCR 处理中 (${task.done_chunks || 0}/${task.total_chunks} 块)...`
                            : (task.message || 'OCR 处理中...');
                        updateDsUploadStatus(statusEl, 'processing', progressMsg);
                        setTimeout(poll, 3000);
                    }
                } catch (e) {
                    setTimeout(poll, 5000);
                }
            };
            setTimeout(poll, 2000);
        }

        function _renderRetryButton(statusEl, oldTaskId, docId) {
            // 避免重复添加
            if (statusEl.querySelector('.ds-retry-btn')) return;
            const btn = document.createElement('button');
            btn.className = 'ds-retry-btn';
            btn.textContent = '重试续传';
            btn.style.cssText = 'margin-left:8px;padding:2px 10px;border:1px solid #e67e22;border-radius:4px;background:#fff7f0;color:#e67e22;cursor:pointer;font-size:0.78rem;';
            btn.onclick = async () => {
                btn.disabled = true;
                btn.textContent = '续传中...';
                updateDsUploadStatus(statusEl, 'processing', 'OCR 断点续传中...');
                try {
                    const resp = await fetch(`/api/rag/ds-retry-ocr/${oldTaskId}`, {
                        method: 'POST'
                    });
                    const data = await resp.json();
                    if (!resp.ok || data.error) {
                        updateDsUploadStatus(statusEl, 'error', data.error || '续传启动失败');
                        btn.remove();
                        return;
                    }
                    // 移除重试按钮，开始轮询新任务
                    btn.remove();
                    pollDsUploadTask(data.task_id, statusEl);
                } catch (e) {
                    updateDsUploadStatus(statusEl, 'error', '续传请求出错：' + e.message);
                    btn.remove();
                }
            };
            statusEl.querySelector('div')?.appendChild(btn);
        }

        // ── DS 知识点提取 ──────────────────────────────────────────────────────────

        async function dsExtract(docId, resume = false) {
            const subject = document.getElementById('rag-subject')?.value || '';
            const progressEl  = document.getElementById('ds-extract-progress');
            const progressTxt = document.getElementById('ds-extract-progress-text');
            const pauseBtn    = document.getElementById('ds-pause-btn');

            // 重置进度条样式（可能被上次错误染色）
            if (progressEl) {
                progressEl.style.background = '#fff3cd';
                progressEl.style.color = '#856404';
                progressEl.style.display = '';
            }
            if (progressTxt) progressTxt.textContent = resume ? '继续提取中...' : '准备开始...';
            if (pauseBtn) { pauseBtn.disabled = false; pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停'; }

            try {
                const resp = await fetch(`/api/rag/ds-extract/${encodeURIComponent(docId)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject, resume }),
                });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    if (progressEl) progressEl.style.display = 'none';
                    alert('启动提取失败：' + (data.error || ''));
                    return;
                }
                // 续传但所有章节已提取完毕
                if (data.already_done) {
                    if (progressEl) progressEl.style.display = 'none';
                    await loadDsDocs();
                    await updateRagMeta();
                    return;
                }
                _currentDsTaskId = data.task_id;
                await loadDsDocs();
                pollDsTask(data.task_id, docId);
            } catch (e) {
                if (progressEl) progressEl.style.display = 'none';
                alert('提取请求出错：' + e.message);
            }
        }

        async function pauseDsExtract() {
            if (!_currentDsTaskId) return;
            const pauseBtn = document.getElementById('ds-pause-btn');
            if (pauseBtn) { pauseBtn.disabled = true; pauseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 暂停中...'; }
            try {
                await fetch(`/api/rag/ds-tasks/${_currentDsTaskId}/pause`, { method: 'POST' });
            } catch (e) {
                if (pauseBtn) { pauseBtn.disabled = false; pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停'; }
                alert('暂停请求失败：' + e.message);
            }
        }

        async function pollDsTask(taskId, docId) {
            const progressEl  = document.getElementById('ds-extract-progress');
            const progressTxt = document.getElementById('ds-extract-progress-text');
            const pauseBtn    = document.getElementById('ds-pause-btn');
            const poll = async () => {
                try {
                    const resp = await fetch(`/api/rag/ds-tasks/${taskId}`);
                    const task = await resp.json();
                    // 显示消息 + 章节进度
                    if (progressTxt) {
                        const totalDisplay = task.total_chapters || task.total || 0;
                        const prog = totalDisplay > 0 ? ` (${(task.progress || 0) + 1}/${totalDisplay})` : '';
                        progressTxt.textContent = (task.message || '') + prog;
                    }

                    if (task.status === 'done') {
                        if (progressEl) progressEl.style.display = 'none';
                        _currentDsTaskId = null;
                        await loadDsDocs();
                        await updateRagMeta();
                    } else if (task.status === 'paused') {
                        if (progressEl) progressEl.style.display = 'none';
                        _currentDsTaskId = null;
                        if (pauseBtn) { pauseBtn.disabled = false; pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停'; }
                        await loadDsDocs();
                    } else if (task.status === 'error') {
                        if (progressEl) {
                            progressEl.style.background = '#fdecea';
                            progressEl.style.color = '#c0392b';
                        }
                        if (progressTxt) progressTxt.textContent = '提取失败：' + task.message;
                        _currentDsTaskId = null;
                        if (pauseBtn) { pauseBtn.disabled = false; pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停'; }
                        await loadDsDocs();
                        setTimeout(() => { if (progressEl) progressEl.style.display = 'none'; }, 5000);
                    } else {
                        setTimeout(poll, 2500);
                    }
                } catch (e) {
                    setTimeout(poll, 5000);
                }
            };
            setTimeout(poll, 1500);
        }

        // ── DS 章节/知识点元数据加载 ──────────────────────────────────────────────

        async function dsUpdateMeta() {
            const checked = [...document.querySelectorAll('.rag-doc-cb:checked')].map(cb => cb.value);
            if (checked.length === 0) {
                _ragAllChapters = [];
                _ragAllSections = [];
                _ragAllKps = [];
                renderRagChapterList([]);
                renderRagSectionList([]);
                return;
            }
            const allChapters = new Map();
            const allKps = [];
            for (const docId of checked) {
                try {
                    const resp = await fetch(`/api/rag/ds-docs/${encodeURIComponent(docId)}/kps`);
                    if (!resp.ok) continue;
                    const meta = await resp.json();
                    for (const ch of (meta.chapters || [])) {
                        allChapters.set(ch.name, ch);
                    }
                    for (const kp of (meta.kps || [])) {
                        allKps.push(kp);
                    }
                } catch (e) { /* ignore */ }
            }
            _ragAllChapters = [...allChapters.values()];
            _ragAllKps = allKps;
            // 将 KP 映射为 sections 供现有筛选 UI 复用
            _ragAllSections = allKps.map(kp => ({
                num: kp.id,
                name: kp.name,
                chapter_name: kp.chapter_name,
                chapter_num: kp.chapter_num,
                display_name: kp.name,
            }));
            filterRagChapters();
            filterRagSections();
        }

        // ── DS 出题 ────────────────────────────────────────────────────────────────

        async function dsGenerate() {
            const btn      = document.getElementById('rag-generate-btn');
            const infoEl   = document.getElementById('rag-generate-info');
            const resultEl = document.getElementById('rag-result');

            const promptTemplate = document.getElementById('rag-prompt-editor')?.value || '';
            if (!promptTemplate.trim()) {
                alert('提示词模板为空，请先选择语言模式或手动填写提示词。');
                return;
            }
            const questionList = buildQuestionList();
            if (!questionList) {
                alert('请至少为一种题型设置数量（大于0）。');
                return;
            }

            const docIds   = [...document.querySelectorAll('.rag-doc-cb:checked')].map(cb => cb.value);
            const chapters = [...document.querySelectorAll('.rag-chapter-cb:checked')].map(cb => cb.value);
            const kpNames  = [...document.querySelectorAll('.rag-section-cb:checked')].map(cb => cb.value);

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 出题中...';
            if (infoEl) infoEl.textContent = 'DeepSeek 正在根据知识图谱生成题目，可能需要 30～120 秒...';
            if (resultEl) resultEl.value = '';

            try {
                const resp = await fetch('/api/rag/ds-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doc_ids: docIds,
                        chapters,
                        kp_names: kpNames,
                        prompt: promptTemplate,
                        question_list: questionList,
                    }),
                });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    alert('出题失败：' + (data.error || '未知错误'));
                    if (infoEl) infoEl.textContent = '';
                } else {
                    if (resultEl) resultEl.value = data.content || '';
                    if (infoEl) {
                        const stats = data.stats || {};
                        infoEl.textContent = `生成完成！使用了 ${stats.kps_used || 0} 个知识点（${stats.context_chars || 0} 字知识图谱上下文）。`;
                    }
                }
            } catch (e) {
                alert('请求出错：' + e.message);
                if (infoEl) infoEl.textContent = '';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> 一键出题';
            }
        }

        // ── 提示词适配（DS 模式修改前言描述）────────────────────────────────────────

        function _adaptPromptForDs(prompt) {
            return prompt
                .replace(
                    '你是一位专业的教学内容设计专家，擅长根据课程材料出题。',
                    '你是一位专业的教学内容设计专家，擅长根据知识图谱设计题库。'
                )
                .replace(
                    '以下是从知识库检索到的参考内容：',
                    '以下是从文档中提取的知识图谱信息（包含知识点定义、特征、分类、示例及知识点间关联关系）：'
                )
                .replace(
                    '请根据以上参考内容，按照以下要求生成题目。',
                    '请根据以上知识图谱信息，按照以下要求生成题目。'
                )
                // 双语版本适配
                .replace(
                    '以下是从知识库检索到的双语参考内容：',
                    '以下是从文档中提取的双语知识图谱信息：'
                )
                // 英文版本适配
                .replace(
                    'You are a professional academic content designer specializing in creating exam questions.',
                    'You are a professional academic content designer specializing in creating exam questions based on knowledge graphs.'
                )
                .replace(
                    'Here is the retrieved reference content from the knowledge base:',
                    'Here is the knowledge graph information extracted from the document (knowledge points, definitions, features, classifications, examples, and relationships):'
                )
                .replace(
                    'Please generate questions based on the above reference content according to the following requirements.',
                    'Please generate questions based on the above knowledge graph information according to the following requirements.'
                );
        }

        // ── 文档列表 ─────────────────────────────────────────────────────────────

        async function loadRagDocs() {
            try {
                const resp = await fetch('/api/rag/docs');
                if (!resp.ok) return;
                const docs = await resp.json();
                renderRagDocList(docs);
                renderRagDocCheckboxes(docs);
            } catch (e) {
                console.error('loadRagDocs error:', e);
            }
        }

        // ── API 配置 读/写 ────────────────────────────────────────────────────

        async function loadRagConfig() {
            try {
                const resp = await fetch('/api/rag/config');
                if (!resp.ok) return;
                const cfg = await resp.json();
                const urlEl   = document.getElementById('cfg-paddle-url');
                const tokenEl = document.getElementById('cfg-paddle-token');
                const dsEl    = document.getElementById('cfg-deepseek-key');
                if (urlEl)   urlEl.value   = cfg.paddleocr_url   || '';
                if (tokenEl) tokenEl.value = cfg.paddleocr_token || '';
                if (dsEl)    dsEl.value    = cfg.deepseek_api_key || '';
            } catch (e) { /* 忽略，不影响主流程 */ }
        }

        async function saveRagConfig() {
            const statusEl = document.getElementById('cfg-save-status');
            const body = {
                paddleocr_url:   (document.getElementById('cfg-paddle-url')?.value  || '').trim(),
                paddleocr_token: (document.getElementById('cfg-paddle-token')?.value || '').trim(),
                deepseek_api_key:(document.getElementById('cfg-deepseek-key')?.value || '').trim(),
            };
            try {
                if (statusEl) { statusEl.textContent = '保存中...'; statusEl.style.color = '#888'; }
                const resp = await fetch('/api/rag/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await resp.json();
                if (data.success) {
                    if (statusEl) {
                        statusEl.textContent = '已保存';
                        statusEl.style.color = 'var(--success-color)';
                        setTimeout(() => { statusEl.textContent = ''; }, 3000);
                    }
                } else {
                    if (statusEl) { statusEl.textContent = '保存失败：' + (data.error || ''); statusEl.style.color = 'var(--danger-color)'; }
                }
            } catch (e) {
                if (statusEl) { statusEl.textContent = '出错：' + e.message; statusEl.style.color = 'var(--danger-color)'; }
            }
        }

        function renderRagDocList(docs) {
            const el = document.getElementById('rag-doc-list');
            if (!docs || docs.length === 0) {
                el.innerHTML = '<div style="text-align:center;color:#bbb;padding:20px;font-size:0.85rem;"><i class="fas fa-folder-open"></i><br>暂无文档</div>';
                return;
            }
            el.innerHTML = docs.map(d => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 4px;border-bottom:1px solid #f0f0f0;font-size:0.82rem;">
                    <div style="flex:1;min-width:0;overflow:hidden;">
                        <div style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(d.doc_id)}">${escapeHtml(d.doc_id)}</div>
                        <div style="color:#888;font-size:0.75rem;">${d.source_type || ''} · ${d.chunk_count} 块</div>
                    </div>
                    <button onclick="ragDeleteDoc('${escapeHtml(d.doc_id)}')" title="删除文档"
                        style="background:none;border:none;color:#e74c3c;cursor:pointer;padding:2px 6px;font-size:0.9rem;flex-shrink:0;"
                        onmouseover="this.style.background='#ffeaea'" onmouseout="this.style.background='none'">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderRagDocCheckboxes(docs) {
            const el = document.getElementById('rag-doc-checkboxes');
            if (!docs || docs.length === 0) {
                el.innerHTML = '<span style="color:#bbb;">上传文档后在此选择</span>';
                return;
            }
            el.innerHTML = docs.map(d => `
                <label style="display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;font-size:0.85rem;">
                    <input type="checkbox" class="rag-doc-cb" value="${escapeHtml(d.doc_id)}" checked
                        onchange="updateRagMeta()">
                    ${escapeHtml(d.doc_id)} <span style="color:#aaa;font-size:0.75rem;">(${d.chunk_count}块)</span>
                </label>
            `).join('');
            updateRagMeta();
        }

        async function ragDeleteDoc(docId) {
            if (!confirm(`确认删除文档「${docId}」？此操作不可撤销。`)) return;
            try {
                const resp = await fetch(`/api/rag/docs/${encodeURIComponent(docId)}`, { method: 'DELETE' });
                const data = await resp.json();
                if (data.success) {
                    await loadRagDocs();
                } else {
                    alert('删除失败：' + (data.error || '未知错误'));
                }
            } catch (e) {
                alert('删除出错：' + e.message);
            }
        }

        // ── 文件上传 ──────────────────────────────────────────────────────────────

        async function ragUploadFiles(files) {
            if (!files || files.length === 0) return;
            const docType = document.querySelector('input[name="rag-doc-type"]:checked')?.value || 'auto';

            for (const file of files) {
                const statusEl = addRagUploadStatus(file.name, 'uploading');
                const fd = new FormData();
                fd.append('file', file);
                fd.append('doc_type', docType);
                try {
                    const resp = await fetch('/api/rag/ingest', { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok || data.error) {
                        updateRagUploadStatus(statusEl, 'error', data.error || '上传失败');
                    } else if (data.async) {
                        updateRagUploadStatus(statusEl, 'processing', 'OCR 处理中...');
                        pollRagTask(data.task_id, statusEl, file.name);
                    } else {
                        updateRagUploadStatus(statusEl, 'done', `完成，${data.chunk_count} 块`);
                        await loadRagDocs();
                    }
                } catch (e) {
                    updateRagUploadStatus(statusEl, 'error', e.message);
                }
            }
            // Reset file input
            document.getElementById('rag-file-input').value = '';
        }

        function addRagUploadStatus(filename, status) {
            const container = document.getElementById('rag-doc-list');
            const div = document.createElement('div');
            div.style.cssText = 'padding:6px 4px;border-bottom:1px solid #f0f0f0;font-size:0.82rem;';
            div.innerHTML = `<div style="display:flex;align-items:center;gap:6px;">
                <i class="fas fa-spinner fa-spin" style="color:#3498db;"></i>
                <span>${escapeHtml(filename)}</span>
                <span class="rag-upload-msg" style="color:#888;font-size:0.75rem;">上传中...</span>
            </div>`;
            container.insertBefore(div, container.firstChild);
            return div;
        }

        function updateRagUploadStatus(el, status, msg) {
            const icons = { done: 'fa-check-circle', error: 'fa-times-circle', processing: 'fa-spinner fa-spin' };
            const colors = { done: '#27ae60', error: '#e74c3c', processing: '#f39c12' };
            const icon = el.querySelector('i');
            const msgEl = el.querySelector('.rag-upload-msg');
            if (icon) {
                icon.className = `fas ${icons[status] || 'fa-spinner'} `;
                icon.style.color = colors[status] || '#888';
            }
            if (msgEl) msgEl.textContent = msg;
        }

        async function pollRagTask(taskId, statusEl, filename) {
            const poll = async () => {
                try {
                    const resp = await fetch(`/api/rag/tasks/${taskId}`);
                    const task = await resp.json();
                    if (task.status === 'done') {
                        updateRagUploadStatus(statusEl, 'done', task.message);
                        await loadRagDocs();
                    } else if (task.status === 'error') {
                        updateRagUploadStatus(statusEl, 'error', task.message);
                    } else {
                        updateRagUploadStatus(statusEl, 'processing', task.message);
                        setTimeout(poll, 3000);
                    }
                } catch (e) {
                    setTimeout(poll, 5000);
                }
            };
            setTimeout(poll, 2000);
        }

        // ── 章节/知识点筛选 ───────────────────────────────────────────────────────

        async function updateRagMeta() {
            // DS 模式：从知识图谱数据库加载，而非向量库
            if (_aiMode === 'deepseek') {
                return await dsUpdateMeta();
            }

            const checked = [...document.querySelectorAll('.rag-doc-cb:checked')].map(cb => cb.value);
            if (checked.length === 0) {
                _ragAllChapters = [];
                _ragAllSections = [];
                renderRagChapterList([]);
                renderRagSectionList([]);
                return;
            }

            const allChapters = new Map();
            const allSections = new Map();

            for (const docId of checked) {
                try {
                    const resp = await fetch(`/api/rag/docs/${encodeURIComponent(docId)}/meta`);
                    if (!resp.ok) continue;
                    const meta = await resp.json();
                    for (const ch of (meta.chapters || [])) {
                        allChapters.set(ch.name, ch);
                    }
                    for (const sec of (meta.sections || [])) {
                        allSections.set(sec.name, sec);
                    }
                } catch (e) { /* ignore */ }
            }

            _ragAllChapters = [...allChapters.values()];
            _ragAllSections = [...allSections.values()];
            filterRagChapters();
            filterRagSections();
        }

        function filterRagChapters() {
            const q = (document.getElementById('rag-chapter-search')?.value || '').toLowerCase();
            const filtered = q ? _ragAllChapters.filter(c => c.name.toLowerCase().includes(q)) : _ragAllChapters;
            renderRagChapterList(filtered);
        }

        function filterRagSections() {
            const q = (document.getElementById('rag-section-search')?.value || '').toLowerCase();
            // 已勾选的章节列表（有勾选则联动过滤）
            const checkedChapters = [...document.querySelectorAll('.rag-chapter-cb:checked')].map(cb => cb.value);
            let filtered = _ragAllSections;
            // 若有章节被勾选，且章节总数 > 0，则只展示属于已勾选章节的知识点
            if (checkedChapters.length > 0 && _ragAllChapters.length > 0) {
                filtered = filtered.filter(s => checkedChapters.includes(s.chapter_name));
            }
            if (q) {
                filtered = filtered.filter(s => (s.display_name || s.name).toLowerCase().includes(q));
            }
            renderRagSectionList(filtered);
        }

        function renderRagChapterList(items) {
            const el = document.getElementById('rag-chapter-list');
            if (!items || items.length === 0) {
                el.innerHTML = '<span style="color:#bbb;">' + (_ragAllChapters.length === 0 ? '选择文档后加载章节' : '无匹配结果') + '</span>';
                return;
            }
            el.innerHTML = items.map(c => `
                <label style="display:flex;align-items:flex-start;gap:6px;padding:2px 0;cursor:pointer;">
                    <input type="checkbox" class="rag-chapter-cb" value="${escapeHtml(c.name)}" style="margin-top:2px;"
                        onchange="filterRagSections()">
                    <span style="font-size:0.82rem;">${escapeHtml(c.name)}</span>
                </label>
            `).join('');
        }

        function renderRagSectionList(items) {
            const el = document.getElementById('rag-section-list');
            if (!items || items.length === 0) {
                el.innerHTML = '<span style="color:#bbb;">' + (_ragAllSections.length === 0 ? '选择文档后加载' : '无匹配结果') + '</span>';
                return;
            }
            el.innerHTML = items.map(s => `
                <label style="display:flex;align-items:flex-start;gap:6px;padding:2px 0;cursor:pointer;">
                    <input type="checkbox" class="rag-section-cb" value="${escapeHtml(s.name)}" style="margin-top:2px;">
                    <span style="font-size:0.82rem;" title="${escapeHtml(s.display_name || s.name)}">${escapeHtml(s.display_name || s.name)}</span>
                </label>
            `).join('');
        }

        // ── 提示词模式切换 ────────────────────────────────────────────────────────

        function setRagPromptMode(mode) {
            _ragCurrentMode = mode;
            const rawPrompts = { zh: RAG_PROMPT_ZH, bilingual: RAG_PROMPT_BILINGUAL, en: RAG_PROMPT_EN };
            let prompt = rawPrompts[mode] || RAG_PROMPT_ZH;
            // 注入动态题型格式示例
            prompt = prompt.replace('{format_examples}', buildFormatExamples(mode));
            // DS 模式使用适配后的提示词（修改前言描述，出题格式不变）
            if (_aiMode === 'deepseek') {
                prompt = _adaptPromptForDs(prompt);
            }
            const editor = document.getElementById('rag-prompt-editor');
            if (editor) editor.value = prompt;

            // Sync language radio buttons
            const radio = document.querySelector(`input[name="rag-lang"][value="${mode}"]`);
            if (radio) radio.checked = true;

            // Highlight active button
            ['zh', 'bilingual', 'en'].forEach(m => {
                const btn = document.getElementById(`rag-lang-btn-${m}`);
                if (btn) {
                    btn.style.background = (m === mode) ? 'var(--secondary-color)' : '';
                    btn.style.color = (m === mode) ? 'white' : '';
                }
            });
        }

        // ── 题型元数据 ────────────────────────────────────────────────────────────

        const RAG_TYPE_META = {
            '单选':          { label: '单选题',     desc: '每题4个选项，只有1个正确答案' },
            '多选':          { label: '多选题',     desc: '每题4个选项，有2～4个正确答案' },
            '是非':          { label: '是非题',     desc: '判断正误，答案为"正确"或"错误"' },
            '简答':          { label: '简答题',     desc: '需提供参考答案' },
            '简答>计算':     { label: '计算题',     desc: '格式：[简答>计算]，需提供计算步骤和答案' },
            '简答>论述':     { label: '论述题',     desc: '格式：[简答>论述]，需提供较详细参考答案' },
            '简答>材料分析': { label: '材料分析题', desc: '格式：[简答>材料分析]，结合实际案例分析' },
        };

        // ── 各模式下各题型格式示例 ────────────────────────────────────────────────

        const RAG_FORMAT_EXAMPLES = {
            zh: {
                '单选': `---
单选题格式：
[单选][正确选项字母]
题目内容？
[A]选项A内容
[B]选项B内容
[C]选项C内容
[D]选项D内容
<解析>
解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>
`,
                '多选': `---
多选题格式：
[多选][正确选项字母组合]
题目内容？
[A]选项A内容
[B]选项B内容
[C]选项C内容
[D]选项D内容
<解析>
解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>
`,
                '是非': `---
是非题格式：
[是非][正确|错误]
题目陈述句。
<解析>
解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>
`,
                '简答': `---
简答题格式：
[简答]
题目内容？
<参考答案>
参考答案内容（要点1；要点2；要点3……）
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>
`,
                '简答>计算': `---
计算题格式：
[简答>计算]
题目内容（含已知条件）？
<参考答案>
解题步骤与计算结果
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:easy|medium|hard
</解析>
`,
                '简答>论述': `---
论述题格式：
[简答>论述]
题目内容？
<参考答案>
详细参考答案，分点论述，逻辑清晰。
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:hard
</解析>
`,
                '简答>材料分析': `---
材料分析题格式：
[简答>材料分析]
【材料】
材料内容（一段与课程相关的实际案例、数据或文字材料）

【问题】
基于以上材料，请分析……？
<参考答案>
参考答案（结合材料和理论进行分析）
</参考答案>
<解析>
解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
难度:hard
</解析>
`,
            },
            bilingual: {
                '单选': `---
双语单选题格式：
[单选][正确选项字母]
中文题目内容？
[A]中文选项A
[B]中文选项B
[C]中文选项C
[D]中文选项D
[A_en]English option A
[B_en]English option B
[C_en]English option C
[D_en]English option D
<解析>
中文解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>
`,
                '多选': `---
双语多选题格式：
[多选][正确选项字母组合]
中文题目内容？
[A]中文选项A
[B]中文选项B
[C]中文选项C
[D]中文选项D
[A_en]English option A
[B_en]English option B
[C_en]English option C
[D_en]English option D
<解析>
中文解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>
`,
                '是非': `---
双语是非题格式：
[是非][正确|错误]
中文题目陈述句。
<解析>
中文解析说明
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the statement.
难度:easy|medium|hard
</解析>
`,
                '简答': `---
双语简答题格式：
[简答]
中文题目内容？
<参考答案>
中文参考答案（要点1；要点2；要点3……）
</参考答案>
<解析>
中文解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>
`,
                '简答>计算': `---
双语计算题格式：
[简答>计算]
中文题目（含已知条件）？
<参考答案>
中文解题步骤与计算结果
</参考答案>
<解析>
中文解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:easy|medium|hard
</解析>
`,
                '简答>论述': `---
双语论述题格式：
[简答>论述]
中文题目内容？
<参考答案>
中文参考答案，分点论述，逻辑清晰。
</参考答案>
<解析>
中文解析说明（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:English version of the question?
难度:hard
</解析>
`,
                '简答>材料分析': `---
双语材料分析题格式：
[简答>材料分析]
【材料】
材料内容（中文）

【问题】
中文问题？
<参考答案>
中文参考答案
</参考答案>
<解析>
中文解析（可选）
知识点:对应的章节或知识点名称
标签:标签1,标签2
英文题目:【Material】English material content. 【Question】English question?
难度:hard
</解析>
`,
            },
            en: {
                '单选': `---
Single-choice format:
[单选][Correct letter]
Question content in English?
[A]Option A
[B]Option B
[C]Option C
[D]Option D
[A_en]Option A
[B_en]Option B
[C_en]Option C
[D_en]Option D
<解析>
Explanation in English.
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question content in English?
难度:easy|medium|hard
</解析>
`,
                '多选': `---
Multiple-choice format:
[多选][Correct letters]
Question content in English?
[A]Option A
[B]Option B
[C]Option C
[D]Option D
[A_en]Option A
[B_en]Option B
[C_en]Option C
[D_en]Option D
<解析>
Explanation in English.
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question content in English?
难度:easy|medium|hard
</解析>
`,
                '是非': `---
True/False format:
[是非][正确|错误]
Statement in English.
<解析>
Explanation in English.
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Statement in English.
难度:easy|medium|hard
</解析>
`,
                '简答': `---
Short answer format:
[简答]
Question in English?
<参考答案>
Reference answer in English (point 1; point 2; point 3...)
</参考答案>
<解析>
Explanation (optional).
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question in English?
难度:easy|medium|hard
</解析>
`,
                '简答>计算': `---
Calculation format:
[简答>计算]
Question in English (with known conditions)?
<参考答案>
Solution steps and final answer in English.
</参考答案>
<解析>
Explanation (optional).
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question in English?
难度:easy|medium|hard
</解析>
`,
                '简答>论述': `---
Essay format:
[简答>论述]
Question in English?
<参考答案>
Detailed reference answer in English, logically structured.
</参考答案>
<解析>
知识点:Knowledge point name
标签:tag1,tag2
英文题目:Question in English?
难度:hard
</解析>
`,
                '简答>材料分析': `---
Case analysis format:
[简答>材料分析]
[Case]
Case material content in English.

[Question]
Based on the above case, analyze...?
<参考答案>
Reference answer integrating theory and case.
</参考答案>
<解析>
知识点:Knowledge point name
标签:tag1,tag2
英文题目:[Case] Case material. [Question] Question in English?
难度:hard
</解析>
`,
            },
        };

        // ── 动态题型表格 ──────────────────────────────────────────────────────────

        let _ragTypeRowId = 0;

        function initRagTypeTable() {
            if (document.querySelectorAll('#rag-type-rows tr').length > 0) return;
            const defaults = [
                ['单选', 10], ['多选', 5], ['是非', 8],
                ['简答', 3], ['简答>论述', 2], ['简答>材料分析', 1]
            ];
            defaults.forEach(([type, count]) => addRagTypeRow(type, count));
        }

        function addRagTypeRow(typeName = '', count = 5) {
            const tbody = document.getElementById('rag-type-rows');
            if (!tbody) return;
            const tr = document.createElement('tr');
            const opts = questionTypesCache.map(qt =>
                `<option value="${qt.name}" ${qt.name === typeName ? 'selected' : ''}>${qt.label || qt.name}</option>`
            ).join('');
            tr.innerHTML = `
                <td style="padding:4px 8px; border:1px solid #ddd;">
                    <select class="rag-type-select" onchange="setRagPromptMode(_ragCurrentMode)"
                            style="width:100%; border:1px solid #ccc; border-radius:4px; padding:3px 4px; font-size:0.88rem;">
                        ${opts}
                    </select>
                </td>
                <td style="border:1px solid #ddd; text-align:center;">
                    <input type="number" class="rag-type-count" value="${count}" min="0" max="99"
                           style="width:60px; text-align:center; padding:3px 4px; border:1px solid #ccc; border-radius:4px;"
                           onchange="setRagPromptMode(_ragCurrentMode)">
                </td>
                <td style="border:1px solid #ddd; text-align:center; width:50px;">
                    <button class="btn btn-danger btn-sm" onclick="removeRagTypeRow(this)" title="删除">
                        <i class="fas fa-times"></i>
                    </button>
                </td>`;
            tbody.appendChild(tr);
            setRagPromptMode(_ragCurrentMode);
        }

        function removeRagTypeRow(btn) {
            btn.closest('tr').remove();
            setRagPromptMode(_ragCurrentMode);
        }

        // ── 按当前选题生成格式示例区段 ────────────────────────────────────────────

        function buildFormatExamples(mode) {
            const rows = document.querySelectorAll('#rag-type-rows tr');
            const selectedTypes = [...rows].map(tr =>
                tr.querySelector('.rag-type-select')?.value
            ).filter(Boolean);
            const examples = RAG_FORMAT_EXAMPLES[mode] || RAG_FORMAT_EXAMPLES.zh;
            const parts = selectedTypes
                .filter(t => examples[t])
                .map(t => examples[t]);
            return parts.join('\n') + '\n---\n';
        }

        // ── 构建题型列表文本 ──────────────────────────────────────────────────────

        function buildQuestionList() {
            const rows = document.querySelectorAll('#rag-type-rows tr');
            const lines = [];
            rows.forEach(tr => {
                const typeName = tr.querySelector('.rag-type-select')?.value;
                const count = parseInt(tr.querySelector('.rag-type-count')?.value || '0', 10);
                if (!typeName || count <= 0) return;
                const meta = RAG_TYPE_META[typeName];
                const label = meta ? meta.label : `${typeName}题`;
                const desc  = meta ? meta.desc  : `格式：[${typeName}]`;
                lines.push(`- ${label}：${count}题（${desc}）`);
            });
            return lines.join('\n');
        }

        // ── 一键出题 ─────────────────────────────────────────────────────────────

        async function ragGenerate() {
            // DS 直出模式：使用知识图谱出题
            if (_aiMode === 'deepseek') {
                return await dsGenerate();
            }

            const btn = document.getElementById('rag-generate-btn');
            const infoEl = document.getElementById('rag-generate-info');
            const resultEl = document.getElementById('rag-result');

            const promptTemplate = document.getElementById('rag-prompt-editor')?.value || '';
            if (!promptTemplate.trim()) {
                alert('提示词模板为空，请先选择语言模式或手动填写提示词。');
                return;
            }

            const questionList = buildQuestionList();
            if (!questionList) {
                alert('请至少为一种题型设置数量（大于0）。');
                return;
            }

            // Collect params
            const docIds = [...document.querySelectorAll('.rag-doc-cb:checked')].map(cb => cb.value);
            const chapters = [...document.querySelectorAll('.rag-chapter-cb:checked')].map(cb => cb.value);
            const knowledgePoints = [...document.querySelectorAll('.rag-section-cb:checked')].map(cb => cb.value);

            // UI: loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 出题中...';
            if (infoEl) infoEl.textContent = 'AI 正在检索知识库并生成题目，可能需要 30～120 秒...';
            if (resultEl) resultEl.value = '';

            try {
                const resp = await fetch('/api/rag/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doc_ids: docIds,
                        chapters,
                        knowledge_points: knowledgePoints,
                        prompt: promptTemplate,
                        question_list: questionList,
                    }),
                });
                const data = await resp.json();

                if (!resp.ok || data.error) {
                    alert('出题失败：' + (data.error || '未知错误'));
                    if (infoEl) infoEl.textContent = '';
                } else {
                    if (resultEl) resultEl.value = data.content || '';
                    if (infoEl) {
                        const stats = data.stats || {};
                        infoEl.textContent = `生成完成！检索到 ${stats.chunks_used || 0} 个文本块（${stats.context_chars || 0} 字）作为参考上下文。`;
                    }
                }
            } catch (e) {
                alert('请求出错：' + e.message);
                if (infoEl) infoEl.textContent = '';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> 一键出题';
            }
        }

        // ── 复制结果 ──────────────────────────────────────────────────────────────

        function ragCopyResult() {
            const el = document.getElementById('rag-result');
            if (!el || !el.value) { alert('结果区为空，请先生成题目。'); return; }
            navigator.clipboard.writeText(el.value).then(() => {
                const statusEl = document.getElementById('rag-import-status');
                if (statusEl) { statusEl.textContent = '已复制到剪贴板！'; setTimeout(() => { statusEl.textContent = ''; }, 3000); }
            }).catch(() => {
                el.select();
                document.execCommand('copy');
            });
        }

        // ── 导入题库 ──────────────────────────────────────────────────────────────

        async function ragImportToBank() {
            const el = document.getElementById('rag-result');
            const statusEl = document.getElementById('rag-import-status');
            if (!el || !el.value.trim()) { alert('结果区为空，请先生成题目。'); return; }

            // 获取当前课程设置作为默认科目名
            let defaultSubject = '';
            try {
                const csResp = await fetch('/api/course-settings');
                if (csResp.ok) {
                    const cs = await csResp.json();
                    defaultSubject = cs.course_name || '';
                }
            } catch (_) {}

            // 弹窗让用户确认或修改科目
            const subject = prompt(
                '请确认导入到哪个科目的题库：\n（科目名称将存入每道题的"科目"字段，便于分类管理）',
                defaultSubject
            );
            if (subject === null) return; // 用户点击了取消

            const blob = new Blob([el.value], { type: 'text/plain;charset=utf-8' });
            const file = new File([blob], 'ai_generated_questions.txt', { type: 'text/plain' });
            const fd = new FormData();
            fd.append('file', file);
            if (subject.trim()) {
                fd.append('subject', subject.trim());
            }

            if (statusEl) statusEl.textContent = '导入中...';
            try {
                const resp = await fetch('/api/questions/import', { method: 'POST', body: fd });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    if (statusEl) statusEl.textContent = '导入失败：' + (data.error || '');
                    alert('导入失败：' + (data.error || '未知错误'));
                } else {
                    const subjectLabel = subject.trim() ? `「${subject.trim()}」` : '（未指定科目）';
                    const msg = `已导入到 ${subjectLabel} 题库！\n新增 ${data.imported || 0} 题，跳过 ${data.skipped || 0} 题，失败 ${data.failed || 0} 题。`;
                    if (statusEl) statusEl.textContent = msg.replace('\n', ' ');
                    alert(msg + '\n\n切换到「题库管理」标签页查看导入结果。');
                }
            } catch (e) {
                if (statusEl) statusEl.textContent = '导入出错：' + e.message;
                alert('导入出错：' + e.message);
            }
        }
    </script>

    <!-- ═══════════════════════════════════════════════════════════
         DS 知识图谱 Modal
    ════════════════════════════════════════════════════════════════ -->
    <div id="ds-kg-modal" style="display:none;position:fixed;inset:0;z-index:9500;
         background:rgba(0,0,0,0.72);align-items:center;justify-content:center;">
        <div style="background:#fff;width:95vw;height:92vh;border-radius:12px;
                    display:flex;flex-direction:column;overflow:hidden;
                    box-shadow:0 12px 48px rgba(0,0,0,0.45);">
            <!-- 标题栏 -->
            <div style="display:flex;align-items:center;justify-content:space-between;
                        padding:11px 18px;background:linear-gradient(135deg,#6c3483,#2980b9);color:#fff;flex-shrink:0;">
                <div style="display:flex;align-items:center;gap:8px;font-size:0.9rem;font-weight:600;">
                    <i class="fas fa-project-diagram"></i>
                    <span>DS 知识图谱</span>
                    <span id="ds-kg-subtitle" style="font-size:0.76rem;opacity:0.8;font-weight:400;"></span>
                </div>
                <button onclick="closeDsKgModal()"
                    style="background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.35);
                           color:#fff;cursor:pointer;padding:4px 12px;border-radius:6px;font-size:0.82rem;">
                    ✕ 关闭
                </button>
            </div>
            <!-- 图例栏 -->
            <div id="ds-kg-legend"
                 style="padding:7px 16px;border-bottom:1px solid #eee;display:flex;
                        flex-wrap:wrap;gap:6px;align-items:center;background:#fafafa;
                        font-size:0.75rem;color:#555;flex-shrink:0;min-height:34px;"></div>
            <!-- 主体：左侧筛选面板 + 右侧画布 -->
            <div style="flex:1;display:flex;overflow:hidden;">
                <!-- 左侧筛选面板 -->
                <div style="width:195px;flex-shrink:0;border-right:1px solid #eee;
                            background:#fff;overflow-y:auto;padding:10px 11px;
                            display:flex;flex-direction:column;gap:0;">
                    <!-- 章节筛选 -->
                    <div style="font-size:0.76rem;font-weight:600;color:#6c3483;
                                margin-bottom:5px;display:flex;align-items:center;justify-content:space-between;">
                        <span><i class="fas fa-layer-group" style="margin-right:3px;font-size:0.7rem;"></i>章节筛选</span>
                        <div style="display:flex;gap:3px;">
                            <button onclick="_dsKgSelectAllChapters(true)"
                                style="padding:1px 6px;font-size:0.68rem;border:1px solid #c39;color:#c39;
                                       background:none;border-radius:3px;cursor:pointer;"
                                onmouseover="this.style.background='#f9f'" onmouseout="this.style.background='none'">全选</button>
                            <button onclick="_dsKgSelectAllChapters(false)"
                                style="padding:1px 6px;font-size:0.68rem;border:1px solid #bbb;color:#888;
                                       background:none;border-radius:3px;cursor:pointer;"
                                onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">全不选</button>
                        </div>
                    </div>
                    <div id="ds-kg-chapter-checks" style="margin-bottom:12px;"></div>

                    <!-- 知识点搜索 -->
                    <div style="font-size:0.76rem;font-weight:600;color:#2980b9;margin-bottom:5px;">
                        <i class="fas fa-search" style="margin-right:3px;font-size:0.7rem;"></i>知识点搜索
                    </div>
                    <input id="ds-kg-kp-search" type="text" placeholder="输入名称或内容关键词…"
                        oninput="_applyDsKgFilter()"
                        style="width:100%;box-sizing:border-box;padding:5px 8px;border:1px solid #ddd;
                               border-radius:5px;font-size:0.78rem;margin-bottom:12px;outline:none;"
                        onfocus="this.style.borderColor='#2980b9'" onblur="this.style.borderColor='#ddd'">

                    <!-- 关系类型筛选 -->
                    <div style="font-size:0.76rem;font-weight:600;color:#555;margin-bottom:5px;">
                        <i class="fas fa-link" style="margin-right:3px;font-size:0.7rem;"></i>关系类型
                    </div>
                    <div id="ds-kg-rel-checks" style="margin-bottom:12px;"></div>

                    <!-- 统计 + 重置 -->
                    <div id="ds-kg-filter-stats"
                         style="font-size:0.72rem;color:#aaa;margin-bottom:8px;text-align:center;"></div>
                    <button onclick="_resetDsKgFilter()"
                        style="width:100%;padding:5px 0;font-size:0.78rem;border:1px solid #ddd;
                               border-radius:5px;background:#f8f8f8;cursor:pointer;color:#666;margin-top:auto;"
                        onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f8f8f8'">
                        <i class="fas fa-undo" style="font-size:0.7rem;margin-right:3px;"></i>重置筛选
                    </button>
                </div>
                <!-- 右侧图谱画布 -->
                <div id="ds-kg-container"
                     style="flex:1;position:relative;overflow:hidden;background:#f4f6fb;"></div>
            </div>
            <!-- 底部提示 -->
            <div style="padding:5px 16px;font-size:0.7rem;color:#bbb;border-top:1px solid #f0f0f0;
                        background:#fafafa;flex-shrink:0;">
                悬停节点查看知识点详情 &nbsp;·&nbsp; 滚轮缩放 &nbsp;·&nbsp; 拖拽平移 &nbsp;·&nbsp; 拖动节点调整布局
            </div>
        </div>
    </div>
    <!-- 知识点悬浮详情卡 -->
    <div id="ds-kg-tooltip"
         style="display:none;position:fixed;z-index:9999;background:#fff;
                border:1px solid #dde;border-radius:8px;padding:10px 14px;
                max-width:300px;box-shadow:0 4px 20px rgba(0,0,0,0.14);
                font-size:0.79rem;pointer-events:none;line-height:1.5;"></div>

</body>
</html>
